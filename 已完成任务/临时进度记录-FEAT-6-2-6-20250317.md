# FEAT-6-2-6 通道速度 - 临时进度记录

## ⏱️ 时间
- 2025-03-17

## ✅ 已完成
- **数据层**：
  - `sql/modules/channels.sql` 新增 `channel_speed_statistics` 表（速率、计数、元数据、唯一约束、索引）。
  - `sql/init_mock_data.sql` 添加入场权限 `channel_speed_view` 及示例速率数据（秒/分钟级）。
- **模型层**：`app/models/customers/channel.py` 新增 `ChannelSpeedStatistic` ORM 并在 `app/models/customers/__init__.py` 中导出。
- **服务层**：`ChannelService` 新增 `get_channel_speed_statistics`、`_has_speed_view_permission`、`_parse_time_parameter`，支持权限校验、时间窗口、单位计算。
- **API 层**：
  - schema：`ChannelSpeedQuerySchema`、`ChannelSpeedResponseSchema` 等。
  - 路由：`GET /api/v1/channels/<channel_id>/speed` 返回权限友好响应。
- **前端**：
  - `channelApi` 增加类型 `ChannelSpeedResponse`、查询参数、hook（含 lazy 查询）。
  - 新增 `ChannelSpeedModal`，支持粒度切换、时间窗口移动、刷新、空态/无权限展示。
  - `ChannelActionButtons`/`ChannelTable`/`ChannelListPage` 接入“通道速度”入口；`components/index.ts` 导出。

## ⚠️ 待解决问题
- `npm run type-check` 失败：
  - 本次改动相关：`ChannelSpeedModal` 需改为 type-only import；`channelApi.ts` 有未使用变量。
  - 历史遗留：大量黑白名单、角色模块类型错误/未导出定义，与本次任务无直接关系。
- `pytest` 失败：
  - SQLite 不支持 ARRAY 字段，初始化黑白名单表时报错。
  - 多处测试依赖尚未在测试环境创建的表 (`short_messages`, `delivers` 等)。
  - Auth decorator/service 测试断言与现有返回结构不符，为既有行为。

## 📌 下一步建议
1. 先处理与本任务直接相关的 TypeScript 报错（type-only import、未使用变量）。
2. 评估测试策略：
   - 测试环境替换 ARRAY (`tags`) 字段，或在测试中跳过相关表。
   - 或在可行情况下使用 PostgreSQL 容器跑测试。
3. 手动验证 `/api/v1/channels/<id>/speed` 接口和前端弹窗交互，确保功能闭环。

## 📂 关键文件
- `sql/modules/channels.sql`
- `sql/init_mock_data.sql`
- `app/models/customers/channel.py`
- `app/models/customers/__init__.py`
- `app/services/channels/channel_service.py`
- `app/api/v1/channels/route/channel_speed.py`
- `app/api/v1/channels/schema/channel.py`
- `src/api/channelApi.ts`
- `src/pages/ChannelManagement/components/ChannelSpeedModal.tsx`
- `src/pages/ChannelManagement/ChannelListPage.tsx`
- `src/pages/ChannelManagement/components/ChannelActionButtons.tsx`
- `src/pages/ChannelManagement/components/ChannelTable.tsx`
- `src/pages/ChannelManagement/components/index.ts`

