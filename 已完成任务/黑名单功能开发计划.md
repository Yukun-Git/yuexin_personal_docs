# 黑名单功能开发详细计划（精简版）

## 📊 项目概况

**开发模块**: 黑名单管理体系（核心功能）  
**功能范围**: 黑名单库管理（核心功能）  
**开发周期**: 3个工作日  
**预估工时**: 24小时  
**技术架构**: 复用现有企业管理和账号管理架构模式

## 🎯 需求分析总结

### 核心功能范围（聚焦开发）
- ✅ **黑名单库管理**: 手机号、关键词、IP、域名黑名单CRUD
- ✅ **批量管理**: 导入导出、批量操作
- ✅ **拦截监控**: 拦截效果统计和分析
- ✅ **内容过滤**: 实时内容检测和匹配

### 暂不包含功能（后续迭代）
- ⏸️ **三方黑名单服务**: 外部黑名单数据源接入（需求变动，暂不开发）
- ⏸️ **白名单管理**: 后续Phase 2开发
- ⏸️ **敏感词库管理**: 后续Phase 2开发

## 🗓️ 分阶段开发计划

### 第一阶段：黑名单核心功能（2天 / 16小时）

#### 任务1.1: 黑名单数据模型设计（4小时）

**后端模型开发**:
```python
# 新增模型文件
pigeon_web/app/models/blacklist/
├── __init__.py
├── blacklist.py          # 黑名单主模型
├── blacklist_type.py     # 黑名单类型管理
├── blacklist_source.py   # 黑名单来源管理
└── intercept_log.py      # 拦截日志记录
```

**核心模型设计**:
- **BlacklistEntry**: 黑名单条目（手机号/关键词/IP/域名）
- **BlacklistType**: 类型管理（PHONE/KEYWORD/IP/DOMAIN/CUSTOM）
- **BlacklistSource**: 来源管理（MANUAL/SYSTEM/COMPLAINT/THIRD_PARTY）
- **InterceptLog**: 拦截记录（统计分析用）

**字段设计重点**:
- 内容字段支持多种类型（手机号、关键词、正则表达式）
- 生效时间管理（start_time, end_time）
- 严重等级管理
- 关联企业账号（支持客户专属黑名单）

#### 任务1.2: 黑名单Service层开发（6小时）

**服务层文件结构**:
```python
pigeon_web/app/services/blacklist/
├── __init__.py
├── blacklist_service.py      # 黑名单业务逻辑
├── content_filter_service.py # 内容过滤服务
└── statistics_service.py     # 统计分析服务
```

**核心功能实现**:
1. **BlacklistService**:
   - 多维度查询和筛选（类型、来源、状态、时间范围）
   - 批量导入导出（Excel/CSV支持）
   - 号码格式验证（国际号码）
   - 正则表达式验证和测试

2. **ContentFilterService**:
   - 实时内容检测接口
   - 多种检测策略（精确匹配、模糊匹配、正则匹配）
   - 检测结果缓存优化

#### 任务1.3: RESTful API端点实现（6小时）

**API路由结构**:
```python
pigeon_web/app/api/v1/blacklist/
├── route/
│   ├── __init__.py
│   ├── blacklist.py          # 黑名单CRUD API
│   ├── content_filter.py     # 内容过滤API
│   ├── batch_operations.py   # 批量操作API
│   └── statistics.py         # 统计分析API
└── schema/
    ├── blacklist_schema.py   # 数据验证Schema
    └── filter_schema.py
```

**核心API端点**:
- `GET /api/v1/blacklist/` - 黑名单列表（分页、筛选、搜索）
- `POST /api/v1/blacklist/` - 创建黑名单条目
- `PUT /api/v1/blacklist/:id` - 更新黑名单条目
- `DELETE /api/v1/blacklist/:id` - 删除黑名单条目
- `POST /api/v1/blacklist/batch-import` - 批量导入
- `POST /api/v1/blacklist/content-check` - 内容检测
- `GET /api/v1/blacklist/statistics` - 拦截统计

### 第二阶段：前端界面开发（1天 / 8小时）

#### 任务2.1: 黑名单管理界面（6小时）

**页面组件结构**:
```typescript
frontend/src/pages/BlacklistManagement/
├── Blacklist/
│   ├── index.tsx                 # 黑名单主页面
│   ├── BlacklistTable.tsx        # 黑名单列表表格
│   ├── BlacklistFormModal.tsx    # 创建/编辑弹窗
│   ├── BatchImportModal.tsx      # 批量导入弹窗
│   ├── ContentCheckModal.tsx     # 内容检测弹窗
│   └── StatisticsPanel.tsx       # 统计面板
└── components/
    ├── SearchFilter.tsx          # 搜索筛选组件
    ├── BatchOperations.tsx       # 批量操作组件
    ├── StatusBadge.tsx           # 状态徽章
    └── StatisticsChart.tsx       # 统计图表
```

**核心功能界面**:
- 高级搜索和筛选（类型、来源、状态、时间范围）
- 列表展示和分页
- 批量操作（导入、导出、状态切换）
- 实时内容检测测试界面
- 拦截统计和效果分析

#### 任务2.2: 集成测试和优化（2小时）

**测试内容**:
- 前后端接口联调测试
- 功能完整性验证
- 性能优化调整
- 用户体验优化

## 🔧 技术实现规范

### 数据库设计原则
1. **统一基类**: 继承TimestampMixin
2. **索引优化**: 内容字段、类型字段、状态字段添加索引
3. **分表策略**: 日志表考虑按月分表
4. **字符集**: 使用utf8mb4支持emoji和特殊字符

### API设计规范
1. **RESTful风格**: 遵循REST规范
2. **统一响应**: 使用APIResponse格式
3. **权限控制**: 集成RBAC权限系统
4. **输入验证**: Marshmallow数据验证
5. **性能优化**: 查询优化和缓存策略

### 前端技术规范
1. **组件复用**: 复用现有的Table、Form、Modal组件
2. **状态管理**: RTK Query管理API状态
3. **类型安全**: TypeScript严格模式
4. **用户体验**: Loading状态、错误处理、操作反馈

## 📁 详细文件结构

### 后端新增文件（约15个文件）
```
pigeon_web/app/
├── models/blacklist/              # 数据模型 (4个文件)
│   ├── __init__.py
│   ├── blacklist.py
│   ├── blacklist_type.py
│   └── intercept_log.py
├── services/blacklist/            # 业务服务 (4个文件)
│   ├── __init__.py
│   ├── blacklist_service.py
│   ├── content_filter_service.py
│   └── statistics_service.py
├── api/v1/blacklist/              # API接口 (5个文件)
│   ├── route/
│   │   ├── __init__.py
│   │   ├── blacklist.py
│   │   └── content_filter.py
│   └── schema/
│       ├── __init__.py
│       └── blacklist_schema.py
└── utils/blacklist/               # 工具函数 (4个文件)
    ├── __init__.py
    ├── content_matcher.py
    ├── import_export.py
    └── phone_validator.py
```

### 前端新增文件（约11个文件）
```
frontend/src/
├── api/blacklistApi.ts            # RTK Query API定义
├── store/slices/blacklistSlice.ts # Redux状态管理
├── types/blacklist.ts             # TypeScript类型定义
├── pages/BlacklistManagement/     # 页面组件 (8个文件)
│   ├── Blacklist/                 # 6个组件文件
│   └── components/                # 4个公共组件
└── utils/blacklistUtils.ts       # 工具函数
```

## ⚠️ 风险控制和质量保证

### 性能风险控制
- **检测性能**: 敏感词检测算法优化，响应时间<100ms
- **大数据量**: 分页查询，避免全表扫描
- **缓存策略**: 热点数据Redis缓存
- **数据库优化**: 合理索引，查询优化

### 数据安全控制
- **权限验证**: 严格的RBAC权限控制
- **敏感数据**: 敏感词库加密存储
- **操作审计**: 完整的操作日志记录
- **输入验证**: 防SQL注入和XSS攻击

### 业务风险控制
- **误拦截**: 白名单优先级机制
- **漏拦截**: 多种匹配策略组合
- **规则冲突**: 优先级和权重管理
- **数据一致性**: 批量操作的事务处理

## 📈 验收标准

### 功能验收标准
- [ ] 黑名单CRUD功能完整
- [ ] 批量导入导出功能正常
- [ ] 内容检测准确率>95%
- [ ] 统计分析数据准确
- [ ] 前端界面符合设计规范
- [ ] 企业级权限控制正常

### 性能验收标准
- [ ] 内容检测响应时间<100ms
- [ ] 列表查询响应时间<1s
- [ ] 支持百万级数据快速检索
- [ ] 批量操作性能良好

### 安全验收标准
- [ ] 权限控制严格有效
- [ ] 敏感数据加密保护
- [ ] 操作审计完整
- [ ] 输入验证全面覆盖

## 🚀 开发时间规划

### 第一阶段（前2天）
- **Day 1**: 黑名单数据模型设计 + Service层开发 ✅ 已完成
- **Day 2**: API端点实现和基础功能测试 ✅ 已完成

### 第二阶段（最后1天）
- **Day 3**: 前端界面开发 + 集成测试 + 优化

### 工时分配
- **后端开发**: 16小时 (2天) ✅ 已完成
- **前端开发**: 6小时 (0.75天)
- **集成测试**: 2小时 (0.25天)
- **总计**: 24小时 (3天)

## 💡 后续扩展计划

### Phase 2功能扩展（预计3-4天）
- **白名单管理**: VIP客户优先通道管理
- **敏感词库管理**: 政治、色情、暴力等敏感词检测
- **AI智能检测**: 集成机器学习模型提升检测准确率
- **实时监控**: 实时拦截监控dashboard

### Phase 3集成优化（预计2天）
- **与发送系统集成**: 实时内容过滤
- **与统计系统集成**: 拦截数据统计分析
- **与告警系统集成**: 异常情况实时告警
- **多语言支持**: 支持多种语言的内容检测

---

**文档创建时间**: 2025-01-11  
**文档更新时间**: 2025-01-11（需求变动，移除三方黑名单服务）  
**预计完成时间**: 开始后3个工作日  
**功能范围**: 黑名单库管理（核心功能）  
**负责人**: Claude Code Assistant  
**文档状态**: 已根据需求变动更新  
**开发状态**: 第一阶段100%完成，进入第二阶段（前端开发）