# 任务3: 认证授权系统实现 - 详细子任务分解

## 📊 任务概况
**预估总时间**: 2天 (16小时)  
**目标**: 基于现有数据库表结构，实现完整的JWT认证和RBAC权限管理系统  
**依赖**: 任务1已完成，数据库表结构已存在 (pigeon_web.sql)  

## 🎯 核心目标
1. 构建基于JWT的用户认证系统
2. 实现基于现有数据库的RBAC权限管理
3. 提供统一的认证授权装饰器和中间件
4. 建立完整的用户会话管理机制

## 📋 详细子任务分解

### 子任务3.1: 数据库模型映射 (3小时)
**目标**: 为现有数据库表创建SQLAlchemy模型类

#### 3.1.1 创建基础模型类 (1小时)
**具体工作**:
- [ ] 在 `app/models/` 下创建 `__init__.py` 统一模型导出
- [ ] 创建 `app/models/base.py` 基础模型类
- [ ] 实现公共字段和方法 (created_at, updated_at, to_dict等)
- [ ] 配置数据库连接和会话管理

**产出文件**:
- `app/models/base.py` - 基础模型类
- `app/models/__init__.py` - 模型导出

#### 3.1.2 实现认证相关模型 (2小时)
**具体工作**:
- [ ] 创建 `app/models/auth.py` 认证模型
- [ ] 实现 `AdminUser` 模型 (映射admin_users表)
- [ ] 实现 `Role` 模型 (映射roles表)
- [ ] 实现 `Permission` 模型 (映射permissions表)
- [ ] 实现关联模型 `UserRole`, `RolePermission`
- [ ] 添加密码验证和权限查询方法

**产出文件**:
- `app/models/auth.py` - 完整的认证相关模型

**验证清单**:
- [ ] 所有模型能正确映射到现有数据库表
- [ ] 模型关系正确建立
- [ ] 密码哈希验证功能正常
- [ ] 权限查询方法有效

### 子任务3.2: JWT认证服务 (5小时)
**目标**: 实现完整的JWT认证机制

#### 3.2.1 配置JWT系统 (1小时)
**具体工作**:
- [ ] 在 `config.py` 中添加JWT配置项
- [ ] 配置Flask-JWT-Extended扩展
- [ ] 设置JWT密钥、过期时间等参数
- [ ] 在应用工厂函数中注册JWT扩展

**配置项设计**:
```python
# JWT配置
JWT_SECRET_KEY = 'your-secret-key'
JWT_ACCESS_TOKEN_EXPIRES = timedelta(hours=1)
JWT_REFRESH_TOKEN_EXPIRES = timedelta(days=30)
JWT_BLACKLIST_ENABLED = True
JWT_BLACKLIST_TOKEN_CHECKS = ['access', 'refresh']
```

#### 3.2.2 实现认证服务类 (2小时)
**具体工作**:
- [ ] 创建 `app/services/auth_service.py` 认证服务
- [ ] 实现用户登录验证逻辑
- [ ] 实现Token生成和验证
- [ ] 实现Token刷新机制
- [ ] 实现用户权限加载

**核心方法设计**:
```python
class AuthService:
    @staticmethod
    def login(username, password) -> dict
    
    @staticmethod
    def refresh_token(refresh_token) -> dict
    
    @staticmethod
    def logout(access_token) -> bool
    
    @staticmethod
    def get_current_user(user_id) -> AdminUser
    
    @staticmethod
    def load_user_permissions(user_id) -> list
```

#### 3.2.3 实现认证API视图 (2小时)
**具体工作**:
- [ ] 创建 `app/api/auth/` 目录结构
- [ ] 实现登录接口 `POST /api/auth/login`
- [ ] 实现登出接口 `POST /api/auth/logout`
- [ ] 实现Token刷新接口 `POST /api/auth/refresh`
- [ ] 实现用户信息接口 `GET /api/auth/profile`
- [ ] 添加请求参数验证和响应格式化

**API设计**:
```python
# 登录请求格式
POST /api/auth/login
{
    "username": "admin",
    "password": "password123"
}

# 响应格式
{
    "code": 200,
    "message": "login successful",
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbG...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbG...",
        "user": {
            "id": 1,
            "username": "admin",
            "email": "admin@pigeon.com",
            "full_name": "System Administrator"
        }
    }
}
```

**验证清单**:
- [ ] 用户能成功登录获取Token
- [ ] Token验证机制正常工作
- [ ] Token刷新功能正常
- [ ] 登录/登出状态正确维护

### 子任务3.3: 权限管理系统 (5小时)
**目标**: 实现基于RBAC的权限管理系统

#### 3.3.1 实现权限服务类 (2小时)
**具体工作**:
- [ ] 创建 `app/services/permission_service.py` 权限服务
- [ ] 实现用户权限检查逻辑
- [ ] 实现角色权限查询
- [ ] 实现资源级权限验证
- [ ] 添加权限缓存机制

**核心方法设计**:
```python
class PermissionService:
    @staticmethod
    def user_has_permission(user_id, permission_name) -> bool
    
    @staticmethod
    def get_user_permissions(user_id) -> list
    
    @staticmethod
    def get_user_roles(user_id) -> list
    
    @staticmethod
    def check_resource_access(user_id, resource, action) -> bool
```

#### 3.3.2 实现权限装饰器 (2小时)
**具体工作**:
- [ ] 创建 `app/utils/decorators.py` 装饰器工具
- [ ] 实现 `@login_required` 装饰器
- [ ] 实现 `@require_permission` 装饰器
- [ ] 实现 `@require_roles` 装饰器
- [ ] 添加权限检查失败的错误处理

**装饰器设计**:
```python
@require_permission('customer.read')
def get_customers():
    pass

@require_roles(['admin', 'super_admin'])
def system_config():
    pass
```

#### 3.3.3 实现权限管理API (1小时)
**具体工作**:
- [ ] 创建 `app/api/admin/permissions.py` 权限管理接口
- [ ] 实现权限列表查询 `GET /api/admin/permissions`
- [ ] 实现角色管理接口 `GET/POST/PUT/DELETE /api/admin/roles`
- [ ] 实现用户角色分配接口 `POST /api/admin/users/{id}/roles`
- [ ] 添加权限管理的访问控制

**验证清单**:
- [ ] RBAC权限模型正确实现
- [ ] 权限装饰器工作正常
- [ ] 不同角色权限隔离有效
- [ ] 权限管理接口功能完整

### 子任务3.4: 认证中间件集成 (2小时)
**目标**: 将认证授权系统集成到现有中间件架构

#### 3.4.1 实现认证中间件 (1小时)
**具体工作**:
- [ ] 创建 `app/middleware/auth.py` 认证中间件
- [ ] 实现JWT Token自动验证
- [ ] 实现用户身份注入到请求上下文
- [ ] 集成到现有中间件注册系统

#### 3.4.2 配置路由保护 (1小时)
**具体工作**:
- [ ] 在 `app/middleware/__init__.py` 中注册认证中间件
- [ ] 配置需要认证的路由规则
- [ ] 实现白名单路由 (登录、健康检查等)
- [ ] 更新应用工厂函数

**验证清单**:
- [ ] 认证中间件正确拦截未授权请求
- [ ] 白名单路由正常访问
- [ ] 已认证用户身份正确注入
- [ ] 权限检查在中间件层生效

### 子任务3.5: 测试和文档 (1小时)
**目标**: 确保认证授权系统稳定可靠

#### 3.5.1 功能测试 (0.5小时)
**具体工作**:
- [ ] 测试登录/登出流程
- [ ] 测试Token刷新机制
- [ ] 测试权限装饰器
- [ ] 测试不同角色的权限隔离

#### 3.5.2 集成验证 (0.5小时)
**具体工作**:
- [ ] 验证与现有中间件系统的集成
- [ ] 验证数据库连接和查询性能
- [ ] 检查错误处理和日志记录
- [ ] 确认API响应格式标准化

**最终验证清单**:
- [ ] 所有认证相关API正常工作
- [ ] 权限控制机制有效
- [ ] 与现有系统无缝集成
- [ ] 性能表现符合预期
- [ ] 错误处理完善
- [ ] 日志记录清晰

## 📁 预期产出文件结构

```
app/
├── models/
│   ├── __init__.py          # 模型统一导出
│   ├── base.py              # 基础模型类
│   └── auth.py              # 认证相关模型
├── services/
│   ├── __init__.py
│   ├── auth_service.py      # 认证服务
│   └── permission_service.py # 权限服务
├── api/
│   ├── auth/
│   │   ├── __init__.py
│   │   └── views.py         # 认证API
│   └── admin/
│       ├── __init__.py
│       └── permissions.py   # 权限管理API
├── utils/
│   └── decorators.py        # 权限装饰器
├── middleware/
│   └── auth.py              # 认证中间件
└── config.py                # 更新JWT配置
```

## ⚡ 关键技术要点

### 安全考虑
- [ ] JWT密钥安全管理
- [ ] 密码哈希使用bcrypt
- [ ] Token黑名单机制
- [ ] SQL注入防护
- [ ] 敏感信息不记录日志

### 性能优化
- [ ] 权限查询结果缓存
- [ ] 数据库连接池优化
- [ ] Token验证性能优化
- [ ] 批量权限检查

### 错误处理
- [ ] 统一认证错误响应格式
- [ ] 详细的权限拒绝信息
- [ ] 登录失败次数限制
- [ ] 异常情况日志记录

## 🚀 执行策略
1. **按子任务顺序执行** - 每个子任务完成后立即测试验证
2. **增量集成** - 逐步集成到现有系统，确保不破坏现有功能
3. **实时反馈** - 每个子任务完成后立即演示功能
4. **文档同步** - 重要配置和使用方法及时记录

---
**文档创建时间**: 2025-09-04  
**预计开始时间**: 任务1完成后立即开始  
**负责人**: Claude Code Assistant