# Copyright(c) 2025
# All rights reserved.
#
# Author: yukun.xing <xingyukun@gmail.com>
# Date:   2025/09/10

# 任务3.2 · 企业账号管理体系 — 子任务拆解与执行计划

## 范围与对齐
- 对齐需求：pigeon_requirements/MODU-01、FEAT-1-1 企业账号管理
- 当前实现已覆盖：企业模型/CRUD/筛选分页/详情/认证、前端列表与表单等
- 仍需补齐：批量操作后端、权限细化、财务联动、发送账号绑定、审计日志、管理员维度筛选、统计接口、迁移与测试

## 当前覆盖与差距（摘要）
- 已覆盖
  - 后端：Enterprise 模型、服务、Schema 校验、列表筛选/排序/分页、CRUD、认证
  - 前端：列表/筛选/表单/详情/操作栏、RTK Query API（含批量/统计的占位）
- 差距
  - 缺后端：/enterprises/bulk-update、/enterprises/stats、/financial/*、/accounts/*
  - 权限细化：缺基于资源/动作的权限强制（permission_required）
  - 审计日志：缺操作记录
  - 管理员维度筛选：缺 admin 维度过滤
  - 迁移/测试：缺 Alembic 迁移与单测

## 子任务列表（按优先级与依赖排序）

1) feat(enterprise): 批量更新接口与前端联动
- 目标：实现 POST /api/v1/enterprises/bulk-update，支持批量认证/激活/暂停等
- 后端改动：
  - 新增路由与资源，入参 { ids: string[]; data: { status?: 'active'|'suspended'|'inactive'; is_verified?: boolean } }
  - 权限：enterprise:write（或 enterprise:manage）
  - 事务：分批处理+局部失败计数、返回 updated_count
- 前端改动：ActionToolbar 直接对接该接口（已预留），对失败友好提示
- 验收：批量操作成功回写 UI；局部失败有明确信息
- 预估：后端 3h，前端 0.5h

2) feat(enterprise): 权限细化与装饰器接入
- 目标：对 create/update/delete/verify/bulk 等接口加 @permission_required
- 权限建议：
  - enterprise:read / enterprise:write / enterprise:delete / enterprise:verify / enterprise:manage
- 验收：无权限返回 403，权限矩阵覆盖核心入口
- 预估：2h

3) feat(financial): 财务联动接口（匹配已存在前端 API）
- 目标：实现 /api/v1/financial/{records|balance/:id|recharge|stats|export}
- 后端改动：轻量实现 Balance 与 Recharge（允许用内存/假数据或占位模型），其余接口占位
- 前端：沿用现有 financialApi.ts
- 列表页：后续可在企业列表增加“总余额”列（可选）
- 验收：能获取余额、完成充值、基础统计返回
- 预估：后端 4h，前端 0.5h

4) feat(account): 发送账号绑定/管理最小能力
- 目标：提供与 Enterprise 的基本绑定/解绑、列表查询
- 后端：/api/v1/accounts（最小 CRUD）+ /accounts?enterprise_id= 过滤
- 前端：在企业详情展示关联账号列表（已有字段），后续加入“绑定”入口（可分步）
- 验收：能按企业查看/绑定/解绑账号
- 预估：后端 4h，前端 2h

5) feat(enterprise): 企业统计接口
- 目标：实现 GET /api/v1/enterprises/stats，返回总数/各状态/已认证等聚合
- 前端：enterpriseApi.ts 已定义，直接接入
- 验收：页面能展示统计卡片（或调试输出）
- 预估：后端 1.5h，前端 0.5h

6) feat(audit): 操作审计日志
- 目标：记录企业相关操作日志（create/update/verify/delete/bulk）
- 后端：新增 OperationLog 模型或统一日志服务；在服务层落点
- 验收：关键操作后能查询到对应日志（可先提供简单查询接口）
- 预估：后端 3h

7) feat(enterprise): 管理员维度筛选
- 目标：企业列表支持 admin_id（或管理人）过滤
- 后端：列表查询增加可选过滤参数 & 索引建议
- 前端：SearchFilterSection 增加筛选项（下拉/自动完成，后端可临时返回静态列表）
- 验收：选择管理员后列表正确过滤
- 预估：后端 1.5h，前端 1h

8) chore(db): Alembic 迁移与 Schema 对齐
- 目标：用 Alembic 生成并维护迁移（含 uuid 扩展、枚举 values_callable、索引）
- 验收：本地一键迁移成功；pigeon_web.sql 与迁移一致
- 预估：3h

9) test(enterprise): 最小单元测试与接口冒烟
- 目标：为服务层与关键接口加最小测试用例；pytest 集成
- 验收：pytest 通过；对核心路径（列表/创建/更新/删除/认证/批量）做冒烟
- 预估：3h

10) ux(enterprise): 删除前引导停用 & 失败提示优化
- 目标：将删除前置为“需先停用”，UI 明确引导；后端 409 文案保持清晰
- 前端：删除失败展示后端 message（已优化）；可加一键“改为停用并再删”的流程（可选）
- 验收：用户易理解、不迷路
- 预估：前端 1h

## 依赖与节奏建议
- 第一轮（高优先）：1、2、5、10（解前端现有坑，提升可用性）
- 第二轮：3、4（财务与账号绑定，满足 FEAT-1-1 更完整目标）
- 第三轮：6、7、8、9（运维与质量保障）

## 验收清单（汇总）
- 批量接口/统计接口可用，权限受控
- 列表/表单/详情流畅，无 4xx 配置类错误与 5xx 崩溃
- 财务与账号最小联动打通
- 有基础审计与最小测试，迁移可复现

## 本地验证建议（命令）
```bash
# 后端（请先激活 venv）
cd pigeon_web \
 && source ../venv/bin/activate \
 && pip install -r requirements.txt \
 && python run.py

# 前端
cd pigeon_web/frontend \
 && npm install \
 && npm run dev

# 测试
cd pigeon_web \
 && source ../venv/bin/activate \
 && pytest -q
```

---
以上计划如需增删，请在本文件直接批注，我们按批次推进与汇报。

