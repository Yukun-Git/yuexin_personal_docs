# 通道协议管理功能开发计划

## 📋 项目概述

**功能名称**: FEAT-6-2 通道协议管理  
**优先级**: P0 - 高  
**开发周期**: 预计 5-7 工作日  
**负责人**: Claude Code Assistant  
**文档版本**: 1.0.0  
**创建日期**: 2025-09-16  

## 🎯 功能目标

开发完整的通道协议管理系统，为平台管理员和技术运维提供通道协议的全生命周期管理能力，包括：

- **核心功能**: 通道协议的增删改查操作
- **高级筛选**: 多维度查询和搜索功能
- **实时监控**: 通道状态和检测状态监控
- **批量操作**: 支持批量导出、关闭等操作
- **丰富操作**: 修改、发送短信、通道组管理、参数修改等

## 📊 现有系统架构分析

### 已具备的技术基础 ✅

**数据库层**:
- ✅ `accounts` 表 - 完整的账号管理表结构
- ✅ `channels` 表 - 基础通道表结构（需扩展）
- ✅ 模块化SQL架构 - `pigeon_web/sql/modules/` 组织方式
- ✅ PostgreSQL + UUID主键 + 时间戳mixin模式

**后端API层**:
- ✅ Flask 3.0 + SQLAlchemy 分层架构
- ✅ Account模型和服务层完整实现
- ✅ 标准API路由结构: `/api/v1/{resource}/route/`
- ✅ Marshmallow序列化器架构
- ✅ BaseService基类和服务层模式
- ✅ RBAC权限控制体系

**前端架构**:
- ✅ React 18 + TypeScript + Vite
- ✅ RTK Query + Redux Toolkit状态管理
- ✅ Ant Design 5.x组件库
- ✅ Account管理页面完整实现（参考模板）
- ✅ 标准页面架构: 搜索筛选 + 表格 + 弹窗操作

### 需要扩展的部分 🔧

**数据库Schema扩展**:
- 需要扩展 `channels` 表，增加通道协议管理所需字段
- 新增通道组关系、监控配置、参数配置等关联表
- 参考需求文档的E-R图设计

**后端API开发**:
- 新增Channel模型和服务层
- 开发通道协议CRUD API端点
- 实现高级查询和批量操作功能

**前端界面开发**:
- 参考Account管理页面架构
- 开发通道协议管理完整界面
- 实现UI-UX设计方案中的所有交互功能

## 🚀 分阶段开发计划

### 🔶 **阶段1: 数据库Schema设计与实现** (1天)

#### 任务1.1: 扩展channels表结构
- **目标**: 根据需求文档扩展现有channels表，支持通道协议管理需求
- **输出**: 更新 `pigeon_web/sql/modules/accounts_channels.sql`

**主要字段扩展**:
```sql
-- 状态和监控字段
status channel_status DEFAULT 'active' NOT NULL,
test_status test_status DEFAULT 'normal' NOT NULL,
test_time TIMESTAMP,
silent_days INTEGER DEFAULT 0,

-- 管理员和供应商关联
admin_id UUID,
provider_name VARCHAR(255),

-- 通道类型和配置
channel_type VARCHAR(50), 
channel_name VARCHAR(255),

-- 扩展配置字段
channel_config JSONB DEFAULT '{}',
routing_config JSONB DEFAULT '{}',
monitor_config JSONB DEFAULT '{}'
```

#### 任务1.2: 创建关联表
- **目标**: 创建通道组关系、监控配置、参数配置等关联表
- **输出**: 新增表结构和索引

```sql
-- 通道组关系表
CREATE TABLE channel_group_relations (
    relation_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    channel_id VARCHAR(255) REFERENCES channels(channel_id),
    group_id VARCHAR(255),
    priority INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 通道监控配置表
CREATE TABLE channel_monitors (
    monitor_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    channel_id VARCHAR(255) REFERENCES channels(channel_id),
    monitor_type VARCHAR(50),
    monitor_config JSONB DEFAULT '{}',
    status VARCHAR(20) DEFAULT 'active',
    last_check_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 通道参数配置表
CREATE TABLE channel_params (
    param_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    channel_id VARCHAR(255) REFERENCES channels(channel_id),
    param_name VARCHAR(100),
    param_value TEXT,
    param_type VARCHAR(50),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 任务1.3: 创建测试数据
- **目标**: 扩展 `init_mock_data.sql`，增加通道协议测试数据
- **输出**: 10-15条通道协议测试数据，覆盖不同状态和类型

### 🔶 **阶段2: 后端API开发** (2天)

#### 任务2.1: 创建Channel模型层
- **目标**: 参考Account模型，创建完整的Channel模型
- **输出**: `app/models/customers/channel.py`

**主要内容**:
```python
class ChannelStatus(enum.Enum):
    ACTIVE = 'active'
    INACTIVE = 'inactive'
    MAINTENANCE = 'maintenance'

class TestStatus(enum.Enum):
    NORMAL = 'normal'
    ABNORMAL = 'abnormal'
    UNKNOWN = 'unknown'

class Channel(db.Model, TimestampMixin):
    __tablename__ = 'channels'
    
    channel_id = db.Column(db.String(255), primary_key=True)
    channel_name = db.Column(db.String(255))
    status = db.Column(db.Enum(ChannelStatus))
    test_status = db.Column(db.Enum(TestStatus))
    # ... 其他字段
```

#### 任务2.2: 开发ChannelService服务层
- **目标**: 参考AccountService，实现通道协议业务逻辑
- **输出**: `app/services/channels/channel_service.py`

**核心方法**:
```python
class ChannelService(BaseService):
    def get_channels_with_filters(self, **filters)
    def create_channel(self, channel_data)
    def update_channel(self, channel_id, data)
    def delete_channel(self, channel_id)
    def test_channel_connection(self, channel_id)
    def batch_close_channels(self, channel_ids)
    def get_channel_statistics(self)
```

#### 任务2.3: 创建Marshmallow序列化器
- **目标**: 实现API数据序列化和验证
- **输出**: `app/api/v1/channels/schema/channel.py`

#### 任务2.4: 开发API路由端点
- **目标**: 实现完整的RESTful API端点
- **输出**: `app/api/v1/channels/route/` 目录下的路由文件

**API端点规划**:
```
GET/POST   /api/v1/channels                    # 列表查询/创建
GET/PUT/DELETE /api/v1/channels/{id}          # 详情/更新/删除
POST       /api/v1/channels/{id}/test         # 测试连接
POST       /api/v1/channels/batch-close       # 批量关闭
GET        /api/v1/channels/statistics        # 统计信息
POST       /api/v1/channels/{id}/send-sms     # 发送测试短信
GET/PUT    /api/v1/channels/{id}/params       # 参数管理
GET/PUT    /api/v1/channels/{id}/monitors     # 监控配置
```

### 🔶 **阶段3: 前端界面开发** (2天)

#### 任务3.1: 创建基础页面架构
- **目标**: 参考Account管理页面，创建通道协议管理页面基础架构
- **输出**: `src/pages/ChannelManagement/` 目录结构

**页面架构**:
```
src/pages/ChannelManagement/
├── index.tsx                          # 主页面入口
├── ChannelListPage.tsx               # 通道列表页面
├── components/
│   ├── ChannelSearchFilter.tsx       # 搜索筛选组件
│   ├── ChannelTable.tsx             # 通道列表表格
│   ├── ChannelFormModal.tsx         # 新增/编辑弹窗
│   ├── ChannelDetailModal.tsx       # 详情查看弹窗
│   ├── SendSmsModal.tsx             # 发送短信弹窗
│   ├── ParamConfigModal.tsx         # 参数配置弹窗
│   ├── MonitorConfigModal.tsx       # 监控配置弹窗
│   └── ChannelActionButtons.tsx     # 操作按钮组
```

#### 任务3.2: 开发RTK Query API服务
- **目标**: 创建前端API服务层
- **输出**: `src/api/channelApi.ts`

**API服务内容**:
```typescript
export const channelApi = baseApi.injectEndpoints({
  endpoints: (builder) => ({
    getChannels: builder.query<ChannelListResponse, ChannelQueryParams>({
      query: (params) => ({
        url: '/channels',
        params
      }),
      providesTags: ['Channel']
    }),
    createChannel: builder.mutation<Channel, CreateChannelRequest>({
      query: (data) => ({
        url: '/channels',
        method: 'POST',
        body: data
      }),
      invalidatesTags: ['Channel']
    }),
    // ... 其他API方法
  })
});
```

#### 任务3.3: 实现核心组件
- **目标**: 实现搜索筛选、表格展示、操作弹窗等核心组件
- **参考**: Account管理页面的组件实现模式
- **重点**: 实现UI-UX设计方案中的所有交互功能

**核心组件功能**:
- **ChannelSearchFilter**: 多维度筛选（管理员、关键字、供应商、状态等）
- **ChannelTable**: 支持排序、分页、批量选择的表格组件
- **操作弹窗**: 各种操作的模态框组件

#### 任务3.4: 状态管理和路由集成
- **目标**: 集成Redux状态管理和路由配置
- **输出**: 
  - `src/store/slices/channelSlice.ts` - 状态管理
  - 路由配置更新 - 集成到主应用

### 🔶 **阶段4: 高级功能开发** (1天)

#### 任务4.1: 实现批量操作功能
- **目标**: 实现批量关闭、批量导出等功能
- **技术**: 前后端协同开发批量操作API和UI

#### 任务4.2: 实时状态监控
- **目标**: 实现通道状态的实时监控和更新
- **技术**: WebSocket或轮询机制

#### 任务4.3: 高级查询和筛选
- **目标**: 实现复杂的查询条件组合和搜索功能
- **技术**: 后端查询优化，前端高级筛选UI

### 🔶 **阶段5: 系统集成和测试** (1天)

#### 任务5.1: 功能联调测试
- **目标**: 完整的功能测试，确保所有功能正常工作
- **测试**: CRUD操作、筛选查询、批量操作、状态监控

#### 任务5.2: 性能优化
- **目标**: 优化查询性能，确保大数据量下的响应速度
- **技术**: 数据库索引优化、前端虚拟滚动、缓存策略

#### 任务5.3: 权限验证
- **目标**: 确保所有操作都正确验证用户权限
- **测试**: 不同角色的权限访问测试

## 📁 目标文件架构

### 后端文件结构
```
pigeon_web/
├── sql/modules/
│   └── accounts_channels.sql          # 扩展表结构
├── app/
│   ├── models/customers/
│   │   ├── channel.py                 # 通道模型
│   │   ├── channel_group.py           # 通道组模型
│   │   └── channel_monitor.py         # 监控模型
│   ├── services/channels/
│   │   └── channel_service.py         # 通道服务层
│   └── api/v1/channels/
│       ├── schema/
│       │   └── channel.py             # 序列化器
│       └── route/
│           ├── channel_list.py        # 列表/创建
│           ├── channel_detail.py      # 详情/更新/删除
│           ├── channel_test.py        # 测试功能
│           ├── channel_batch.py       # 批量操作
│           └── channel_statistics.py  # 统计信息
```

### 前端文件结构
```
frontend/src/
├── pages/ChannelManagement/
│   ├── index.tsx
│   ├── ChannelListPage.tsx
│   └── components/
│       ├── ChannelSearchFilter.tsx
│       ├── ChannelTable.tsx
│       ├── ChannelFormModal.tsx
│       ├── ChannelDetailModal.tsx
│       ├── SendSmsModal.tsx
│       ├── ParamConfigModal.tsx
│       ├── MonitorConfigModal.tsx
│       └── ChannelActionButtons.tsx
├── api/
│   └── channelApi.ts
├── store/slices/
│   └── channelSlice.ts
└── types/
    └── channel.ts
```

## 🎯 技术实现要点

### 数据库设计原则
- **遵循现有模式**: 使用UUID主键、TimestampMixin、模块化SQL
- **性能优化**: 合理索引设计，支持高效查询
- **扩展性**: JSON字段存储灵活配置，支持未来功能扩展

### 后端开发规范
- **分层架构**: 严格按照Model-Service-API三层架构
- **代码复用**: 继承BaseService基类，复用通用功能
- **错误处理**: 统一异常处理和错误响应格式
- **权限控制**: 集成现有RBAC权限体系

### 前端开发规范
- **组件化**: 高度组件化，提高代码复用率
- **状态管理**: RTK Query + Redux Toolkit标准化状态管理
- **用户体验**: 加载状态、错误处理、操作反馈
- **响应式设计**: 支持不同屏幕尺寸的适配

## 📋 验收标准

### 功能验收 ✅
- [ ] 通道协议CRUD操作完全正常
- [ ] 多维度筛选查询功能正确
- [ ] 批量操作功能稳定
- [ ] 实时状态监控准确
- [ ] 所有弹窗操作功能完整
- [ ] 权限控制验证有效

### 性能验收 ✅
- [ ] 列表查询响应时间 < 5秒
- [ ] 支持1000+条记录的流畅操作
- [ ] 实时状态更新延迟 < 30秒
- [ ] 批量操作处理性能良好

### 用户体验验收 ✅
- [ ] 界面布局符合UI-UX设计方案
- [ ] 操作流程直观便捷
- [ ] 错误提示清晰明确
- [ ] 加载状态反馈及时

## 🔧 风险控制

### 技术风险
- **数据库兼容性**: 扩展现有表结构可能影响系统稳定性
- **性能瓶颈**: 大数据量查询可能影响响应速度
- **状态同步**: 实时状态监控的准确性和及时性

### 缓解措施
- **渐进式开发**: 分阶段开发，每个阶段验证后再进行下一阶段
- **向后兼容**: 所有数据库变更保持向后兼容
- **性能测试**: 每个阶段进行性能测试，及时优化
- **回滚计划**: 准备数据库和代码的回滚方案

## 📈 后续扩展计划

### 短期扩展（1-2周）
- **通道组管理**: FEAT-6-2-3 通道组功能
- **参数修改**: FEAT-6-2-4 参数修改功能
- **监控管理**: FEAT-6-2-5 新增监控功能

### 中期扩展（1个月）
- **通道速度控制**: FEAT-6-2-6 通道速度管理
- **Sender管理**: FEAT-6-2-7 Sender管理功能
- **价格管理**: FEAT-6-2-8 国家短信价格功能

### 长期优化（3个月）
- **智能监控**: 基于AI的通道健康度评估
- **自动故障转移**: 通道故障自动切换
- **性能分析**: 深度性能分析和优化建议

---

**文档状态**: ✅ 开发计划已完成，API设计已根据需求更新扩展  
**最新更新**: 2025-09-16 根据FEAT-6-2-9批量导出功能扩展API设计  
**下一步行动**: 任务3.2 RTK Query API服务开发已完成，可以继续任务3.3组件开发  
**预计完成时间**: 2025-09-23

## 📋 **最新更新记录** (2025-09-16)

### ✅ **任务3.2: RTK Query API服务开发 - 已完成！**

**更新背景**: pigeon_requirements仓库更新，新增FEAT-6-2-9批量导出功能需求

**API扩展内容**:
- ✅ **新增6个接口类型**: ExportChannelsRequest, ExportChannelsResponse, ExportPermissionCheck, ExportStatistics, ChannelSelectionState, AllChannelIdsResponse
- ✅ **新增4个API端点**: exportChannels, getAllChannelIds, checkExportPermission, getExportStatistics  
- ✅ **新增4个React Hooks**: useExportChannelsMutation, useGetAllChannelIdsQuery, useCheckExportPermissionQuery, useGetExportStatisticsQuery
- ✅ **智能导出支持**: 支持"导出全部"和"导出选中"两种模式
- ✅ **权限控制**: 敏感信息导出权限验证
- ✅ **统计监控**: 导出操作统计和历史记录

**技术成果**:
```typescript
// 支持的导出功能
export interface ExportChannelsRequest {
  export_mode: 'all' | 'selected';
  channel_ids?: string[];
  export_fields?: string[];
  include_sensitive?: boolean;
  format?: 'xlsx' | 'csv';
}

// 新增API端点
POST /api/v1/channels/export           // 批量导出
GET  /api/v1/channels/ids              // 获取所有通道ID
GET  /api/v1/channels/export/permission-check  // 权限检查
GET  /api/v1/channels/export/statistics       // 导出统计
```

**文件更新**:
- `src/api/channelApi.ts`: 扩展56行代码，新增导出功能
- `src/api/baseApi.ts`: 新增Channel相关tagTypes
- `src/api/index.ts`: 更新类型导出，支持导出功能类型

**验收状态**: ✅ TypeScript语法检查通过，17个导出相关功能添加完成  