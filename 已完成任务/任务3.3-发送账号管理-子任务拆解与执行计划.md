# Copyright(c) 2025
# All rights reserved.
#
# Author: yukun.xing <xingyukun@gmail.com>
# Date:   2025/09/10

# 任务3.3 · 发送账号管理体系 — 子任务拆解与执行计划

## 范围与对齐
- 对齐需求：MODU-01、FEAT-1-2 发送账号管理
- 当前实现：已有基础Account模型，但缺少完整字段和配置管理
- 目标：完整的发送账号CRUD、配置管理、协议参数、高级策略

## 业务需求分析

### 发送账号核心功能
1. **账号基础管理**
   - 创建/编辑/删除发送账号
   - 关联企业账号
   - 启用/禁用状态管理
   - 账号类型（SMPP/HTTP/专线等）

2. **协议参数配置**
   - SMPP协议参数（用户名、密码、端口、系统类型等）
   - HTTP协议参数（URL、认证方式、请求格式等）
   - 连接参数（超时、重试、并发数等）

3. **高级策略配置**
   - IP白名单管理
   - 发送速率限制（TPS/日限/月限）
   - 号码黑名单
   - 内容过滤规则
   - 签名管理
   - 路由策略

## 当前状态评估

### 已有组件
- `app/models/customers/account.py` - 基础Account模型
- 企业账号管理完整实现（可参考）
- 认证授权系统
- 基础API框架

### 需要开发
- Account模型字段扩展
- AccountService服务层
- 完整的CRUD API
- 配置管理API
- 前端管理界面
- 三个配置标签页

## 子任务列表（按优先级排序）

### 后端开发任务（6小时）

#### 1) feat(account): 完善Account模型和数据库表
- **目标**: 扩展Account模型，添加完整的配置字段
- **改动**:
  ```python
  # 需要添加的字段
  - protocol_type: Enum(SMPP, HTTP, Custom)
  - smpp_config: JSON (用户名、密码、端口、系统类型等)
  - http_config: JSON (URL、认证、请求格式等)
  - connection_config: JSON (超时、重试、并发等)
  - ip_whitelist: Array[String]
  - rate_limits: JSON (TPS、日限、月限)
  - blacklist_rules: JSON
  - signature_config: JSON
  - routing_config: JSON
  - priority: Integer
  - balance_alert_threshold: Decimal
  ```
- **验收**: 数据库表结构完整，支持所有配置需求
- **预估**: 1.5小时

#### 2) feat(account): 创建AccountService服务层
- **目标**: 实现业务逻辑层，分离API和数据访问
- **实现**:
  - 创建 `app/services/accounts/account_service.py`
  - 继承BaseService，实现标准CRUD方法
  - 账号状态管理（启用/禁用/暂停）
  - 配置验证逻辑
  - 企业关联验证
  - 余额检查集成
- **验收**: Service层完整，业务逻辑清晰
- **预估**: 1.5小时

#### 3) feat(account): 实现CRUD API端点
- **目标**: RESTful API完整实现
- **端点**:
  - GET /api/v1/accounts/ (列表，支持筛选/分页/排序)
  - POST /api/v1/accounts/ (创建)
  - GET /api/v1/accounts/:id (详情)
  - PUT /api/v1/accounts/:id (更新)
  - DELETE /api/v1/accounts/:id (删除)
  - POST /api/v1/accounts/:id/toggle-status (启用/禁用)
- **验收**: 所有端点正常工作，权限控制有效
- **预估**: 1.5小时

#### 4) feat(account): 配置管理API
- **目标**: 三类配置的独立管理接口
- **端点**:
  - PUT /api/v1/accounts/:id/protocol-config (协议参数)
  - PUT /api/v1/accounts/:id/connection-config (连接参数)
  - PUT /api/v1/accounts/:id/advanced-config (高级策略)
  - GET /api/v1/accounts/:id/config (获取所有配置)
  - POST /api/v1/accounts/:id/test-connection (测试连接)
- **验收**: 配置可独立更新，验证有效
- **预估**: 1小时

#### 5) feat(account): 数据验证Schema
- **目标**: Marshmallow Schema完整验证
- **实现**:
  - 创建 `app/api/v1/accounts/schema/account.py`
  - AccountCreateSchema、AccountUpdateSchema
  - ProtocolConfigSchema、ConnectionConfigSchema
  - AdvancedConfigSchema
  - 自定义验证器（IP格式、速率限制等）
- **验收**: 输入验证严格，错误提示清晰
- **预估**: 0.5小时

### 前端开发任务（6小时）

#### 6) feat(account): RTK Query API层
- **目标**: 前端API调用层
- **实现**:
  - 创建/更新 `frontend/src/api/accountApi.ts`
  - 定义TypeScript接口
  - CRUD操作endpoints
  - 配置管理endpoints
  - 缓存标签管理
- **验收**: API层完整，类型安全
- **预估**: 1小时

#### 7) feat(account): 账号列表页面
- **目标**: 主列表页面组件
- **组件**:
  - `AccountListPage.tsx` - 主页面
  - `AccountSearchFilter.tsx` - 搜索筛选
  - `AccountListTable.tsx` - 列表表格
  - `AccountStatusBadge.tsx` - 状态徽章
  - `AccountActionButtons.tsx` - 操作按钮
- **功能**:
  - 多维度筛选（企业、状态、类型、创建时间）
  - 排序和分页
  - 批量操作（启用/禁用/删除）
  - 快速查看配置
- **验收**: 列表功能完整，交互流畅
- **预估**: 2小时

#### 8) feat(account): 账号表单弹窗
- **目标**: 创建/编辑账号弹窗
- **组件**:
  - `AccountFormModal.tsx` - 表单弹窗容器
  - `AccountBasicForm.tsx` - 基础信息表单
  - 表单验证（react-hook-form + yup）
- **字段**:
  - 账号名称、编码、类型
  - 关联企业（下拉选择）
  - 优先级、备注
- **验收**: 表单验证完整，提交成功
- **预估**: 1小时

#### 9) feat(account): 配置管理弹窗
- **目标**: 三标签页配置界面
- **组件结构**:
  ```
  AccountConfigModal.tsx
  ├── BasicConfigTab.tsx      # 基础信息
  ├── ProtocolConfigTab.tsx   # 协议参数
  └── AdvancedConfigTab.tsx   # 高级策略
  ```
- **基础配置标签**:
  - 账号基本信息编辑
  - 关联企业变更
  - 优先级调整
- **协议参数标签**:
  - SMPP参数表单（条件显示）
  - HTTP参数表单（条件显示）
  - 连接参数设置
  - 测试连接按钮
- **高级策略标签**:
  - IP白名单管理（动态增删）
  - 速率限制设置
  - 签名管理
  - 黑名单规则
- **验收**: 三个标签页完整可用，配置保存成功
- **预估**: 2小时

### 集成测试任务（附加）

#### 10) test(account): 前后端联调测试
- **目标**: 完整功能流程验证
- **测试点**:
  - 账号CRUD完整流程
  - 配置更新和验证
  - 权限控制测试
  - 错误处理测试
  - 并发操作测试
- **验收**: 所有功能正常，无阻塞问题
- **预估**: 0.5小时

## 技术实现要点

### 数据模型设计
```python
class Account(db.Model, TimestampMixin):
    # 基础字段
    id = Column(UUID, primary_key=True)
    enterprise_id = Column(UUID, ForeignKey('enterprises.id'))
    name = Column(String(100), nullable=False)
    code = Column(String(50), unique=True)
    status = Column(Enum(AccountStatus))
    protocol_type = Column(Enum(ProtocolType))
    
    # JSON配置字段
    smpp_config = Column(JSON)
    http_config = Column(JSON)
    connection_config = Column(JSON)
    advanced_config = Column(JSON)
    
    # 关系
    enterprise = relationship('Enterprise', back_populates='accounts')
```

### API响应格式
```json
{
  "code": 200,
  "message": "Success",
  "data": {
    "id": "uuid",
    "name": "账号名称",
    "code": "ACC001",
    "status": "active",
    "protocol_type": "SMPP",
    "enterprise": {
      "id": "uuid",
      "name": "企业名称"
    },
    "configs": {
      "smpp": {...},
      "connection": {...},
      "advanced": {...}
    }
  }
}
```

### 前端组件架构
```
frontend/src/pages/accounts/
├── AccountListPage.tsx          # 主页面
├── components/
│   ├── AccountSearchFilter.tsx  # 搜索筛选
│   ├── AccountListTable.tsx     # 列表表格
│   ├── AccountFormModal.tsx     # 创建/编辑弹窗
│   └── AccountConfigModal/      # 配置弹窗
│       ├── index.tsx
│       ├── BasicConfigTab.tsx
│       ├── ProtocolConfigTab.tsx
│       └── AdvancedConfigTab.tsx
├── hooks/
│   └── useAccountManagement.ts  # 自定义hooks
└── types.ts                     # TypeScript类型定义
```

## 风险控制

1. **配置复杂性**: JSON字段需要严格验证，防止错误配置
2. **权限控制**: 配置修改需要高级权限
3. **数据一致性**: 账号删除需检查是否有正在发送的消息
4. **性能优化**: 配置数据可能较大，需要按需加载

## 验收标准

### 功能验收
- [ ] 账号CRUD完整可用
- [ ] 三类配置独立管理
- [ ] 与企业账号正确关联
- [ ] 状态管理正常
- [ ] 权限控制有效

### 技术验收
- [ ] Service层架构清晰
- [ ] API响应格式统一
- [ ] 前端类型安全
- [ ] 错误处理完善
- [ ] 代码符合规范

### 用户体验
- [ ] 界面响应流畅
- [ ] 操作反馈及时
- [ ] 错误提示清晰
- [ ] 配置界面直观

## 执行顺序建议

**第一批（核心功能）**: 1→2→3→6→7→8
- 先完成基础CRUD，确保主流程通畅

**第二批（配置管理）**: 4→5→9
- 实现完整的配置管理功能

**第三批（测试优化）**: 10
- 联调测试，修复问题

## 时间估算汇总
- **后端开发**: 6小时
- **前端开发**: 6小时
- **总计**: 12小时（1.5个工作日）

---
文档创建时间: 2025-09-10
负责人: Claude Code Assistant
状态: 待执行