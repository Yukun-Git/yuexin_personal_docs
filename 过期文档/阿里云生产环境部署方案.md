# 阿里云生产环境部署方案

**重要说明**: 本方案基于pigeon和pigeon_web共享数据库基础设施的架构设计，避免重复建设，降低运维成本。

## 1. 架构设计

### 1.1 总体架构 (与pigeon项目共享基础设施)
```
Internet --> CDN --> SLB --> [pigeon_web Frontend ECS] + [pigeon_web Backend ECS]
                        |                                            |
                        |--> OSS (静态资源存储)                        |
                                                                      |
                                                                      v
                                                            共享 RDS + Redis
                                                                  ^
                                                                  |
                                                            [pigeon项目]
```

### 1.2 技术栈
- **后端**: Python Flask 3.0.0 + Gunicorn + PostgreSQL + Redis
- **前端**: React 19 + TypeScript + Vite + Ant Design
- **反向代理**: Nginx
- **容器化**: Docker + Docker Compose

## 2. 阿里云服务选择

### 2.1 计算服务
- **ECS (弹性计算服务)**
  - 前端服务器: 2vCPU 4GB (ecs.s6-c1m2.large)
  - 后端服务器: 4vCPU 8GB (ecs.s6-c1m4.xlarge)
  - 系统: Ubuntu 22.04 LTS

### 2.2 数据库服务 (共享pigeon项目)
- **RDS PostgreSQL**
  - **重要**: 与pigeon项目共用现有数据库实例
  - 无需重复创建，使用现有配置
  - pigeon_web表结构需独立管理

### 2.3 缓存服务 (共享pigeon项目)
- **Redis 企业版**
  - **重要**: 与pigeon项目共用现有Redis实例
  - 无需重复创建，使用现有配置
  - 注意命名空间隔离

### 2.4 网络与安全
- **SLB (负载均衡)**
  - 应用型负载均衡 ALB
  - 支持 HTTPS/HTTP
- **CDN (内容分发网络)**
  - 加速前端静态资源
- **OSS (对象存储)**
  - 存储前端构建产物
  - 静态资源CDN加速

### 2.5 监控与日志
- **云监控**
  - ECS、RDS、Redis 监控
  - 自定义告警
- **日志服务 SLS**
  - 应用日志收集
  - 访问日志分析

## 3. 服务器配置

### 3.1 前端服务器配置
```bash
# Nginx + 静态文件服务
- CPU: 2核
- 内存: 4GB
- 磁盘: 40GB SSD
- 网络: 5Mbps
```

### 3.2 后端服务器配置
```bash
# Python Flask + Gunicorn
- CPU: 4核
- 内存: 8GB
- 磁盘: 60GB SSD
- 网络: 10Mbps
```

## 4. 安全配置

### 4.1 安全组规则
```bash
# 前端服务器安全组
- 入站: 80, 443 (来源: SLB)
- 入站: 22 (来源: 管理IP)
- 出站: 全部允许

# 后端服务器安全组
- 入站: 5000 (来源: 前端服务器)
- 入站: 22 (来源: 管理IP)
- 出站: 全部允许

# 数据库安全组
- 入站: 5432 (来源: 后端服务器)
- 入站: 6379 (来源: 后端服务器) # Redis
```

### 4.2 SSL证书配置
- 申请阿里云SSL证书
- 配置HTTPS强制重定向
- 配置HSTS安全头

## 5. 部署流程

### 5.1 环境准备
1. **创建VPC和子网**
2. **配置安全组**
3. **创建ECS实例**
4. **创建RDS实例**
5. **创建Redis实例**
6. **配置SLB和域名**

### 5.2 应用部署
1. **后端部署**
   - 安装Python环境
   - 配置虚拟环境
   - 安装依赖
   - 配置Gunicorn
   - 配置systemd服务

2. **前端部署**
   - 安装Node.js环境
   - 构建生产版本
   - 配置Nginx
   - 配置静态资源CDN

### 5.3 数据库初始化
- 执行数据库初始化脚本
- 导入基础数据
- 配置数据库连接

## 6. CI/CD 流程

### 6.1 代码仓库
- 使用Git管理代码
- 主分支: main
- 环境分支: develop, staging, production

### 6.2 自动化部署
```yaml
# 部署流程
1. 代码提交到main分支
2. 触发自动构建
3. 运行测试用例
4. 构建Docker镜像
5. 推送到镜像仓库
6. 自动部署到生产环境
7. 健康检查
8. 发送部署通知
```

## 7. 监控和运维

### 7.1 应用监控
- CPU、内存、磁盘使用率
- 应用响应时间
- 错误率统计
- 数据库连接数

### 7.2 日志管理
- 应用日志收集
- 错误日志告警
- 访问日志分析
- 安全日志审计

### 7.3 备份策略
- 数据库自动备份 (每日)
- 代码备份 (Git)
- 配置文件备份
- 灾难恢复计划

## 8. 成本估算 (月费用)

| 服务 | 规格 | 价格 (元/月) | 备注 |
|------|------|--------------|------|
| 前端ECS | 2vCPU 4GB | 280 | pigeon_web独享 |
| 后端ECS | 4vCPU 8GB | 560 | pigeon_web独享 |
| RDS PostgreSQL | - | 0 | 共享pigeon项目现有实例 |
| Redis | - | 0 | 共享pigeon项目现有实例 |
| SLB | 标准版 | 180 | pigeon_web独享 |
| CDN | 100GB流量 | 200 | pigeon_web独享 |
| OSS | 100GB存储 | 20 | pigeon_web独享 |
| 带宽 | 10Mbps | 500 | pigeon_web独享 |
| **总计** | | **约1740元/月** | 节省约1030元/月 |

## 9. 性能优化

### 9.1 前端优化
- Gzip压缩
- 静态资源CDN加速
- 浏览器缓存策略
- 代码分割和懒加载

### 9.2 后端优化
- 数据库连接池
- Redis缓存策略
- API响应缓存
- 数据库查询优化

### 9.3 系统优化
- 服务器性能调优
- 数据库参数优化
- 网络优化配置
- 监控和告警优化

## 10. 扩展性规划

### 10.1 水平扩展
- 多实例部署
- 负载均衡配置
- 数据库读写分离
- 缓存集群部署

### 10.2 垂直扩展
- 服务器规格升级
- 数据库性能升级
- 带宽升级
- 存储扩容

## 11. 安全加固

### 11.1 服务器安全
- 定期系统更新
- 防火墙配置
- SSH密钥认证
- 禁用不必要服务

### 11.2 应用安全
- HTTPS强制
- SQL注入防护
- XSS防护
- CSRF防护
- API访问限制

### 11.3 数据安全
- 数据库加密
- 定期备份验证
- 访问权限控制
- 敏感数据脱敏