# Copyright(c) 2025
# All rights reserved.
#
# Author: yukun.xing <xingyukun@gmail.com>
# Date:   2025/10/23

# 历史兼容代码与数据习惯清单

> 目的：罗列当前代码库中仍然存在的“向后兼容”“临时兼容”实现，便于后续逐项移除，确保系统仅支持最新规范。

## 数据库与模型层

- `sql/modules/channels.sql:57-62`  
  `mgmt.channels` 表保留 `enabled / is_enabled / is_online / is_direct` 等旧布尔字段，仅用于兼容旧接口。

- `sql/modules/accounts.sql:75-81`  
  `mgmt.accounts` 表保留 `number_blacklist / signatures / whitelisted / censor_words / templates` 等 JSON/布尔旧字段。

- `app/models/customers/channel.py:126-130`  
  模型层同步保留上述通道旧字段。

- `app/models/customers/account.py:131-136`  
  模型层同步保留发送账号旧字段。

- `app/services/accounts/account_service.py:760-767`  
  `_set_configuration_fields` 在写库时仍主动回填旧 JSON 字段，维持旧结构。

- `app/services/sync/account_redis_sync.py:38-138`  
  Redis 同步显式生成“pigeon 旧结构”JSON，包括 `signatures/censor_words/templates` 等遗留字段。

## 后端接口与服务

- `app/middleware/url_rewrite.py` & `app/utils/deprecation.py`  
  提供 `/api/v1/accounts → /api/v1/sending-accounts` 的 URL 重写、中间件与告警头，完全是 FEAT-1-2 迁移期的兼容逻辑。

- `app/api/v1/sms/route/routes.py:24-48`  
  同一路径同时暴露 `/api/v1/sms/outbox`（V1, 标记为 legacy）和 `/api/v1/sms/v2/outbox`（V2）。V1 属临时兼容。

- `app/services/auth/service/auth.py:423-430`  
  `PermissionService.check_permission` 先查下划线权限，再回落冒号权限（legacy_code），用于兼容旧权限记录。

- `app/api/v1/platform_errors/schema/error_schema.py:162-178`  
  Schema 在 `pre_load` 中把 `page_size` 改写成 `per_page`。属于前端迁移期兼容。

- `app/api/v1/country_regions/schema/country_region_schema.py:240-247`  
  同样在 `@post_load` 把 `page_size`→`per_page` 并移除 `page_size`。

- `app/api/v1/admin_users/schema/admin_user_schema.py:23-52`  
  `name` 字段通过 `full_name` 生成别名，只为“保持前端兼容”。

- `app/api/v1/admin_users/route/admin_user_list.py:108-109`  
  返回体同时携带 `users` 与 `items`，后者用于“保持向后兼容”。

- `app/services/accounts/account_service.py:1593-1653`  
  `get_account_overview` 既返回新结构 `basicInfo/protocolInfo`，又保留旧的 `overview` 字段以兼容旧前端。

- `app/services/sensitive_words/application_config_service.py:30-48`  
  同一个服务暴露多组“API-compatible alias”方法，单纯为了旧接口调用习惯。

- `app/services/sensitive_words/word_management_service.py:1253-1265`  
  `get_import_history_by_id` 注释说明是 “API-compatible alias”。

- `app/utils/response.py:93-100`  
  `error_response`/`success_response` 被标注为 “Convenience functions for backwards compatibility”。

- `app/repositories/*`（黑白名单、Phone Entry 等）  
  多处读取 `pagination['page_size']` 后在 ORM 层继续传 `per_page`，说明分页字段仍处于迁移期混用。

## 前端代码

- `frontend/src/types/entities/business.ts:102-106`  
  `ChannelGroup` 同时保留 `groupName/groupType/groupIdentifier` 等“Legacy aliases”。

- `frontend/src/api/senderApi.ts:211-212`  
  重新导出 `useGetAllCountryRegionsQuery` 供旧代码少改 import，注释直接写着 “for backward compatibility”。

- `frontend/src/components/shared/PhoneManagement/types.ts:7`  
  注释说明移除复杂类型以“避免兼容性问题”，仍沿用旧类型定义。

- Playwright 测试脚本（如 `tests/e2e/pages/OutboxPage.ts:553-557`）同时兼容“legacyButton / modernButton”两套导出按钮逻辑。

## 测试与脚手架

- `tests/README.md:12-166` & `tests/pytest.ini:19-20`  
  仍保留 `_legacy/` 目录、不让删除，并在 PyTest 配置中忽略该目录。

## 建议的后续动作

1. **数据库/模型字段**  
   - 评估通道、账号旧字段是否仍被新业务使用；若确认无需保留，更新模型 & SQL 初始化脚本并同步移除所有写入/读取逻辑。

2. **权限与接口兼容层**  
   - 确认权限数据均已迁移为下划线格式后，移除 `legacy_code` 回退。  
   - 若所有客户端均已切换新路径，删除 URL Rewrite、中间件与 V1 SMS 接口。

3. **分页参数**  
   - 后端统一接受 `page_size` 并更新仓储/服务，废弃 `per_page`。完成后移除所有自动映射代码。

4. **前端别名与 Re-export**  
   - 确认调用方全部更新后，删除 `ChannelGroup` Legacy 字段与 `senderApi` 的兼容 re-export。

5. **测试/脚手架**  
   - 清理 `_legacy` 测试目录，更新说明文档与 PyTest 配置。

> 建议：按模块建立整改任务列表，逐步删除兼容逻辑，并在删除前通过脚本/数据检查确保再无依赖。
