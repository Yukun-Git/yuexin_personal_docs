# å‰åç«¯è”è°ƒæµ‹è¯•è¿›åº¦è®°å½• - 2025å¹´9æœˆ9æ—¥ä¸‹ç­å‰æœ€ç»ˆçŠ¶æ€

## ğŸ“ å½“å‰é—®é¢˜çŠ¶æ€
**æ ¸å¿ƒé—®é¢˜**: ä¼ä¸šç®¡ç†é¡µé¢ 401 UNAUTHORIZED
**æ ¹æœ¬åŸå› **: Viteä»£ç†åœ¨è½¬å‘è¯·æ±‚æ—¶Authorizationå¤´ä¸¢å¤±
**è°ƒè¯•è¿›åº¦**: å·²ç¡®å®šé—®é¢˜ä½ç½®ï¼Œæœ€æ–°ä¿®å¤æ–¹æ¡ˆå·²éƒ¨ç½²å¾…éªŒè¯

## ğŸ” é—®é¢˜åˆ†æè¿‡ç¨‹å›é¡¾

### åˆå§‹é—®é¢˜è¡¨ç°
- ä¼ä¸šç®¡ç†é¡µé¢(`http://localhost:5173/customers/enterprises`)å‡ºç°401é”™è¯¯
- ç®€å•å‚æ•°è¯·æ±‚æˆåŠŸï¼Œå¤æ‚å‚æ•°è¯·æ±‚å¤±è´¥
- ç”¨æˆ·æŠ¥å‘ŠNetworké¢æ¿ä¸­æ²¡æœ‰Authorizationå¤´

### é—®é¢˜è¯Šæ–­è¿‡ç¨‹

#### ç¬¬1é˜¶æ®µï¼šæ€€ç–‘æ–œæ å…¼å®¹æ€§é—®é¢˜ âŒ
**å°è¯•**: ä¿®å¤åç«¯è·¯ç”±æ–œæ å¤„ç†
- åç«¯è®¾ç½®: `flask_app.url_map.strict_slashes = False`
- ç»“æœï¼šé—®é¢˜ä¾ç„¶å­˜åœ¨

#### ç¬¬2é˜¶æ®µï¼šæ€€ç–‘fetchBaseQueryé…ç½®é—®é¢˜ âŒ  
**å°è¯•**: ä¿®å¤RTK Query baseQueryé…ç½®
- æ·»åŠ `credentials: 'same-origin'`
- ä½¿ç”¨å°å†™`authorization`å¤´
- è¯¦ç»†çš„prepareHeadersè°ƒè¯•
- ç»“æœï¼šprepareHeadersæ­£ç¡®è®¾ç½®Authorizationå¤´ï¼Œä½†Networké¢æ¿ä»æ— Authorizationå¤´

#### ç¬¬3é˜¶æ®µï¼šåˆ‡æ¢åˆ°è‡ªå®šä¹‰baseQuery âŒ
**å°è¯•**: ç»•è¿‡fetchBaseQueryï¼Œä½¿ç”¨è‡ªå®šä¹‰fetchå®ç°
- å®ç°å®Œæ•´çš„è‡ªå®šä¹‰baseQueryå‡½æ•°  
- æ‰‹åŠ¨æ„å»ºURLã€headersã€æŸ¥è¯¢å‚æ•°
- ç»“æœï¼šè‡ªå®šä¹‰fetchæ­£ç¡®è®¾ç½®Authorizationå¤´ï¼Œä½†é—®é¢˜ä¾ç„¶å­˜åœ¨

#### ç¬¬4é˜¶æ®µï¼šå‘ç°æ ¸å¿ƒé—®é¢˜ âœ…
**å…³é”®å‘ç°**: 
- å‰ç«¯æ­£ç¡®æ„å»ºè¯·æ±‚ï¼š`http://localhost:5173/api/v1/enterprises` + Authorizationå¤´
- ä½†å®é™…ç½‘ç»œè¯·æ±‚æ˜¾ç¤ºï¼š`http://localhost:5000/api/v1/enterprises` + æ— Authorizationå¤´
- **é—®é¢˜ç¡®è®¤**: Viteä»£ç†åœ¨è½¬å‘è¿‡ç¨‹ä¸­ä¸¢å¤±Authorizationå¤´ï¼

## ğŸ› ï¸ å·²å®Œæˆçš„ä¿®å¤

### 1. âœ… åç«¯è·¯ç”±é…ç½®ä¿®å¤
**æ–‡ä»¶**: `pigeon_web/app/api/v1/enterprises/route/routes.py`
```python
# ä¿®å¤è·¯ç”±æ³¨å†Œè·¯å¾„åŒ¹é…é—®é¢˜
app.register_blueprint(enterprises_bp, url_prefix='/api/v1/enterprises')
```

### 2. âœ… åç«¯æ–œæ å…¼å®¹æ€§
**æ–‡ä»¶**: `pigeon_web/app/__init__.py`
```python
flask_app.url_map.strict_slashes = False
```

### 3. âœ… å‰ç«¯æ•°æ®ç»“æ„ä¿®å¤  
**æ–‡ä»¶**: `pigeon_web/frontend/src/pages/CustomerManagement/Enterprise/components/EnterpriseListTable.tsx`
```typescript
// ä¿®å¤æ•°æ®è®¿é—®è·¯å¾„
dataSource={enterpriseData?.data?.enterprises}
pagination={{
  current: enterpriseData?.data?.pagination?.page,
  total: enterpriseData?.data?.pagination?.total,
  pageSize: enterpriseData?.data?.pagination?.per_page,
}}
```

### 4. âœ… Viteä»£ç†åŸºç¡€é…ç½®ä¿®å¤
**æ–‡ä»¶**: `pigeon_web/frontend/vite.config.ts`
```typescript
proxy: {
  '/api': {  // ä¿®å¤äº†ä¹‹å‰é”™è¯¯çš„æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼ '^/api/.*'
    target: 'http://localhost:5000',
    changeOrigin: true,
    secure: false,
    ws: true,
    followRedirects: false,
  }
}
```

### 5. âœ… è‡ªå®šä¹‰baseQueryå®ç°
**æ–‡ä»¶**: `pigeon_web/frontend/src/api/baseApi.ts`
- å®Œæ•´æ›¿æ¢fetchBaseQueryä¸ºè‡ªå®šä¹‰å®ç°
- æ‰‹åŠ¨å¤„ç†URLæ„å»ºã€æŸ¥è¯¢å‚æ•°ã€headers
- è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—è¾“å‡º

### 6. ğŸš§ æœ€æ–°Viteä»£ç†å¼ºåŒ–é…ç½® (å¾…éªŒè¯)
**æ–‡ä»¶**: `pigeon_web/frontend/vite.config.ts`
```typescript
'/api': {
  target: 'http://localhost:5000',
  changeOrigin: true,
  secure: false,
  ws: true,
  followRedirects: false,
  preserveHeaderKeyCase: true,  // ä¿ç•™å¤´éƒ¨å¤§å°å†™
  configure: (proxy, options) => {
    proxy.on('proxyReq', (proxyReq, req, res) => {
      // å¼ºåˆ¶å¤åˆ¶å…³é”®headers
      const criticalHeaders = ['authorization', 'content-type', 'accept'];
      criticalHeaders.forEach(headerName => {
        const headerValue = req.headers[headerName];
        if (headerValue) {
          proxyReq.setHeader(headerName, headerValue);
        }
      });
      
      // ç‰¹åˆ«å¤„ç†Authorizationå¤´
      const authHeaders = ['authorization', 'Authorization'];
      authHeaders.forEach(authKey => {
        const authValue = req.headers[authKey];
        if (authValue) {
          proxyReq.setHeader('Authorization', authValue);
        }
      });
    });
  }
}
```

## ğŸ”¬ è¯Šæ–­è¯æ®

### å‰ç«¯è°ƒè¯•è¾“å‡º (æœ€æ–°çŠ¶æ€)
```javascript
ğŸ”ğŸ” è‡ªå®šä¹‰fetchè®¾ç½®Authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6Ik...
ğŸ”ğŸ” å³å°†å‘é€è¯·æ±‚è¯¦æƒ…: {
  url: '/api/v1/enterprises?page=1&per_page=20&order_by=created_at&order_dir=desc',
  headers: {
    Authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmcmâ€¦'
  },
  å®Œæ•´URLè§£æ: 'http://localhost:5173/api/v1/enterprises?page=1&per_page=20&order_by=created_at&order_dir=desc'
}
```

### åç«¯è°ƒè¯•è¾“å‡º (é—®é¢˜çŠ¶æ€)
```
ğŸ”ğŸ” Request URL: http://localhost:5000/api/v1/enterprises/?page=1&per_page=20&order_by=created_at&order_dir=desc
ğŸ”ğŸ” Authorizationå¤´: ç¼ºå¤±  â† é—®é¢˜æ‰€åœ¨ï¼
```

### Networké¢æ¿è¯æ®
- Request URL: `http://localhost:5000/api/v1/enterprises/...`
- Request Headers: **ç¼ºå¤±Authorizationå¤´**
- Status: 401 UNAUTHORIZED

## ğŸ“‹ ä¸‹æ¬¡ä¸Šç­ç«‹å³æ‰§è¡Œæ­¥éª¤

### ç¬¬1æ­¥ï¼šéªŒè¯æœ€æ–°ä»£ç†ä¿®å¤
âš ï¸ **å¿…é¡»é‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨**
```bash
cd pigeon_web/frontend
# åœæ­¢å½“å‰æœåŠ¡å™¨ (Ctrl+C)
npm run dev
```

### ç¬¬2æ­¥ï¼šæ£€æŸ¥ä»£ç†å¼ºåŒ–æ•ˆæœ
è®¿é—®ä¼ä¸šç®¡ç†é¡µé¢ï¼Œå‰ç«¯æ§åˆ¶å°åº”æ˜¾ç¤ºï¼š
```
ğŸ” Proxy intercepted: GET /api/v1/enterprises?page=1&per_page=20&order_by=created_at&order_dir=desc
ğŸ” Incoming headers: {authorization: 'Bearer ...', ...}
ğŸ” âœ… å¼ºåˆ¶è®¾ç½® authorization: Bearer eyJhbGciOiJIUzI1NiIs...
ğŸ” ğŸš€ Authorizationå¤´å·²å¼ºåˆ¶è®¾ç½®!
ğŸ” Proxyå®Œæˆ: 200 /api/v1/enterprises?page=1&per_page=20&order_by=created_at&order_dir=desc
```

### ç¬¬3æ­¥ï¼šéªŒè¯åç«¯æ¥æ”¶
åç«¯æ—¥å¿—åº”æ˜¾ç¤ºï¼š
```
ğŸ”ğŸ” Authorizationå¤´: Bearer eyJhbGciOiJIUzI1NiIs...  (ä¸å†æ˜¯"ç¼ºå¤±")
```

### ç¬¬4æ­¥ï¼šåŠŸèƒ½éªŒè¯
- âœ… ä¼ä¸šç®¡ç†é¡µé¢æ­£å¸¸åŠ è½½
- âœ… ä¼ä¸šåˆ—è¡¨æ˜¾ç¤º
- âœ… æ’åºåŠŸèƒ½å·¥ä½œ
- âœ… åˆ†é¡µåŠŸèƒ½å·¥ä½œ
- âœ… Networké¢æ¿æ˜¾ç¤ºAuthorizationå¤´

### ç¬¬5æ­¥ï¼šå¤‡ç”¨æ–¹æ¡ˆ (å¦‚æœä»£ç†ä¿®å¤ä»å¤±è´¥)

å¦‚æœViteä»£ç†ä»ç„¶æ— æ³•æ­£ç¡®è½¬å‘Authorizationå¤´ï¼Œè€ƒè™‘ï¼š

#### æ–¹æ¡ˆAï¼šnginxä»£ç†
åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨nginxä½œä¸ºåå‘ä»£ç†ï¼š
```nginx
location /api/ {
    proxy_pass http://localhost:5000/;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
```

#### æ–¹æ¡ˆBï¼šåç«¯CORS + ç›´æ¥è®¿é—®
ä¿®æ”¹åç«¯CORSé…ç½®ï¼Œå…è®¸å‰ç«¯ç›´æ¥è®¿é—®åç«¯APIï¼š
```python
CORS(flask_app, origins=['http://localhost:5173'], supports_credentials=True)
```

#### æ–¹æ¡ˆCï¼šç¯å¢ƒå˜é‡åˆ‡æ¢
æ ¹æ®ç¯å¢ƒåŠ¨æ€åˆ‡æ¢API baseURLï¼š
```typescript
const baseUrl = process.env.NODE_ENV === 'development' 
  ? 'http://localhost:5000/api/v1'  // ç›´æ¥è®¿é—®åç«¯
  : '/api/v1';  // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä»£ç†
```

## ğŸ’¡ å…³é”®ç»éªŒæ•™è®­

1. **Viteä»£ç†headerè½¬å‘é—®é¢˜**: è¿™æ˜¯ä¸€ä¸ªå¸¸è§ä½†éšè”½çš„é—®é¢˜ï¼Œéœ€è¦æ˜ç¡®é…ç½®headerè½¬å‘
2. **è°ƒè¯•æ–¹æ³•è®º**: å¿…é¡»ä»å‰ç«¯â†’ä»£ç†â†’åç«¯å®Œæ•´é“¾è·¯åˆ†æï¼Œä¸èƒ½åªçœ‹å•ä¸€ç¯èŠ‚
3. **fetchBaseQueryå±€é™æ€§**: RTK Queryçš„fetchBaseQueryåœ¨æŸäº›åœºæ™¯ä¸‹å¯èƒ½ä¸å¦‚è‡ªå®šä¹‰fetchå¯æ§
4. **Authorizationå¤´å¤§å°å†™æ•æ„Ÿ**: ä¸åŒç¯å¢ƒå¯¹headerå¤§å°å†™å¤„ç†å¯èƒ½ä¸åŒ

## ğŸš€ é¢„æœŸæˆåŠŸæŒ‡æ ‡

ä¿®å¤æˆåŠŸåï¼Œç³»ç»Ÿåº”æ»¡è¶³ï¼š
- âœ… ä¼ä¸šç®¡ç†é¡µé¢å®Œå…¨æ­£å¸¸å·¥ä½œ
- âœ… æ‰€æœ‰å¤æ‚å‚æ•°APIè¯·æ±‚æˆåŠŸ(200çŠ¶æ€)
- âœ… Networké¢æ¿æ˜¾ç¤ºå®Œæ•´Authorizationå¤´
- âœ… åç«¯æ¥æ”¶åˆ°æ­£ç¡®çš„è®¤è¯ä¿¡æ¯
- âœ… å‰åç«¯è”è°ƒæµ‹è¯•å®Œå…¨é€šè¿‡

---
**è°ƒè¯•æ—¶é—´**: 2025-09-09 21:30 (ä¸‹ç­å‰)
**è´Ÿè´£äºº**: Claude Code Assistant
**ä¸‹æ¬¡ç»§ç»­**: é‡å¯å‰ç«¯éªŒè¯æœ€æ–°ä»£ç†é…ç½®
**ç½®ä¿¡åº¦**: é«˜ - é—®é¢˜å®šä½å‡†ç¡®ï¼Œä¿®å¤æ–¹æ¡ˆé’ˆå¯¹æ€§å¼º
**å¤‡é€‰æ–¹æ¡ˆ**: å·²å‡†å¤‡nginxä»£ç†ç­‰åå¤‡æ–¹æ¡ˆ