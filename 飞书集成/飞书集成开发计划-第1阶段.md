# 飞书登录集成开发计划 - 第1阶段：环境搭建与基础集成

## 📋 阶段概述

**目标**：搭建本地开发环境，完成数据库设计，实现飞书API基础连接
**预估时间**：3-5天
**优先级**：最高
**依赖**：无

## 🎯 阶段目标

- [x] 搭建完整的本地测试环境
- [x] 完成数据库schema设计和迁移
- [x] 实现飞书API基础连接测试
- [x] 验证OAuth2授权流程
- [x] 建立代码规范和项目结构

## 📝 详细任务清单

### 任务1：本地开发环境搭建 (1天)

#### 1.1 注册飞书开放平台应用
```bash
# 步骤：
1. 访问 https://open.feishu.cn/
2. 使用飞书账号登录
3. 创建企业自建应用
   - 应用名称：Pigeon Web Test
   - 应用类型：企业自建应用
   - 应用描述：本地开发测试
4. 配置应用权限：
   - 获取用户基本信息
   - 获取用户邮箱信息
   - 获取用户头像信息
5. 记录应用凭据
```

**预期产出**：
- App ID: `cli_xxxxxxxxxx`
- App Secret: `xxxxxxxxxx`
- Encrypt Key: `xxxxxxxxxx`
- Verification Token: `xxxxxxxxxx`

#### 1.2 配置内网穿透
```bash
# 安装ngrok
brew install ngrok

# 启动Flask应用（假设5000端口）
cd /Users/yukun-admin/projects/pigeon/pigeon_web
python run.py

# 新终端启动ngrok
ngrok http 5000

# 获取公网地址：https://abc123.ngrok.io
```

**配置飞书应用回调**：
- 重定向URL: `https://abc123.ngrok.io/auth/feishu/callback`
- 安全域名: `abc123.ngrok.io`

#### 1.3 环境配置文件
创建 `.env.local`：
```bash
# Flask配置
FLASK_ENV=development
FLASK_DEBUG=True

# 飞书应用配置
FEISHU_APP_ID=cli_xxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxx
FEISHU_ENCRYPT_KEY=xxxxxxxxxx
FEISHU_VERIFICATION_TOKEN=xxxxxxxxxx

# 开发测试配置
FEISHU_AUTO_CREATE_USER=true
FEISHU_DEFAULT_ROLES=user
FEISHU_ALLOWED_DOMAINS=
FEISHU_USE_MOCK=false

# 数据库配置
DATABASE_URL=postgresql://username:password@localhost/pigeon_web_dev

# Redis配置
REDIS_URL=redis://localhost:6379/1
```

**✅ 阶段测试1：环境验证**
```python
# scripts/test_environment.py
import os
import psycopg2
import redis
from dotenv import load_dotenv

def test_environment():
    load_dotenv('.env.local')

    # 测试环境变量
    required_vars = [
        'FEISHU_APP_ID', 'FEISHU_APP_SECRET',
        'DATABASE_URL', 'REDIS_URL'
    ]

    missing_vars = [var for var in required_vars if not os.getenv(var)]

    if missing_vars:
        print(f"❌ 缺少环境变量: {missing_vars}")
        return False

    # 测试数据库连接
    try:
        conn = psycopg2.connect(os.getenv('DATABASE_URL'))
        conn.close()
        print("✅ 数据库连接成功")
    except Exception as e:
        print(f"❌ 数据库连接失败: {e}")
        return False

    # 测试Redis连接
    try:
        r = redis.from_url(os.getenv('REDIS_URL'))
        r.ping()
        print("✅ Redis连接成功")
    except Exception as e:
        print(f"❌ Redis连接失败: {e}")
        return False

    print("✅ 环境配置验证通过")
    return True

if __name__ == "__main__":
    test_environment()
```

**验收标准**：
- [ ] 所有环境变量配置正确
- [ ] 数据库连接成功
- [ ] Redis连接成功
- [ ] ngrok公网地址可访问
- [ ] 飞书应用配置无误

---

### 任务2：数据库Schema设计与迁移 (1天)

#### 2.1 创建数据库迁移文件
```bash
# 生成迁移文件
cd /Users/yukun-admin/projects/pigeon/pigeon_web
flask db init  # 如果还没有migrations目录
flask db revision -m "add_feishu_authentication_support"
```

#### 2.2 编写迁移脚本
创建 `migrations/versions/xxx_add_feishu_authentication_support.py`：

```python
"""Add Feishu authentication support

Revision ID: add_feishu_auth
Revises: [previous_revision]
Create Date: 2025-09-19

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers
revision = 'add_feishu_auth'
down_revision = '[previous_revision]'  # 替换为实际的前一个版本
branch_labels = None
depends_on = None

def upgrade():
    # 扩展admin_users表
    op.add_column('admin_users', sa.Column('feishu_user_id', sa.String(64), nullable=True))
    op.add_column('admin_users', sa.Column('feishu_union_id', sa.String(64), nullable=True))
    op.add_column('admin_users', sa.Column('feishu_open_id', sa.String(64), nullable=True))
    op.add_column('admin_users', sa.Column('auth_provider', sa.String(20), nullable=False, server_default='local'))
    op.add_column('admin_users', sa.Column('feishu_avatar_url', sa.String(500), nullable=True))
    op.add_column('admin_users', sa.Column('last_sync_at', sa.DateTime(), nullable=True))
    op.add_column('admin_users', sa.Column('sync_enabled', sa.Boolean(), nullable=True, server_default='true'))

    # 添加约束
    op.create_check_constraint(
        'chk_auth_provider',
        'admin_users',
        "auth_provider IN ('local', 'feishu', 'mixed')"
    )

    # 添加唯一约束
    op.create_unique_constraint('uq_admin_users_feishu_user_id', 'admin_users', ['feishu_user_id'])

    # 添加索引
    op.create_index('idx_admin_users_feishu_user_id', 'admin_users', ['feishu_user_id'])
    op.create_index('idx_admin_users_auth_provider', 'admin_users', ['auth_provider'])

    # 创建飞书应用配置表
    op.create_table(
        'feishu_app_configs',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('app_name', sa.String(100), nullable=False),
        sa.Column('app_id', sa.String(64), nullable=False),
        sa.Column('app_secret', sa.String(255), nullable=False),
        sa.Column('encrypt_key', sa.String(255), nullable=True),
        sa.Column('verification_token', sa.String(255), nullable=True),
        sa.Column('is_active', sa.Boolean(), nullable=True, server_default='true'),
        sa.Column('auto_create_user', sa.Boolean(), nullable=True, server_default='false'),
        sa.Column('default_role_ids', postgresql.ARRAY(sa.Integer()), nullable=True),
        sa.Column('allowed_domains', postgresql.ARRAY(sa.Text()), nullable=True),
        sa.Column('webhook_url', sa.String(500), nullable=True),
        sa.Column('created_at', sa.DateTime(), nullable=True, server_default=sa.text('CURRENT_TIMESTAMP')),
        sa.Column('updated_at', sa.DateTime(), nullable=True, server_default=sa.text('CURRENT_TIMESTAMP')),
        sa.PrimaryKeyConstraint('id')
    )

    op.create_unique_constraint('uq_feishu_app_configs_app_name', 'feishu_app_configs', ['app_name'])
    op.create_unique_constraint('uq_feishu_app_configs_app_id', 'feishu_app_configs', ['app_id'])

def downgrade():
    # 删除飞书配置表
    op.drop_table('feishu_app_configs')

    # 删除admin_users表的飞书字段
    op.drop_constraint('chk_auth_provider', 'admin_users')
    op.drop_constraint('uq_admin_users_feishu_user_id', 'admin_users')
    op.drop_index('idx_admin_users_feishu_user_id', 'admin_users')
    op.drop_index('idx_admin_users_auth_provider', 'admin_users')

    op.drop_column('admin_users', 'sync_enabled')
    op.drop_column('admin_users', 'last_sync_at')
    op.drop_column('admin_users', 'feishu_avatar_url')
    op.drop_column('admin_users', 'auth_provider')
    op.drop_column('admin_users', 'feishu_open_id')
    op.drop_column('admin_users', 'feishu_union_id')
    op.drop_column('admin_users', 'feishu_user_id')
```

#### 2.3 运行数据库迁移
```bash
# 执行迁移
flask db upgrade

# 验证迁移
flask db current
flask db history
```

#### 2.4 插入测试配置数据
```python
# scripts/init_feishu_config.py
from app import create_app
from app.extensions import db
from app.models.feishu.config import FeishuAppConfig
import os

def init_feishu_config():
    app = create_app()
    with app.app_context():
        # 检查是否已存在配置
        existing_config = FeishuAppConfig.query.filter_by(app_name='default').first()

        if not existing_config:
            config = FeishuAppConfig(
                app_name='default',
                app_id=os.getenv('FEISHU_APP_ID'),
                app_secret=os.getenv('FEISHU_APP_SECRET'),
                encrypt_key=os.getenv('FEISHU_ENCRYPT_KEY'),
                verification_token=os.getenv('FEISHU_VERIFICATION_TOKEN'),
                is_active=True,
                auto_create_user=True,
                default_role_ids=[],  # 将根据实际角色ID填写
                allowed_domains=[]
            )

            db.session.add(config)
            db.session.commit()
            print("✅ 飞书配置初始化成功")
        else:
            print("ℹ️ 飞书配置已存在")

if __name__ == "__main__":
    init_feishu_config()
```

**✅ 阶段测试2：数据库验证**
```python
# scripts/test_database_schema.py
from app import create_app
from app.extensions import db
from app.models.user.admin import AdminUser
from app.models.feishu.config import FeishuAppConfig

def test_database_schema():
    app = create_app()
    with app.app_context():
        try:
            # 测试admin_users表扩展字段
            user_columns = db.inspect(db.engine).get_columns('admin_users')
            feishu_columns = [col['name'] for col in user_columns if 'feishu' in col['name'] or col['name'] in ['auth_provider', 'last_sync_at', 'sync_enabled']]

            expected_columns = ['feishu_user_id', 'feishu_union_id', 'feishu_open_id', 'auth_provider', 'feishu_avatar_url', 'last_sync_at', 'sync_enabled']

            missing_columns = set(expected_columns) - set(feishu_columns)
            if missing_columns:
                print(f"❌ admin_users表缺少字段: {missing_columns}")
                return False
            else:
                print("✅ admin_users表字段扩展成功")

            # 测试飞书配置表
            config_tables = db.inspect(db.engine).get_table_names()
            if 'feishu_app_configs' not in config_tables:
                print("❌ feishu_app_configs表不存在")
                return False
            else:
                print("✅ feishu_app_configs表创建成功")

            # 测试模型查询
            config_count = FeishuAppConfig.query.count()
            print(f"ℹ️ 飞书配置数量: {config_count}")

            # 测试创建测试用户
            test_user = AdminUser(
                username='feishu_test_user',
                email='test@feishu.local',
                full_name='飞书测试用户',
                password_hash='test_hash',
                feishu_user_id='test_feishu_123',
                auth_provider='feishu'
            )

            db.session.add(test_user)
            db.session.commit()

            # 查询验证
            found_user = AdminUser.query.filter_by(feishu_user_id='test_feishu_123').first()
            if found_user:
                print("✅ 飞书用户创建和查询成功")
                # 清理测试数据
                db.session.delete(found_user)
                db.session.commit()
            else:
                print("❌ 飞书用户查询失败")
                return False

            print("✅ 数据库Schema验证通过")
            return True

        except Exception as e:
            print(f"❌ 数据库测试失败: {e}")
            return False

if __name__ == "__main__":
    test_database_schema()
```

**验收标准**：
- [ ] 数据库迁移成功执行
- [ ] admin_users表新增字段正确
- [ ] feishu_app_configs表创建成功
- [ ] 索引和约束正确创建
- [ ] 测试数据插入和查询正常

---

### 任务3：飞书API基础连接测试 (1天)

#### 3.1 创建飞书API测试工具
```python
# scripts/test_feishu_api.py
import os
import requests
import json
from dotenv import load_dotenv

load_dotenv('.env.local')

class FeishuAPITester:
    def __init__(self):
        self.app_id = os.getenv('FEISHU_APP_ID')
        self.app_secret = os.getenv('FEISHU_APP_SECRET')
        self.base_url = "https://open.feishu.cn/open-apis"

    def test_app_access_token(self):
        """测试获取应用访问令牌"""
        print("=== 测试应用访问令牌 ===")

        url = f"{self.base_url}/auth/v3/app_access_token/internal"
        data = {
            'app_id': self.app_id,
            'app_secret': self.app_secret
        }

        try:
            response = requests.post(url, json=data, timeout=10)
            result = response.json()

            print(f"状态码: {response.status_code}")
            print(f"响应: {json.dumps(result, indent=2, ensure_ascii=False)}")

            if result.get('code') == 0:
                print("✅ 应用令牌获取成功!")
                return result.get('app_access_token')
            else:
                print("❌ 应用令牌获取失败!")
                return None

        except Exception as e:
            print(f"❌ 请求异常: {e}")
            return None

    def test_authorization_url(self, redirect_uri):
        """测试生成授权URL"""
        print("=== 测试授权URL ===")

        params = {
            'app_id': self.app_id,
            'redirect_uri': redirect_uri,
            'response_type': 'code',
            'scope': 'user:read'
        }

        query_string = '&'.join([f"{k}={v}" for k, v in params.items()])
        auth_url = f"https://open.feishu.cn/open-apis/authen/v1/index?{query_string}"

        print(f"授权地址: {auth_url}")
        print("请在浏览器中打开此地址进行测试")
        return auth_url

    def test_user_token_exchange(self, app_token, code):
        """测试授权码换用户令牌"""
        print("=== 测试授权码换令牌 ===")

        url = f"{self.base_url}/authen/v1/access_token"
        headers = {
            'Authorization': f'Bearer {app_token}',
            'Content-Type': 'application/json'
        }
        data = {
            'grant_type': 'authorization_code',
            'code': code
        }

        try:
            response = requests.post(url, json=data, headers=headers, timeout=10)
            result = response.json()

            print(f"状态码: {response.status_code}")
            print(f"响应: {json.dumps(result, indent=2, ensure_ascii=False)}")

            if result.get('code') == 0:
                print("✅ 用户令牌获取成功!")
                return result.get('data')
            else:
                print("❌ 用户令牌获取失败!")
                return None

        except Exception as e:
            print(f"❌ 请求异常: {e}")
            return None

    def test_user_info(self, user_token):
        """测试获取用户信息"""
        print("=== 测试获取用户信息 ===")

        url = f"{self.base_url}/authen/v1/user_info"
        headers = {
            'Authorization': f'Bearer {user_token}'
        }

        try:
            response = requests.get(url, headers=headers, timeout=10)
            result = response.json()

            print(f"状态码: {response.status_code}")
            print(f"响应: {json.dumps(result, indent=2, ensure_ascii=False)}")

            if result.get('code') == 0:
                print("✅ 用户信息获取成功!")
                return result.get('data')
            else:
                print("❌ 用户信息获取失败!")
                return None

        except Exception as e:
            print(f"❌ 请求异常: {e}")
            return None

def main():
    tester = FeishuAPITester()

    # 1. 测试应用令牌
    app_token = tester.test_app_access_token()

    if app_token:
        # 2. 生成授权URL
        redirect_uri = "https://abc123.ngrok.io/auth/feishu/callback"  # 替换为实际ngrok地址
        auth_url = tester.test_authorization_url(redirect_uri)

        print("\n=== 手动测试步骤 ===")
        print("1. 确保ngrok正在运行")
        print("2. 复制上面的授权地址到浏览器")
        print("3. 完成飞书授权")
        print("4. 从回调URL中获取code参数")
        print("5. 运行: python scripts/test_feishu_api.py --code=获取到的code")

        # 如果提供了code参数，继续测试
        import sys
        for arg in sys.argv[1:]:
            if arg.startswith('--code='):
                code = arg.split('=', 1)[1]
                print(f"\n=== 使用授权码: {code[:10]}... ===")

                # 3. 测试授权码换令牌
                user_token_data = tester.test_user_token_exchange(app_token, code)

                if user_token_data:
                    # 4. 测试获取用户信息
                    user_info = tester.test_user_info(user_token_data['access_token'])

                    if user_info:
                        print("🎉 完整的飞书API流程测试成功!")
                        return True

    return False

if __name__ == "__main__":
    success = main()
    if success:
        exit(0)
    else:
        exit(1)
```

#### 3.2 创建Mock飞书服务器（备用方案）
```python
# scripts/mock_feishu_server.py
from flask import Flask, request, jsonify
import uuid
import time

app = Flask(__name__)

@app.route('/open-apis/auth/v3/app_access_token/internal', methods=['POST'])
def mock_app_token():
    """模拟获取应用访问令牌"""
    data = request.get_json()

    # 简单验证
    if not data or not data.get('app_id') or not data.get('app_secret'):
        return jsonify({
            'code': 99991661,
            'msg': 'app_id or app_secret is invalid'
        }), 400

    return jsonify({
        'code': 0,
        'msg': 'success',
        'app_access_token': f'mock_app_token_{int(time.time())}',
        'expire': 7200
    })

@app.route('/open-apis/authen/v1/access_token', methods=['POST'])
def mock_user_token():
    """模拟获取用户访问令牌"""
    auth_header = request.headers.get('Authorization')
    if not auth_header or not auth_header.startswith('Bearer '):
        return jsonify({
            'code': 99991661,
            'msg': 'invalid app_access_token'
        }), 401

    data = request.get_json()
    if not data or not data.get('code'):
        return jsonify({
            'code': 99991661,
            'msg': 'invalid authorization code'
        }), 400

    return jsonify({
        'code': 0,
        'msg': 'success',
        'data': {
            'access_token': f'mock_user_token_{int(time.time())}',
            'refresh_token': f'mock_refresh_token_{int(time.time())}',
            'expires_in': 7200,
            'refresh_expires_in': 86400,
            'token_type': 'Bearer',
            'scope': 'user:read'
        }
    })

@app.route('/open-apis/authen/v1/user_info', methods=['GET'])
def mock_user_info():
    """模拟获取用户信息"""
    auth_header = request.headers.get('Authorization')
    if not auth_header or not auth_header.startswith('Bearer '):
        return jsonify({
            'code': 99991661,
            'msg': 'invalid user_access_token'
        }), 401

    return jsonify({
        'code': 0,
        'msg': 'success',
        'data': {
            'user_id': f'mock_user_{int(time.time())}',
            'union_id': f'mock_union_{int(time.time())}',
            'open_id': f'mock_open_{int(time.time())}',
            'name': '测试用户',
            'en_name': 'Test User',
            'email': 'test@example.com',
            'avatar_url': 'https://example.com/avatar.jpg',
            'mobile': '+86-138****8888'
        }
    })

@app.route('/health', methods=['GET'])
def health():
    """健康检查"""
    return jsonify({'status': 'ok', 'service': 'mock-feishu-api'})

if __name__ == '__main__':
    print("🎭 启动飞书API模拟服务器...")
    print("📡 监听端口: 8080")
    print("🔗 健康检查: http://localhost:8080/health")
    app.run(host='0.0.0.0', port=8080, debug=True)
```

**✅ 阶段测试3：API连接验证**
```bash
# 运行API测试
python scripts/test_feishu_api.py

# 如果真实API不可用，启动Mock服务器测试
python scripts/mock_feishu_server.py

# 在新终端测试Mock API
curl -X POST http://localhost:8080/open-apis/auth/v3/app_access_token/internal \
  -H "Content-Type: application/json" \
  -d '{"app_id":"test_app","app_secret":"test_secret"}'
```

**验收标准**：
- [ ] 能成功获取飞书应用访问令牌
- [ ] 能生成正确的授权URL
- [ ] 授权流程能正确重定向
- [ ] Mock服务器能正常响应（备用方案）

---

### 任务4：项目结构调整与代码规范 (0.5天)

#### 4.1 创建飞书相关目录结构
```bash
# 创建目录结构
cd /Users/yukun-admin/projects/pigeon/pigeon_web

mkdir -p app/api/v1/feishu_auth/{route,schema}
mkdir -p app/services/feishu/{service,utils}
mkdir -p app/models/feishu
mkdir -p tests/feishu/{unit,integration}
mkdir -p scripts/feishu

# 创建__init__.py文件
touch app/api/v1/feishu_auth/__init__.py
touch app/api/v1/feishu_auth/route/__init__.py
touch app/api/v1/feishu_auth/schema/__init__.py
touch app/services/feishu/__init__.py
touch app/services/feishu/service/__init__.py
touch app/services/feishu/utils/__init__.py
touch app/models/feishu/__init__.py
touch tests/feishu/__init__.py
touch tests/feishu/unit/__init__.py
touch tests/feishu/integration/__init__.py
```

#### 4.2 创建飞书配置模型
```python
# app/models/feishu/config.py
from sqlalchemy import Column, Integer, String, Boolean, DateTime, Text
from sqlalchemy.dialects.postgresql import ARRAY
from app.extensions import db
from app.models.base.mixins import TimestampMixin

class FeishuAppConfig(db.Model, TimestampMixin):
    """飞书应用配置模型"""

    __tablename__ = 'feishu_app_configs'

    id = Column(Integer, primary_key=True)
    app_name = Column(String(100), unique=True, nullable=False)
    app_id = Column(String(64), unique=True, nullable=False)
    app_secret = Column(String(255), nullable=False)
    encrypt_key = Column(String(255), nullable=True)
    verification_token = Column(String(255), nullable=True)
    is_active = Column(Boolean, default=True)
    auto_create_user = Column(Boolean, default=False)
    default_role_ids = Column(ARRAY(Integer), nullable=True)
    allowed_domains = Column(ARRAY(Text), nullable=True)
    webhook_url = Column(String(500), nullable=True)

    def to_dict(self) -> dict:
        """转换为字典"""
        return {
            'id': self.id,
            'app_name': self.app_name,
            'app_id': self.app_id,
            'is_active': self.is_active,
            'auto_create_user': self.auto_create_user,
            'default_role_ids': self.default_role_ids,
            'allowed_domains': self.allowed_domains,
            'webhook_url': self.webhook_url
        }

    def to_safe_dict(self) -> dict:
        """转换为安全字典（不包含敏感信息）"""
        safe_dict = self.to_dict()
        # 移除敏感信息
        safe_dict.pop('app_secret', None)
        safe_dict.pop('encrypt_key', None)
        safe_dict.pop('verification_token', None)
        return safe_dict

    def __repr__(self):
        return f'<FeishuAppConfig {self.app_name}>'
```

#### 4.3 扩展AdminUser模型
```python
# app/models/user/admin.py - 添加到现有模型中

# 在AdminUser类中添加新字段和方法
class AdminUser(db.Model, TimestampMixin):
    # ... 现有字段 ...

    # 新增飞书相关字段
    feishu_user_id = Column(String(64), unique=True, nullable=True)
    feishu_union_id = Column(String(64), nullable=True)
    feishu_open_id = Column(String(64), nullable=True)
    auth_provider = Column(String(20), default='local', nullable=False)
    feishu_avatar_url = Column(String(500), nullable=True)
    last_sync_at = Column(DateTime, nullable=True)
    sync_enabled = Column(Boolean, default=True)

    def is_feishu_user(self) -> bool:
        """检查是否为飞书用户"""
        return self.auth_provider in ('feishu', 'mixed') and self.feishu_user_id is not None

    def can_login_with_password(self) -> bool:
        """检查是否可以使用密码登录"""
        return self.auth_provider in ('local', 'mixed') and self.password_hash

    def can_login_with_feishu(self) -> bool:
        """检查是否可以使用飞书登录"""
        return self.auth_provider in ('feishu', 'mixed') and self.feishu_user_id

    def get_display_avatar(self) -> str:
        """获取显示头像URL"""
        return self.feishu_avatar_url or '/static/images/default-avatar.png'

    def to_dict_with_feishu(self) -> dict:
        """转换为包含飞书信息的字典"""
        base_dict = self.to_dict() if hasattr(self, 'to_dict') else {}
        base_dict.update({
            'feishu_user_id': self.feishu_user_id,
            'auth_provider': self.auth_provider,
            'feishu_avatar_url': self.feishu_avatar_url,
            'last_sync_at': self.last_sync_at.isoformat() if self.last_sync_at else None,
            'can_login_with_password': self.can_login_with_password(),
            'can_login_with_feishu': self.can_login_with_feishu(),
            'display_avatar': self.get_display_avatar()
        })
        return base_dict
```

**✅ 阶段测试4：代码结构验证**
```python
# scripts/test_project_structure.py
import os
from importlib import import_module

def test_project_structure():
    """测试项目结构是否正确"""
    base_path = "/Users/yukun-admin/projects/pigeon/pigeon_web"

    # 测试目录结构
    required_dirs = [
        "app/api/v1/feishu_auth/route",
        "app/api/v1/feishu_auth/schema",
        "app/services/feishu/service",
        "app/models/feishu",
        "tests/feishu/unit",
        "tests/feishu/integration"
    ]

    missing_dirs = []
    for dir_path in required_dirs:
        full_path = os.path.join(base_path, dir_path)
        if not os.path.exists(full_path):
            missing_dirs.append(dir_path)

    if missing_dirs:
        print(f"❌ 缺少目录: {missing_dirs}")
        return False

    # 测试模型导入
    try:
        from app.models.feishu.config import FeishuAppConfig
        from app.models.user.admin import AdminUser

        # 测试新方法
        dummy_user = AdminUser()
        dummy_user.auth_provider = 'feishu'
        dummy_user.feishu_user_id = 'test123'

        assert dummy_user.is_feishu_user() == True
        assert dummy_user.can_login_with_feishu() == True

        print("✅ 模型扩展验证成功")

    except Exception as e:
        print(f"❌ 模型导入失败: {e}")
        return False

    print("✅ 项目结构验证通过")
    return True

if __name__ == "__main__":
    test_project_structure()
```

**验收标准**：
- [ ] 目录结构创建正确
- [ ] 模型文件创建和扩展完成
- [ ] 新增方法功能正常
- [ ] 导入路径正确

---

## 🏁 第1阶段完成检查表

### 环境配置 ✅
- [ ] 飞书开放平台应用创建完成
- [ ] ngrok内网穿透配置成功
- [ ] 本地环境变量配置正确
- [ ] 数据库和Redis连接正常

### 数据库设计 ✅
- [ ] 数据库迁移脚本编写完成
- [ ] 迁移执行成功
- [ ] 新增表和字段验证通过
- [ ] 测试数据插入正常

### API连接 ✅
- [ ] 飞书API基础连接测试通过
- [ ] OAuth2授权流程验证完成
- [ ] Mock服务器备用方案可用
- [ ] API响应格式确认正确

### 代码结构 ✅
- [ ] 项目目录结构创建完成
- [ ] 模型文件扩展完成
- [ ] 新增方法测试通过
- [ ] 代码规范符合要求

## 🎯 下一阶段预告

**第2阶段：核心飞书认证服务实现**
- FeishuAuthService核心服务开发
- OAuth2完整流程实现
- 用户查找和创建逻辑
- 令牌管理和缓存策略
- 完整的单元测试覆盖

**预估时间**：4-6天
**主要产出**：完整可用的飞书认证后端服务

---

**第1阶段完成标志**：所有测试脚本运行通过，环境配置验证成功，为下一阶段开发做好准备。