# é£ä¹¦ç™»å½•é›†æˆå¼€å‘è®¡åˆ’ - ç¬¬1é˜¶æ®µï¼šç¯å¢ƒæ­å»ºä¸åŸºç¡€é›†æˆ

## ğŸ“‹ é˜¶æ®µæ¦‚è¿°

**ç›®æ ‡**ï¼šæ­å»ºæœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œå®Œæˆæ•°æ®åº“è®¾è®¡ï¼Œå®ç°é£ä¹¦APIåŸºç¡€è¿æ¥
**é¢„ä¼°æ—¶é—´**ï¼š3-5å¤©
**ä¼˜å…ˆçº§**ï¼šæœ€é«˜
**ä¾èµ–**ï¼šæ— 

## ğŸ¯ é˜¶æ®µç›®æ ‡

- [x] æ­å»ºå®Œæ•´çš„æœ¬åœ°æµ‹è¯•ç¯å¢ƒ
- [x] å®Œæˆæ•°æ®åº“schemaè®¾è®¡å’Œè¿ç§»
- [x] å®ç°é£ä¹¦APIåŸºç¡€è¿æ¥æµ‹è¯•
- [x] éªŒè¯OAuth2æˆæƒæµç¨‹
- [x] å»ºç«‹ä»£ç è§„èŒƒå’Œé¡¹ç›®ç»“æ„

## ğŸ“ è¯¦ç»†ä»»åŠ¡æ¸…å•

### ä»»åŠ¡1ï¼šæœ¬åœ°å¼€å‘ç¯å¢ƒæ­å»º (1å¤©)

#### 1.1 æ³¨å†Œé£ä¹¦å¼€æ”¾å¹³å°åº”ç”¨
```bash
# æ­¥éª¤ï¼š
1. è®¿é—® https://open.feishu.cn/
2. ä½¿ç”¨é£ä¹¦è´¦å·ç™»å½•
3. åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨
   - åº”ç”¨åç§°ï¼šPigeon Web Test
   - åº”ç”¨ç±»å‹ï¼šä¼ä¸šè‡ªå»ºåº”ç”¨
   - åº”ç”¨æè¿°ï¼šæœ¬åœ°å¼€å‘æµ‹è¯•
4. é…ç½®åº”ç”¨æƒé™ï¼š
   - è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
   - è·å–ç”¨æˆ·é‚®ç®±ä¿¡æ¯
   - è·å–ç”¨æˆ·å¤´åƒä¿¡æ¯
5. è®°å½•åº”ç”¨å‡­æ®
```

**é¢„æœŸäº§å‡º**ï¼š
- App ID: `cli_xxxxxxxxxx`
- App Secret: `xxxxxxxxxx`
- Encrypt Key: `xxxxxxxxxx`
- Verification Token: `xxxxxxxxxx`

#### 1.2 é…ç½®å†…ç½‘ç©¿é€
```bash
# å®‰è£…ngrok
brew install ngrok

# å¯åŠ¨Flaskåº”ç”¨ï¼ˆå‡è®¾5000ç«¯å£ï¼‰
cd /Users/yukun-admin/projects/pigeon/pigeon_web
python run.py

# æ–°ç»ˆç«¯å¯åŠ¨ngrok
ngrok http 5000

# è·å–å…¬ç½‘åœ°å€ï¼šhttps://abc123.ngrok.io
```

**é…ç½®é£ä¹¦åº”ç”¨å›è°ƒ**ï¼š
- é‡å®šå‘URL: `https://abc123.ngrok.io/auth/feishu/callback`
- å®‰å…¨åŸŸå: `abc123.ngrok.io`

#### 1.3 ç¯å¢ƒé…ç½®æ–‡ä»¶
åˆ›å»º `.env.local`ï¼š
```bash
# Flaské…ç½®
FLASK_ENV=development
FLASK_DEBUG=True

# é£ä¹¦åº”ç”¨é…ç½®
FEISHU_APP_ID=cli_xxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxx
FEISHU_ENCRYPT_KEY=xxxxxxxxxx
FEISHU_VERIFICATION_TOKEN=xxxxxxxxxx

# å¼€å‘æµ‹è¯•é…ç½®
FEISHU_AUTO_CREATE_USER=true
FEISHU_DEFAULT_ROLES=user
FEISHU_ALLOWED_DOMAINS=
FEISHU_USE_MOCK=false

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://username:password@localhost/pigeon_web_dev

# Redisé…ç½®
REDIS_URL=redis://localhost:6379/1
```

**âœ… é˜¶æ®µæµ‹è¯•1ï¼šç¯å¢ƒéªŒè¯**
```python
# scripts/test_environment.py
import os
import psycopg2
import redis
from dotenv import load_dotenv

def test_environment():
    load_dotenv('.env.local')

    # æµ‹è¯•ç¯å¢ƒå˜é‡
    required_vars = [
        'FEISHU_APP_ID', 'FEISHU_APP_SECRET',
        'DATABASE_URL', 'REDIS_URL'
    ]

    missing_vars = [var for var in required_vars if not os.getenv(var)]

    if missing_vars:
        print(f"âŒ ç¼ºå°‘ç¯å¢ƒå˜é‡: {missing_vars}")
        return False

    # æµ‹è¯•æ•°æ®åº“è¿æ¥
    try:
        conn = psycopg2.connect(os.getenv('DATABASE_URL'))
        conn.close()
        print("âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ")
    except Exception as e:
        print(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        return False

    # æµ‹è¯•Redisè¿æ¥
    try:
        r = redis.from_url(os.getenv('REDIS_URL'))
        r.ping()
        print("âœ… Redisè¿æ¥æˆåŠŸ")
    except Exception as e:
        print(f"âŒ Redisè¿æ¥å¤±è´¥: {e}")
        return False

    print("âœ… ç¯å¢ƒé…ç½®éªŒè¯é€šè¿‡")
    return True

if __name__ == "__main__":
    test_environment()
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ‰€æœ‰ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] æ•°æ®åº“è¿æ¥æˆåŠŸ
- [ ] Redisè¿æ¥æˆåŠŸ
- [ ] ngrokå…¬ç½‘åœ°å€å¯è®¿é—®
- [ ] é£ä¹¦åº”ç”¨é…ç½®æ— è¯¯

---

### ä»»åŠ¡2ï¼šæ•°æ®åº“Schemaè®¾è®¡ä¸è¿ç§» (1å¤©)

#### 2.1 åˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶
```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
cd /Users/yukun-admin/projects/pigeon/pigeon_web
flask db init  # å¦‚æœè¿˜æ²¡æœ‰migrationsç›®å½•
flask db revision -m "add_feishu_authentication_support"
```

#### 2.2 ç¼–å†™è¿ç§»è„šæœ¬
åˆ›å»º `migrations/versions/xxx_add_feishu_authentication_support.py`ï¼š

```python
"""Add Feishu authentication support

Revision ID: add_feishu_auth
Revises: [previous_revision]
Create Date: 2025-09-19

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers
revision = 'add_feishu_auth'
down_revision = '[previous_revision]'  # æ›¿æ¢ä¸ºå®é™…çš„å‰ä¸€ä¸ªç‰ˆæœ¬
branch_labels = None
depends_on = None

def upgrade():
    # æ‰©å±•admin_usersè¡¨
    op.add_column('admin_users', sa.Column('feishu_user_id', sa.String(64), nullable=True))
    op.add_column('admin_users', sa.Column('feishu_union_id', sa.String(64), nullable=True))
    op.add_column('admin_users', sa.Column('feishu_open_id', sa.String(64), nullable=True))
    op.add_column('admin_users', sa.Column('auth_provider', sa.String(20), nullable=False, server_default='local'))
    op.add_column('admin_users', sa.Column('feishu_avatar_url', sa.String(500), nullable=True))
    op.add_column('admin_users', sa.Column('last_sync_at', sa.DateTime(), nullable=True))
    op.add_column('admin_users', sa.Column('sync_enabled', sa.Boolean(), nullable=True, server_default='true'))

    # æ·»åŠ çº¦æŸ
    op.create_check_constraint(
        'chk_auth_provider',
        'admin_users',
        "auth_provider IN ('local', 'feishu', 'mixed')"
    )

    # æ·»åŠ å”¯ä¸€çº¦æŸ
    op.create_unique_constraint('uq_admin_users_feishu_user_id', 'admin_users', ['feishu_user_id'])

    # æ·»åŠ ç´¢å¼•
    op.create_index('idx_admin_users_feishu_user_id', 'admin_users', ['feishu_user_id'])
    op.create_index('idx_admin_users_auth_provider', 'admin_users', ['auth_provider'])

    # åˆ›å»ºé£ä¹¦åº”ç”¨é…ç½®è¡¨
    op.create_table(
        'feishu_app_configs',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('app_name', sa.String(100), nullable=False),
        sa.Column('app_id', sa.String(64), nullable=False),
        sa.Column('app_secret', sa.String(255), nullable=False),
        sa.Column('encrypt_key', sa.String(255), nullable=True),
        sa.Column('verification_token', sa.String(255), nullable=True),
        sa.Column('is_active', sa.Boolean(), nullable=True, server_default='true'),
        sa.Column('auto_create_user', sa.Boolean(), nullable=True, server_default='false'),
        sa.Column('default_role_ids', postgresql.ARRAY(sa.Integer()), nullable=True),
        sa.Column('allowed_domains', postgresql.ARRAY(sa.Text()), nullable=True),
        sa.Column('webhook_url', sa.String(500), nullable=True),
        sa.Column('created_at', sa.DateTime(), nullable=True, server_default=sa.text('CURRENT_TIMESTAMP')),
        sa.Column('updated_at', sa.DateTime(), nullable=True, server_default=sa.text('CURRENT_TIMESTAMP')),
        sa.PrimaryKeyConstraint('id')
    )

    op.create_unique_constraint('uq_feishu_app_configs_app_name', 'feishu_app_configs', ['app_name'])
    op.create_unique_constraint('uq_feishu_app_configs_app_id', 'feishu_app_configs', ['app_id'])

def downgrade():
    # åˆ é™¤é£ä¹¦é…ç½®è¡¨
    op.drop_table('feishu_app_configs')

    # åˆ é™¤admin_usersè¡¨çš„é£ä¹¦å­—æ®µ
    op.drop_constraint('chk_auth_provider', 'admin_users')
    op.drop_constraint('uq_admin_users_feishu_user_id', 'admin_users')
    op.drop_index('idx_admin_users_feishu_user_id', 'admin_users')
    op.drop_index('idx_admin_users_auth_provider', 'admin_users')

    op.drop_column('admin_users', 'sync_enabled')
    op.drop_column('admin_users', 'last_sync_at')
    op.drop_column('admin_users', 'feishu_avatar_url')
    op.drop_column('admin_users', 'auth_provider')
    op.drop_column('admin_users', 'feishu_open_id')
    op.drop_column('admin_users', 'feishu_union_id')
    op.drop_column('admin_users', 'feishu_user_id')
```

#### 2.3 è¿è¡Œæ•°æ®åº“è¿ç§»
```bash
# æ‰§è¡Œè¿ç§»
flask db upgrade

# éªŒè¯è¿ç§»
flask db current
flask db history
```

#### 2.4 æ’å…¥æµ‹è¯•é…ç½®æ•°æ®
```python
# scripts/init_feishu_config.py
from app import create_app
from app.extensions import db
from app.models.feishu.config import FeishuAppConfig
import os

def init_feishu_config():
    app = create_app()
    with app.app_context():
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨é…ç½®
        existing_config = FeishuAppConfig.query.filter_by(app_name='default').first()

        if not existing_config:
            config = FeishuAppConfig(
                app_name='default',
                app_id=os.getenv('FEISHU_APP_ID'),
                app_secret=os.getenv('FEISHU_APP_SECRET'),
                encrypt_key=os.getenv('FEISHU_ENCRYPT_KEY'),
                verification_token=os.getenv('FEISHU_VERIFICATION_TOKEN'),
                is_active=True,
                auto_create_user=True,
                default_role_ids=[],  # å°†æ ¹æ®å®é™…è§’è‰²IDå¡«å†™
                allowed_domains=[]
            )

            db.session.add(config)
            db.session.commit()
            print("âœ… é£ä¹¦é…ç½®åˆå§‹åŒ–æˆåŠŸ")
        else:
            print("â„¹ï¸ é£ä¹¦é…ç½®å·²å­˜åœ¨")

if __name__ == "__main__":
    init_feishu_config()
```

**âœ… é˜¶æ®µæµ‹è¯•2ï¼šæ•°æ®åº“éªŒè¯**
```python
# scripts/test_database_schema.py
from app import create_app
from app.extensions import db
from app.models.user.admin import AdminUser
from app.models.feishu.config import FeishuAppConfig

def test_database_schema():
    app = create_app()
    with app.app_context():
        try:
            # æµ‹è¯•admin_usersè¡¨æ‰©å±•å­—æ®µ
            user_columns = db.inspect(db.engine).get_columns('admin_users')
            feishu_columns = [col['name'] for col in user_columns if 'feishu' in col['name'] or col['name'] in ['auth_provider', 'last_sync_at', 'sync_enabled']]

            expected_columns = ['feishu_user_id', 'feishu_union_id', 'feishu_open_id', 'auth_provider', 'feishu_avatar_url', 'last_sync_at', 'sync_enabled']

            missing_columns = set(expected_columns) - set(feishu_columns)
            if missing_columns:
                print(f"âŒ admin_usersè¡¨ç¼ºå°‘å­—æ®µ: {missing_columns}")
                return False
            else:
                print("âœ… admin_usersè¡¨å­—æ®µæ‰©å±•æˆåŠŸ")

            # æµ‹è¯•é£ä¹¦é…ç½®è¡¨
            config_tables = db.inspect(db.engine).get_table_names()
            if 'feishu_app_configs' not in config_tables:
                print("âŒ feishu_app_configsè¡¨ä¸å­˜åœ¨")
                return False
            else:
                print("âœ… feishu_app_configsè¡¨åˆ›å»ºæˆåŠŸ")

            # æµ‹è¯•æ¨¡å‹æŸ¥è¯¢
            config_count = FeishuAppConfig.query.count()
            print(f"â„¹ï¸ é£ä¹¦é…ç½®æ•°é‡: {config_count}")

            # æµ‹è¯•åˆ›å»ºæµ‹è¯•ç”¨æˆ·
            test_user = AdminUser(
                username='feishu_test_user',
                email='test@feishu.local',
                full_name='é£ä¹¦æµ‹è¯•ç”¨æˆ·',
                password_hash='test_hash',
                feishu_user_id='test_feishu_123',
                auth_provider='feishu'
            )

            db.session.add(test_user)
            db.session.commit()

            # æŸ¥è¯¢éªŒè¯
            found_user = AdminUser.query.filter_by(feishu_user_id='test_feishu_123').first()
            if found_user:
                print("âœ… é£ä¹¦ç”¨æˆ·åˆ›å»ºå’ŒæŸ¥è¯¢æˆåŠŸ")
                # æ¸…ç†æµ‹è¯•æ•°æ®
                db.session.delete(found_user)
                db.session.commit()
            else:
                print("âŒ é£ä¹¦ç”¨æˆ·æŸ¥è¯¢å¤±è´¥")
                return False

            print("âœ… æ•°æ®åº“SchemaéªŒè¯é€šè¿‡")
            return True

        except Exception as e:
            print(f"âŒ æ•°æ®åº“æµ‹è¯•å¤±è´¥: {e}")
            return False

if __name__ == "__main__":
    test_database_schema()
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸæ‰§è¡Œ
- [ ] admin_usersè¡¨æ–°å¢å­—æ®µæ­£ç¡®
- [ ] feishu_app_configsè¡¨åˆ›å»ºæˆåŠŸ
- [ ] ç´¢å¼•å’Œçº¦æŸæ­£ç¡®åˆ›å»º
- [ ] æµ‹è¯•æ•°æ®æ’å…¥å’ŒæŸ¥è¯¢æ­£å¸¸

---

### ä»»åŠ¡3ï¼šé£ä¹¦APIåŸºç¡€è¿æ¥æµ‹è¯• (1å¤©)

#### 3.1 åˆ›å»ºé£ä¹¦APIæµ‹è¯•å·¥å…·
```python
# scripts/test_feishu_api.py
import os
import requests
import json
from dotenv import load_dotenv

load_dotenv('.env.local')

class FeishuAPITester:
    def __init__(self):
        self.app_id = os.getenv('FEISHU_APP_ID')
        self.app_secret = os.getenv('FEISHU_APP_SECRET')
        self.base_url = "https://open.feishu.cn/open-apis"

    def test_app_access_token(self):
        """æµ‹è¯•è·å–åº”ç”¨è®¿é—®ä»¤ç‰Œ"""
        print("=== æµ‹è¯•åº”ç”¨è®¿é—®ä»¤ç‰Œ ===")

        url = f"{self.base_url}/auth/v3/app_access_token/internal"
        data = {
            'app_id': self.app_id,
            'app_secret': self.app_secret
        }

        try:
            response = requests.post(url, json=data, timeout=10)
            result = response.json()

            print(f"çŠ¶æ€ç : {response.status_code}")
            print(f"å“åº”: {json.dumps(result, indent=2, ensure_ascii=False)}")

            if result.get('code') == 0:
                print("âœ… åº”ç”¨ä»¤ç‰Œè·å–æˆåŠŸ!")
                return result.get('app_access_token')
            else:
                print("âŒ åº”ç”¨ä»¤ç‰Œè·å–å¤±è´¥!")
                return None

        except Exception as e:
            print(f"âŒ è¯·æ±‚å¼‚å¸¸: {e}")
            return None

    def test_authorization_url(self, redirect_uri):
        """æµ‹è¯•ç”ŸæˆæˆæƒURL"""
        print("=== æµ‹è¯•æˆæƒURL ===")

        params = {
            'app_id': self.app_id,
            'redirect_uri': redirect_uri,
            'response_type': 'code',
            'scope': 'user:read'
        }

        query_string = '&'.join([f"{k}={v}" for k, v in params.items()])
        auth_url = f"https://open.feishu.cn/open-apis/authen/v1/index?{query_string}"

        print(f"æˆæƒåœ°å€: {auth_url}")
        print("è¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤åœ°å€è¿›è¡Œæµ‹è¯•")
        return auth_url

    def test_user_token_exchange(self, app_token, code):
        """æµ‹è¯•æˆæƒç æ¢ç”¨æˆ·ä»¤ç‰Œ"""
        print("=== æµ‹è¯•æˆæƒç æ¢ä»¤ç‰Œ ===")

        url = f"{self.base_url}/authen/v1/access_token"
        headers = {
            'Authorization': f'Bearer {app_token}',
            'Content-Type': 'application/json'
        }
        data = {
            'grant_type': 'authorization_code',
            'code': code
        }

        try:
            response = requests.post(url, json=data, headers=headers, timeout=10)
            result = response.json()

            print(f"çŠ¶æ€ç : {response.status_code}")
            print(f"å“åº”: {json.dumps(result, indent=2, ensure_ascii=False)}")

            if result.get('code') == 0:
                print("âœ… ç”¨æˆ·ä»¤ç‰Œè·å–æˆåŠŸ!")
                return result.get('data')
            else:
                print("âŒ ç”¨æˆ·ä»¤ç‰Œè·å–å¤±è´¥!")
                return None

        except Exception as e:
            print(f"âŒ è¯·æ±‚å¼‚å¸¸: {e}")
            return None

    def test_user_info(self, user_token):
        """æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯"""
        print("=== æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯ ===")

        url = f"{self.base_url}/authen/v1/user_info"
        headers = {
            'Authorization': f'Bearer {user_token}'
        }

        try:
            response = requests.get(url, headers=headers, timeout=10)
            result = response.json()

            print(f"çŠ¶æ€ç : {response.status_code}")
            print(f"å“åº”: {json.dumps(result, indent=2, ensure_ascii=False)}")

            if result.get('code') == 0:
                print("âœ… ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ!")
                return result.get('data')
            else:
                print("âŒ ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥!")
                return None

        except Exception as e:
            print(f"âŒ è¯·æ±‚å¼‚å¸¸: {e}")
            return None

def main():
    tester = FeishuAPITester()

    # 1. æµ‹è¯•åº”ç”¨ä»¤ç‰Œ
    app_token = tester.test_app_access_token()

    if app_token:
        # 2. ç”ŸæˆæˆæƒURL
        redirect_uri = "https://abc123.ngrok.io/auth/feishu/callback"  # æ›¿æ¢ä¸ºå®é™…ngrokåœ°å€
        auth_url = tester.test_authorization_url(redirect_uri)

        print("\n=== æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤ ===")
        print("1. ç¡®ä¿ngrokæ­£åœ¨è¿è¡Œ")
        print("2. å¤åˆ¶ä¸Šé¢çš„æˆæƒåœ°å€åˆ°æµè§ˆå™¨")
        print("3. å®Œæˆé£ä¹¦æˆæƒ")
        print("4. ä»å›è°ƒURLä¸­è·å–codeå‚æ•°")
        print("5. è¿è¡Œ: python scripts/test_feishu_api.py --code=è·å–åˆ°çš„code")

        # å¦‚æœæä¾›äº†codeå‚æ•°ï¼Œç»§ç»­æµ‹è¯•
        import sys
        for arg in sys.argv[1:]:
            if arg.startswith('--code='):
                code = arg.split('=', 1)[1]
                print(f"\n=== ä½¿ç”¨æˆæƒç : {code[:10]}... ===")

                # 3. æµ‹è¯•æˆæƒç æ¢ä»¤ç‰Œ
                user_token_data = tester.test_user_token_exchange(app_token, code)

                if user_token_data:
                    # 4. æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯
                    user_info = tester.test_user_info(user_token_data['access_token'])

                    if user_info:
                        print("ğŸ‰ å®Œæ•´çš„é£ä¹¦APIæµç¨‹æµ‹è¯•æˆåŠŸ!")
                        return True

    return False

if __name__ == "__main__":
    success = main()
    if success:
        exit(0)
    else:
        exit(1)
```

#### 3.2 åˆ›å»ºMocké£ä¹¦æœåŠ¡å™¨ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
```python
# scripts/mock_feishu_server.py
from flask import Flask, request, jsonify
import uuid
import time

app = Flask(__name__)

@app.route('/open-apis/auth/v3/app_access_token/internal', methods=['POST'])
def mock_app_token():
    """æ¨¡æ‹Ÿè·å–åº”ç”¨è®¿é—®ä»¤ç‰Œ"""
    data = request.get_json()

    # ç®€å•éªŒè¯
    if not data or not data.get('app_id') or not data.get('app_secret'):
        return jsonify({
            'code': 99991661,
            'msg': 'app_id or app_secret is invalid'
        }), 400

    return jsonify({
        'code': 0,
        'msg': 'success',
        'app_access_token': f'mock_app_token_{int(time.time())}',
        'expire': 7200
    })

@app.route('/open-apis/authen/v1/access_token', methods=['POST'])
def mock_user_token():
    """æ¨¡æ‹Ÿè·å–ç”¨æˆ·è®¿é—®ä»¤ç‰Œ"""
    auth_header = request.headers.get('Authorization')
    if not auth_header or not auth_header.startswith('Bearer '):
        return jsonify({
            'code': 99991661,
            'msg': 'invalid app_access_token'
        }), 401

    data = request.get_json()
    if not data or not data.get('code'):
        return jsonify({
            'code': 99991661,
            'msg': 'invalid authorization code'
        }), 400

    return jsonify({
        'code': 0,
        'msg': 'success',
        'data': {
            'access_token': f'mock_user_token_{int(time.time())}',
            'refresh_token': f'mock_refresh_token_{int(time.time())}',
            'expires_in': 7200,
            'refresh_expires_in': 86400,
            'token_type': 'Bearer',
            'scope': 'user:read'
        }
    })

@app.route('/open-apis/authen/v1/user_info', methods=['GET'])
def mock_user_info():
    """æ¨¡æ‹Ÿè·å–ç”¨æˆ·ä¿¡æ¯"""
    auth_header = request.headers.get('Authorization')
    if not auth_header or not auth_header.startswith('Bearer '):
        return jsonify({
            'code': 99991661,
            'msg': 'invalid user_access_token'
        }), 401

    return jsonify({
        'code': 0,
        'msg': 'success',
        'data': {
            'user_id': f'mock_user_{int(time.time())}',
            'union_id': f'mock_union_{int(time.time())}',
            'open_id': f'mock_open_{int(time.time())}',
            'name': 'æµ‹è¯•ç”¨æˆ·',
            'en_name': 'Test User',
            'email': 'test@example.com',
            'avatar_url': 'https://example.com/avatar.jpg',
            'mobile': '+86-138****8888'
        }
    })

@app.route('/health', methods=['GET'])
def health():
    """å¥åº·æ£€æŸ¥"""
    return jsonify({'status': 'ok', 'service': 'mock-feishu-api'})

if __name__ == '__main__':
    print("ğŸ­ å¯åŠ¨é£ä¹¦APIæ¨¡æ‹ŸæœåŠ¡å™¨...")
    print("ğŸ“¡ ç›‘å¬ç«¯å£: 8080")
    print("ğŸ”— å¥åº·æ£€æŸ¥: http://localhost:8080/health")
    app.run(host='0.0.0.0', port=8080, debug=True)
```

**âœ… é˜¶æ®µæµ‹è¯•3ï¼šAPIè¿æ¥éªŒè¯**
```bash
# è¿è¡ŒAPIæµ‹è¯•
python scripts/test_feishu_api.py

# å¦‚æœçœŸå®APIä¸å¯ç”¨ï¼Œå¯åŠ¨MockæœåŠ¡å™¨æµ‹è¯•
python scripts/mock_feishu_server.py

# åœ¨æ–°ç»ˆç«¯æµ‹è¯•Mock API
curl -X POST http://localhost:8080/open-apis/auth/v3/app_access_token/internal \
  -H "Content-Type: application/json" \
  -d '{"app_id":"test_app","app_secret":"test_secret"}'
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] èƒ½æˆåŠŸè·å–é£ä¹¦åº”ç”¨è®¿é—®ä»¤ç‰Œ
- [ ] èƒ½ç”Ÿæˆæ­£ç¡®çš„æˆæƒURL
- [ ] æˆæƒæµç¨‹èƒ½æ­£ç¡®é‡å®šå‘
- [ ] MockæœåŠ¡å™¨èƒ½æ­£å¸¸å“åº”ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

---

### ä»»åŠ¡4ï¼šé¡¹ç›®ç»“æ„è°ƒæ•´ä¸ä»£ç è§„èŒƒ (0.5å¤©)

#### 4.1 åˆ›å»ºé£ä¹¦ç›¸å…³ç›®å½•ç»“æ„
```bash
# åˆ›å»ºç›®å½•ç»“æ„
cd /Users/yukun-admin/projects/pigeon/pigeon_web

mkdir -p app/api/v1/feishu_auth/{route,schema}
mkdir -p app/services/feishu/{service,utils}
mkdir -p app/models/feishu
mkdir -p tests/feishu/{unit,integration}
mkdir -p scripts/feishu

# åˆ›å»º__init__.pyæ–‡ä»¶
touch app/api/v1/feishu_auth/__init__.py
touch app/api/v1/feishu_auth/route/__init__.py
touch app/api/v1/feishu_auth/schema/__init__.py
touch app/services/feishu/__init__.py
touch app/services/feishu/service/__init__.py
touch app/services/feishu/utils/__init__.py
touch app/models/feishu/__init__.py
touch tests/feishu/__init__.py
touch tests/feishu/unit/__init__.py
touch tests/feishu/integration/__init__.py
```

#### 4.2 åˆ›å»ºé£ä¹¦é…ç½®æ¨¡å‹
```python
# app/models/feishu/config.py
from sqlalchemy import Column, Integer, String, Boolean, DateTime, Text
from sqlalchemy.dialects.postgresql import ARRAY
from app.extensions import db
from app.models.base.mixins import TimestampMixin

class FeishuAppConfig(db.Model, TimestampMixin):
    """é£ä¹¦åº”ç”¨é…ç½®æ¨¡å‹"""

    __tablename__ = 'feishu_app_configs'

    id = Column(Integer, primary_key=True)
    app_name = Column(String(100), unique=True, nullable=False)
    app_id = Column(String(64), unique=True, nullable=False)
    app_secret = Column(String(255), nullable=False)
    encrypt_key = Column(String(255), nullable=True)
    verification_token = Column(String(255), nullable=True)
    is_active = Column(Boolean, default=True)
    auto_create_user = Column(Boolean, default=False)
    default_role_ids = Column(ARRAY(Integer), nullable=True)
    allowed_domains = Column(ARRAY(Text), nullable=True)
    webhook_url = Column(String(500), nullable=True)

    def to_dict(self) -> dict:
        """è½¬æ¢ä¸ºå­—å…¸"""
        return {
            'id': self.id,
            'app_name': self.app_name,
            'app_id': self.app_id,
            'is_active': self.is_active,
            'auto_create_user': self.auto_create_user,
            'default_role_ids': self.default_role_ids,
            'allowed_domains': self.allowed_domains,
            'webhook_url': self.webhook_url
        }

    def to_safe_dict(self) -> dict:
        """è½¬æ¢ä¸ºå®‰å…¨å­—å…¸ï¼ˆä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰"""
        safe_dict = self.to_dict()
        # ç§»é™¤æ•æ„Ÿä¿¡æ¯
        safe_dict.pop('app_secret', None)
        safe_dict.pop('encrypt_key', None)
        safe_dict.pop('verification_token', None)
        return safe_dict

    def __repr__(self):
        return f'<FeishuAppConfig {self.app_name}>'
```

#### 4.3 æ‰©å±•AdminUseræ¨¡å‹
```python
# app/models/user/admin.py - æ·»åŠ åˆ°ç°æœ‰æ¨¡å‹ä¸­

# åœ¨AdminUserç±»ä¸­æ·»åŠ æ–°å­—æ®µå’Œæ–¹æ³•
class AdminUser(db.Model, TimestampMixin):
    # ... ç°æœ‰å­—æ®µ ...

    # æ–°å¢é£ä¹¦ç›¸å…³å­—æ®µ
    feishu_user_id = Column(String(64), unique=True, nullable=True)
    feishu_union_id = Column(String(64), nullable=True)
    feishu_open_id = Column(String(64), nullable=True)
    auth_provider = Column(String(20), default='local', nullable=False)
    feishu_avatar_url = Column(String(500), nullable=True)
    last_sync_at = Column(DateTime, nullable=True)
    sync_enabled = Column(Boolean, default=True)

    def is_feishu_user(self) -> bool:
        """æ£€æŸ¥æ˜¯å¦ä¸ºé£ä¹¦ç”¨æˆ·"""
        return self.auth_provider in ('feishu', 'mixed') and self.feishu_user_id is not None

    def can_login_with_password(self) -> bool:
        """æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨å¯†ç ç™»å½•"""
        return self.auth_provider in ('local', 'mixed') and self.password_hash

    def can_login_with_feishu(self) -> bool:
        """æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨é£ä¹¦ç™»å½•"""
        return self.auth_provider in ('feishu', 'mixed') and self.feishu_user_id

    def get_display_avatar(self) -> str:
        """è·å–æ˜¾ç¤ºå¤´åƒURL"""
        return self.feishu_avatar_url or '/static/images/default-avatar.png'

    def to_dict_with_feishu(self) -> dict:
        """è½¬æ¢ä¸ºåŒ…å«é£ä¹¦ä¿¡æ¯çš„å­—å…¸"""
        base_dict = self.to_dict() if hasattr(self, 'to_dict') else {}
        base_dict.update({
            'feishu_user_id': self.feishu_user_id,
            'auth_provider': self.auth_provider,
            'feishu_avatar_url': self.feishu_avatar_url,
            'last_sync_at': self.last_sync_at.isoformat() if self.last_sync_at else None,
            'can_login_with_password': self.can_login_with_password(),
            'can_login_with_feishu': self.can_login_with_feishu(),
            'display_avatar': self.get_display_avatar()
        })
        return base_dict
```

**âœ… é˜¶æ®µæµ‹è¯•4ï¼šä»£ç ç»“æ„éªŒè¯**
```python
# scripts/test_project_structure.py
import os
from importlib import import_module

def test_project_structure():
    """æµ‹è¯•é¡¹ç›®ç»“æ„æ˜¯å¦æ­£ç¡®"""
    base_path = "/Users/yukun-admin/projects/pigeon/pigeon_web"

    # æµ‹è¯•ç›®å½•ç»“æ„
    required_dirs = [
        "app/api/v1/feishu_auth/route",
        "app/api/v1/feishu_auth/schema",
        "app/services/feishu/service",
        "app/models/feishu",
        "tests/feishu/unit",
        "tests/feishu/integration"
    ]

    missing_dirs = []
    for dir_path in required_dirs:
        full_path = os.path.join(base_path, dir_path)
        if not os.path.exists(full_path):
            missing_dirs.append(dir_path)

    if missing_dirs:
        print(f"âŒ ç¼ºå°‘ç›®å½•: {missing_dirs}")
        return False

    # æµ‹è¯•æ¨¡å‹å¯¼å…¥
    try:
        from app.models.feishu.config import FeishuAppConfig
        from app.models.user.admin import AdminUser

        # æµ‹è¯•æ–°æ–¹æ³•
        dummy_user = AdminUser()
        dummy_user.auth_provider = 'feishu'
        dummy_user.feishu_user_id = 'test123'

        assert dummy_user.is_feishu_user() == True
        assert dummy_user.can_login_with_feishu() == True

        print("âœ… æ¨¡å‹æ‰©å±•éªŒè¯æˆåŠŸ")

    except Exception as e:
        print(f"âŒ æ¨¡å‹å¯¼å…¥å¤±è´¥: {e}")
        return False

    print("âœ… é¡¹ç›®ç»“æ„éªŒè¯é€šè¿‡")
    return True

if __name__ == "__main__":
    test_project_structure()
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- [ ] ç›®å½•ç»“æ„åˆ›å»ºæ­£ç¡®
- [ ] æ¨¡å‹æ–‡ä»¶åˆ›å»ºå’Œæ‰©å±•å®Œæˆ
- [ ] æ–°å¢æ–¹æ³•åŠŸèƒ½æ­£å¸¸
- [ ] å¯¼å…¥è·¯å¾„æ­£ç¡®

---

## ğŸ ç¬¬1é˜¶æ®µå®Œæˆæ£€æŸ¥è¡¨

### ç¯å¢ƒé…ç½® âœ…
- [ ] é£ä¹¦å¼€æ”¾å¹³å°åº”ç”¨åˆ›å»ºå®Œæˆ
- [ ] ngrokå†…ç½‘ç©¿é€é…ç½®æˆåŠŸ
- [ ] æœ¬åœ°ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] æ•°æ®åº“å’ŒRedisè¿æ¥æ­£å¸¸

### æ•°æ®åº“è®¾è®¡ âœ…
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬ç¼–å†™å®Œæˆ
- [ ] è¿ç§»æ‰§è¡ŒæˆåŠŸ
- [ ] æ–°å¢è¡¨å’Œå­—æ®µéªŒè¯é€šè¿‡
- [ ] æµ‹è¯•æ•°æ®æ’å…¥æ­£å¸¸

### APIè¿æ¥ âœ…
- [ ] é£ä¹¦APIåŸºç¡€è¿æ¥æµ‹è¯•é€šè¿‡
- [ ] OAuth2æˆæƒæµç¨‹éªŒè¯å®Œæˆ
- [ ] MockæœåŠ¡å™¨å¤‡ç”¨æ–¹æ¡ˆå¯ç”¨
- [ ] APIå“åº”æ ¼å¼ç¡®è®¤æ­£ç¡®

### ä»£ç ç»“æ„ âœ…
- [ ] é¡¹ç›®ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ
- [ ] æ¨¡å‹æ–‡ä»¶æ‰©å±•å®Œæˆ
- [ ] æ–°å¢æ–¹æ³•æµ‹è¯•é€šè¿‡
- [ ] ä»£ç è§„èŒƒç¬¦åˆè¦æ±‚

## ğŸ¯ ä¸‹ä¸€é˜¶æ®µé¢„å‘Š

**ç¬¬2é˜¶æ®µï¼šæ ¸å¿ƒé£ä¹¦è®¤è¯æœåŠ¡å®ç°**
- FeishuAuthServiceæ ¸å¿ƒæœåŠ¡å¼€å‘
- OAuth2å®Œæ•´æµç¨‹å®ç°
- ç”¨æˆ·æŸ¥æ‰¾å’Œåˆ›å»ºé€»è¾‘
- ä»¤ç‰Œç®¡ç†å’Œç¼“å­˜ç­–ç•¥
- å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–

**é¢„ä¼°æ—¶é—´**ï¼š4-6å¤©
**ä¸»è¦äº§å‡º**ï¼šå®Œæ•´å¯ç”¨çš„é£ä¹¦è®¤è¯åç«¯æœåŠ¡

---

**ç¬¬1é˜¶æ®µå®Œæˆæ ‡å¿—**ï¼šæ‰€æœ‰æµ‹è¯•è„šæœ¬è¿è¡Œé€šè¿‡ï¼Œç¯å¢ƒé…ç½®éªŒè¯æˆåŠŸï¼Œä¸ºä¸‹ä¸€é˜¶æ®µå¼€å‘åšå¥½å‡†å¤‡ã€‚