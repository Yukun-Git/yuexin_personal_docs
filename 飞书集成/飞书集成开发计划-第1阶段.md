# 飞书登录集成开发计划 - 第1阶段：环境搭建与基础集成

## 📋 阶段概述

**目标**：搭建本地开发环境，完成数据库设计，实现飞书API基础连接
**预估时间**：3-5天
**优先级**：最高
**依赖**：无

## 🎯 阶段目标

- [x] 搭建完整的本地测试环境
- [x] 完成数据库schema设计和迁移
- [x] 实现飞书API基础连接测试
- [x] 验证OAuth2授权流程
- [x] 建立代码规范和项目结构

## 📝 详细任务清单

### 任务1：本地开发环境搭建 (1天)

#### 1.1 注册飞书开放平台应用
```bash
# 步骤：
1. 访问 https://open.feishu.cn/
2. 使用飞书账号登录
3. 创建企业自建应用
   - 应用名称：Pigeon Web Test
   - 应用类型：企业自建应用
   - 应用描述：本地开发测试
4. 配置应用权限：
   - 获取用户基本信息
   - 获取用户邮箱信息
   - 获取用户头像信息
5. 记录应用凭据
```

**预期产出**：
- App ID: `cli_xxxxxxxxxx`
- App Secret: `xxxxxxxxxx`
- Encrypt Key: `xxxxxxxxxx`
- Verification Token: `xxxxxxxxxx`

#### 1.2 配置内网穿透
```bash
# 安装ngrok
brew install ngrok

# 启动Flask应用（假设5000端口）
cd /Users/yukun-admin/projects/pigeon/pigeon_web
python run.py

# 新终端启动ngrok
ngrok http 5000

# 获取公网地址：https://abc123.ngrok.io
```

**配置飞书应用回调**：
- 重定向URL: `https://abc123.ngrok.io/auth/feishu/callback`
- 安全域名: `abc123.ngrok.io`

------- now ------------

#### 1.3 环境配置文件
创建 `.env.local`：
```bash
# Flask配置
FLASK_ENV=development
FLASK_DEBUG=True

# 飞书应用配置
FEISHU_APP_ID=cli_xxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxx
FEISHU_ENCRYPT_KEY=xxxxxxxxxx
FEISHU_VERIFICATION_TOKEN=xxxxxxxxxx

# 开发测试配置
FEISHU_AUTO_CREATE_USER=true
FEISHU_DEFAULT_ROLES=user,guest
FEISHU_ALLOWED_DOMAINS=
FEISHU_USE_MOCK=false

# 数据库配置
DATABASE_URL=postgresql://username:password@localhost/pigeon_web_dev

# Redis配置
REDIS_URL=redis://localhost:6379/1
```

**✅ 阶段测试1：环境验证**
```python
# scripts/test_environment.py
import os
import psycopg2
import redis
from dotenv import load_dotenv

def test_environment():
    load_dotenv('.env.local')

    # 测试环境变量
    required_vars = [
        'FEISHU_APP_ID', 'FEISHU_APP_SECRET',
        'DATABASE_URL', 'REDIS_URL'
    ]

    missing_vars = [var for var in required_vars if not os.getenv(var)]

    if missing_vars:
        print(f"❌ 缺少环境变量: {missing_vars}")
        return False

    # 测试数据库连接
    try:
        conn = psycopg2.connect(os.getenv('DATABASE_URL'))
        conn.close()
        print("✅ 数据库连接成功")
    except Exception as e:
        print(f"❌ 数据库连接失败: {e}")
        return False

    # 测试Redis连接
    try:
        r = redis.from_url(os.getenv('REDIS_URL'))
        r.ping()
        print("✅ Redis连接成功")
    except Exception as e:
        print(f"❌ Redis连接失败: {e}")
        return False

    print("✅ 环境配置验证通过")
    return True

if __name__ == "__main__":
    test_environment()
```

**验收标准**：
- [ ] 所有环境变量配置正确
- [ ] 数据库连接成功
- [ ] Redis连接成功
- [ ] ngrok公网地址可访问
- [ ] 飞书应用配置无误

---

### 任务2：数据库Schema设计与实现 (1天)

#### 2.1 数据库架构设计说明

**设计原则**：采用**数据解耦**的架构设计，将飞书认证信息单独设计成独立表，而不是直接扩展 admin_users 表。

**架构优势**：
- ✅ **数据解耦**：飞书数据独立，不污染核心用户表
- ✅ **扩展性**：未来可支持微信、钉钉等其他第三方认证
- ✅ **性能优化**：按需关联，避免不必要的JOIN
- ✅ **维护性**：飞书功能变更不影响核心业务

**表结构设计**：
1. `admin_users` 表：仅添加 `auth_provider` 字段标识认证方式
2. `feishu_auth_users` 表：独立存储飞书认证信息和用户数据
3. `feishu_app_configs` 表：飞书应用配置管理
4. `feishu_tokens` 表：令牌缓存管理

#### 2.2 修改SQL初始化脚本
根据项目规范，直接修改数据库初始化脚本而不使用迁移：

```bash
# 工作目录
cd /Users/yukun-admin/projects/pigeon/pigeon_web
```

#### 2.3 创建数据库模块文件
在 `pigeon_web/sql/modules/` 目录下创建新的模块文件：

创建 `pigeon_web/sql/modules/feishu_auth.sql`：

```sql
-- Copyright(c) 2025
-- All rights reserved.
--
-- Author: yukun.xing <xingyukun@gmail.com>
-- Date:   2025/09/19
--
-- 飞书认证集成模块

-- 扩展admin_users表，仅添加认证提供方字段
ALTER TABLE admin_users ADD COLUMN IF NOT EXISTS auth_provider VARCHAR(20) DEFAULT 'local' NOT NULL;

-- 添加约束检查
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'chk_auth_provider') THEN
        ALTER TABLE admin_users ADD CONSTRAINT chk_auth_provider
            CHECK (auth_provider IN ('local', 'feishu', 'mixed'));
    END IF;
END $$;

-- 添加索引
CREATE INDEX IF NOT EXISTS idx_admin_users_auth_provider ON admin_users(auth_provider);

-- 添加注释
COMMENT ON COLUMN admin_users.auth_provider IS '认证提供方：local(本地), feishu(飞书), mixed(混合)';

-- 创建飞书认证用户表
CREATE TABLE IF NOT EXISTS feishu_auth_users (
    id SERIAL PRIMARY KEY,
    admin_user_id INTEGER NOT NULL REFERENCES admin_users(id) ON DELETE CASCADE,
    feishu_user_id VARCHAR(64) NOT NULL UNIQUE,
    feishu_union_id VARCHAR(64),
    feishu_open_id VARCHAR(64),
    feishu_name VARCHAR(100),
    feishu_en_name VARCHAR(100),
    feishu_email VARCHAR(100),
    feishu_mobile VARCHAR(20),
    feishu_avatar_url VARCHAR(500),
    feishu_department_ids TEXT[],  -- 部门ID数组
    last_sync_at TIMESTAMP,
    sync_enabled BOOLEAN DEFAULT TRUE,
    sync_errors TEXT,  -- 同步错误信息
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 添加索引优化查询
CREATE INDEX IF NOT EXISTS idx_feishu_auth_users_admin_user_id ON feishu_auth_users(admin_user_id);
CREATE INDEX IF NOT EXISTS idx_feishu_auth_users_feishu_user_id ON feishu_auth_users(feishu_user_id);
CREATE INDEX IF NOT EXISTS idx_feishu_auth_users_feishu_union_id ON feishu_auth_users(feishu_union_id);
CREATE INDEX IF NOT EXISTS idx_feishu_auth_users_sync_status ON feishu_auth_users(sync_enabled, last_sync_at);

-- 添加注释
COMMENT ON TABLE feishu_auth_users IS '飞书认证用户表';
COMMENT ON COLUMN feishu_auth_users.admin_user_id IS '关联的管理员用户ID';
COMMENT ON COLUMN feishu_auth_users.feishu_user_id IS '飞书用户ID';
COMMENT ON COLUMN feishu_auth_users.feishu_union_id IS '飞书Union ID';
COMMENT ON COLUMN feishu_auth_users.feishu_open_id IS '飞书Open ID';
COMMENT ON COLUMN feishu_auth_users.feishu_name IS '飞书用户姓名';
COMMENT ON COLUMN feishu_auth_users.feishu_en_name IS '飞书用户英文名';
COMMENT ON COLUMN feishu_auth_users.feishu_email IS '飞书用户邮箱';
COMMENT ON COLUMN feishu_auth_users.feishu_mobile IS '飞书用户手机号';
COMMENT ON COLUMN feishu_auth_users.feishu_avatar_url IS '飞书头像URL';
COMMENT ON COLUMN feishu_auth_users.feishu_department_ids IS '飞书部门ID数组';
COMMENT ON COLUMN feishu_auth_users.last_sync_at IS '最后同步时间';
COMMENT ON COLUMN feishu_auth_users.sync_enabled IS '是否启用同步';
COMMENT ON COLUMN feishu_auth_users.sync_errors IS '同步错误信息';

-- 创建飞书应用配置表
CREATE TABLE IF NOT EXISTS feishu_app_configs (
    id SERIAL PRIMARY KEY,
    app_name VARCHAR(100) NOT NULL UNIQUE,
    app_id VARCHAR(64) NOT NULL UNIQUE,
    app_secret VARCHAR(255) NOT NULL,
    encrypt_key VARCHAR(255),
    verification_token VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    auto_create_user BOOLEAN DEFAULT FALSE,
    default_role_codes TEXT[],  -- 存储角色代码而不是ID
    allowed_domains TEXT[],
    webhook_url VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE feishu_app_configs IS '飞书应用配置表';
COMMENT ON COLUMN feishu_app_configs.auto_create_user IS '是否自动创建用户';
COMMENT ON COLUMN feishu_app_configs.default_role_codes IS '默认分配角色代码数组';
COMMENT ON COLUMN feishu_app_configs.allowed_domains IS '允许的邮箱域名列表';

-- 创建飞书令牌缓存表（可选，主要使用Redis）
CREATE TABLE IF NOT EXISTS feishu_tokens (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES admin_users(id) ON DELETE CASCADE,
    app_id VARCHAR(64) NOT NULL,
    access_token_encrypted TEXT NOT NULL,  -- 加密存储的access token
    refresh_token_encrypted TEXT,          -- 加密存储的refresh token
    expires_at TIMESTAMP NOT NULL,
    refresh_expires_at TIMESTAMP,
    token_type VARCHAR(20) DEFAULT 'Bearer',
    scope VARCHAR(200),
    encryption_key_id VARCHAR(32) NOT NULL, -- 加密密钥ID，支持密钥轮换
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_feishu_tokens_user_app ON feishu_tokens(user_id, app_id);
CREATE INDEX IF NOT EXISTS idx_feishu_tokens_expires ON feishu_tokens(expires_at);

COMMENT ON TABLE feishu_tokens IS '飞书令牌缓存表';
COMMENT ON COLUMN feishu_tokens.access_token_encrypted IS '加密存储的访问令牌';
COMMENT ON COLUMN feishu_tokens.refresh_token_encrypted IS '加密存储的刷新令牌';
COMMENT ON COLUMN feishu_tokens.encryption_key_id IS '加密密钥ID';
```

#### 2.4 执行数据库Schema更新
```bash
# 执行SQL脚本
psql -h localhost -p 8668 -U yuexin -d pigeon_sms -f pigeon_web/sql/modules/feishu_auth.sql

# 验证表结构
psql -h localhost -p 8668 -U yuexin -d pigeon_sms -c "\d admin_users"
psql -h localhost -p 8668 -U yuexin -d pigeon_sms -c "\d feishu_auth_users"
psql -h localhost -p 8668 -U yuexin -d pigeon_sms -c "\d feishu_app_configs"
psql -h localhost -p 8668 -U yuexin -d pigeon_sms -c "\d feishu_tokens"
```

#### 2.5 更新Mock数据脚本
修改 `pigeon_web/sql/init_mock_data.sql`，添加飞书测试配置：

```sql
-- 添加飞书应用配置测试数据
INSERT INTO feishu_app_configs (
    app_name,
    app_id,
    app_secret,
    is_active,
    auto_create_user,
    default_role_codes,
    allowed_domains
) VALUES (
    'default',
    'cli_test_app_id',
    'test_app_secret',
    true,
    true,
    ARRAY['user', 'guest'],
    ARRAY['example.com', 'test.com']
) ON CONFLICT (app_name) DO NOTHING;

-- 添加飞书测试用户
INSERT INTO admin_users (
    username,
    email,
    full_name,
    password_hash,
    is_active,
    auth_provider
) VALUES (
    'feishu_test_user',
    'test@feishu.example.com',
    '飞书测试用户',
    '$2b$12$test_hash_for_feishu_user',
    true,
    'feishu'
) ON CONFLICT (username) DO NOTHING;

-- 添加飞书认证信息
INSERT INTO feishu_auth_users (
    admin_user_id,
    feishu_user_id,
    feishu_union_id,
    feishu_name,
    feishu_en_name,
    feishu_email,
    feishu_avatar_url,
    sync_enabled
) VALUES (
    (SELECT id FROM admin_users WHERE username = 'feishu_test_user'),
    'test_feishu_user_123',
    'test_union_id_456',
    '飞书测试用户',
    'Feishu Test User',
    'test@feishu.example.com',
    'https://example.com/avatar.jpg',
    true
) ON CONFLICT (feishu_user_id) DO NOTHING;
```

**✅ 阶段测试2：数据库验证**
```python
# scripts/test_database_schema.py
from app import create_app
from app.extensions import db
from app.models.user.admin import AdminUser
from app.models.feishu.config import FeishuAppConfig

def test_database_schema():
    app = create_app()
    with app.app_context():
        try:
            # 测试admin_users表扩展字段
            user_columns = db.inspect(db.engine).get_columns('admin_users')
            auth_columns = [col['name'] for col in user_columns if col['name'] == 'auth_provider']

            if 'auth_provider' not in auth_columns:
                print("❌ admin_users表缺少auth_provider字段")
                return False
            else:
                print("✅ admin_users表auth_provider字段扩展成功")

            # 测试飞书认证用户表
            auth_tables = db.inspect(db.engine).get_table_names()
            if 'feishu_auth_users' not in auth_tables:
                print("❌ feishu_auth_users表不存在")
                return False
            else:
                print("✅ feishu_auth_users表创建成功")

            # 测试飞书配置表
            config_tables = db.inspect(db.engine).get_table_names()
            if 'feishu_app_configs' not in config_tables:
                print("❌ feishu_app_configs表不存在")
                return False
            else:
                print("✅ feishu_app_configs表创建成功")

            # 测试模型查询
            config_count = FeishuAppConfig.query.count()
            print(f"ℹ️ 飞书配置数量: {config_count}")

            # 测试创建测试用户
            test_user = AdminUser(
                username='feishu_test_user_temp',
                email='test@feishu.local',
                full_name='飞书测试用户',
                password_hash='test_hash',
                auth_provider='feishu'
            )

            db.session.add(test_user)
            db.session.commit()

            # 创建飞书认证信息
            from app.models.feishu.auth_user import FeishuAuthUser
            feishu_auth = FeishuAuthUser(
                admin_user_id=test_user.id,
                feishu_user_id='test_feishu_123',
                feishu_name='飞书测试用户',
                feishu_email='test@feishu.local'
            )

            db.session.add(feishu_auth)
            db.session.commit()

            # 查询验证
            found_auth = FeishuAuthUser.query.filter_by(feishu_user_id='test_feishu_123').first()
            if found_auth and found_auth.admin_user_id == test_user.id:
                print("✅ 飞书认证用户创建和查询成功")
                # 清理测试数据
                db.session.delete(found_auth)
                db.session.delete(test_user)
                db.session.commit()
            else:
                print("❌ 飞书认证用户查询失败")
                return False

            print("✅ 数据库Schema验证通过")
            return True

        except Exception as e:
            print(f"❌ 数据库测试失败: {e}")
            return False

if __name__ == "__main__":
    test_database_schema()
```

**验收标准**：
- [ ] 数据库迁移成功执行
- [ ] admin_users表auth_provider字段添加正确
- [ ] feishu_auth_users表创建成功
- [ ] feishu_app_configs表创建成功
- [ ] 索引和约束正确创建
- [ ] 测试数据插入和查询正常

---

### 任务3：飞书API基础连接测试 (1天)

#### 3.1 创建飞书API测试工具
```python
# scripts/test_feishu_api.py
import os
import requests
import json
from dotenv import load_dotenv

load_dotenv('.env.local')

class FeishuAPITester:
    def __init__(self):
        self.app_id = os.getenv('FEISHU_APP_ID')
        self.app_secret = os.getenv('FEISHU_APP_SECRET')
        self.base_url = "https://open.feishu.cn/open-apis"

    def test_app_access_token(self):
        """测试获取应用访问令牌"""
        print("=== 测试应用访问令牌 ===")

        url = f"{self.base_url}/auth/v3/app_access_token/internal"
        data = {
            'app_id': self.app_id,
            'app_secret': self.app_secret
        }

        try:
            response = requests.post(url, json=data, timeout=10)
            result = response.json()

            print(f"状态码: {response.status_code}")
            print(f"响应: {json.dumps(result, indent=2, ensure_ascii=False)}")

            if result.get('code') == 0:
                print("✅ 应用令牌获取成功!")
                return result.get('app_access_token')
            else:
                print("❌ 应用令牌获取失败!")
                return None

        except Exception as e:
            print(f"❌ 请求异常: {e}")
            return None

    def test_authorization_url(self, redirect_uri):
        """测试生成授权URL"""
        print("=== 测试授权URL ===")

        params = {
            'app_id': self.app_id,
            'redirect_uri': redirect_uri,
            'response_type': 'code',
            'scope': 'user:read'
        }

        query_string = '&'.join([f"{k}={v}" for k, v in params.items()])
        auth_url = f"https://open.feishu.cn/open-apis/authen/v1/index?{query_string}"

        print(f"授权地址: {auth_url}")
        print("请在浏览器中打开此地址进行测试")
        return auth_url

    def test_user_token_exchange(self, app_token, code):
        """测试授权码换用户令牌"""
        print("=== 测试授权码换令牌 ===")

        url = f"{self.base_url}/authen/v1/access_token"
        headers = {
            'Authorization': f'Bearer {app_token}',
            'Content-Type': 'application/json'
        }
        data = {
            'grant_type': 'authorization_code',
            'code': code
        }

        try:
            response = requests.post(url, json=data, headers=headers, timeout=10)
            result = response.json()

            print(f"状态码: {response.status_code}")
            print(f"响应: {json.dumps(result, indent=2, ensure_ascii=False)}")

            if result.get('code') == 0:
                print("✅ 用户令牌获取成功!")
                return result.get('data')
            else:
                print("❌ 用户令牌获取失败!")
                return None

        except Exception as e:
            print(f"❌ 请求异常: {e}")
            return None

    def test_user_info(self, user_token):
        """测试获取用户信息"""
        print("=== 测试获取用户信息 ===")

        url = f"{self.base_url}/authen/v1/user_info"
        headers = {
            'Authorization': f'Bearer {user_token}'
        }

        try:
            response = requests.get(url, headers=headers, timeout=10)
            result = response.json()

            print(f"状态码: {response.status_code}")
            print(f"响应: {json.dumps(result, indent=2, ensure_ascii=False)}")

            if result.get('code') == 0:
                print("✅ 用户信息获取成功!")
                return result.get('data')
            else:
                print("❌ 用户信息获取失败!")
                return None

        except Exception as e:
            print(f"❌ 请求异常: {e}")
            return None

def main():
    tester = FeishuAPITester()

    # 1. 测试应用令牌
    app_token = tester.test_app_access_token()

    if app_token:
        # 2. 生成授权URL
        redirect_uri = "https://abc123.ngrok.io/auth/feishu/callback"  # 替换为实际ngrok地址
        auth_url = tester.test_authorization_url(redirect_uri)

        print("\n=== 手动测试步骤 ===")
        print("1. 确保ngrok正在运行")
        print("2. 复制上面的授权地址到浏览器")
        print("3. 完成飞书授权")
        print("4. 从回调URL中获取code参数")
        print("5. 运行: python scripts/test_feishu_api.py --code=获取到的code")

        # 如果提供了code参数，继续测试
        import sys
        for arg in sys.argv[1:]:
            if arg.startswith('--code='):
                code = arg.split('=', 1)[1]
                print(f"\n=== 使用授权码: {code[:10]}... ===")

                # 3. 测试授权码换令牌
                user_token_data = tester.test_user_token_exchange(app_token, code)

                if user_token_data:
                    # 4. 测试获取用户信息
                    user_info = tester.test_user_info(user_token_data['access_token'])

                    if user_info:
                        print("🎉 完整的飞书API流程测试成功!")
                        return True

    return False

if __name__ == "__main__":
    success = main()
    if success:
        exit(0)
    else:
        exit(1)
```

#### 3.2 创建Mock飞书服务器（备用方案）
```python
# scripts/mock_feishu_server.py
from flask import Flask, request, jsonify
import uuid
import time

app = Flask(__name__)

@app.route('/open-apis/auth/v3/app_access_token/internal', methods=['POST'])
def mock_app_token():
    """模拟获取应用访问令牌"""
    data = request.get_json()

    # 简单验证
    if not data or not data.get('app_id') or not data.get('app_secret'):
        return jsonify({
            'code': 99991661,
            'msg': 'app_id or app_secret is invalid'
        }), 400

    return jsonify({
        'code': 0,
        'msg': 'success',
        'app_access_token': f'mock_app_token_{int(time.time())}',
        'expire': 7200
    })

@app.route('/open-apis/authen/v1/access_token', methods=['POST'])
def mock_user_token():
    """模拟获取用户访问令牌"""
    auth_header = request.headers.get('Authorization')
    if not auth_header or not auth_header.startswith('Bearer '):
        return jsonify({
            'code': 99991661,
            'msg': 'invalid app_access_token'
        }), 401

    data = request.get_json()
    if not data or not data.get('code'):
        return jsonify({
            'code': 99991661,
            'msg': 'invalid authorization code'
        }), 400

    return jsonify({
        'code': 0,
        'msg': 'success',
        'data': {
            'access_token': f'mock_user_token_{int(time.time())}',
            'refresh_token': f'mock_refresh_token_{int(time.time())}',
            'expires_in': 7200,
            'refresh_expires_in': 86400,
            'token_type': 'Bearer',
            'scope': 'user:read'
        }
    })

@app.route('/open-apis/authen/v1/user_info', methods=['GET'])
def mock_user_info():
    """模拟获取用户信息"""
    auth_header = request.headers.get('Authorization')
    if not auth_header or not auth_header.startswith('Bearer '):
        return jsonify({
            'code': 99991661,
            'msg': 'invalid user_access_token'
        }), 401

    return jsonify({
        'code': 0,
        'msg': 'success',
        'data': {
            'user_id': f'mock_user_{int(time.time())}',
            'union_id': f'mock_union_{int(time.time())}',
            'open_id': f'mock_open_{int(time.time())}',
            'name': '测试用户',
            'en_name': 'Test User',
            'email': 'test@example.com',
            'avatar_url': 'https://example.com/avatar.jpg',
            'mobile': '+86-138****8888'
        }
    })

@app.route('/health', methods=['GET'])
def health():
    """健康检查"""
    return jsonify({'status': 'ok', 'service': 'mock-feishu-api'})

if __name__ == '__main__':
    print("🎭 启动飞书API模拟服务器...")
    print("📡 监听端口: 8080")
    print("🔗 健康检查: http://localhost:8080/health")
    app.run(host='0.0.0.0', port=8080, debug=True)
```

**✅ 阶段测试3：API连接验证**
```bash
# 运行API测试
python scripts/test_feishu_api.py

# 如果真实API不可用，启动Mock服务器测试
python scripts/mock_feishu_server.py

# 在新终端测试Mock API
curl -X POST http://localhost:8080/open-apis/auth/v3/app_access_token/internal \
  -H "Content-Type: application/json" \
  -d '{"app_id":"test_app","app_secret":"test_secret"}'
```

**验收标准**：
- [ ] 能成功获取飞书应用访问令牌
- [ ] 能生成正确的授权URL
- [ ] 授权流程能正确重定向
- [ ] Mock服务器能正常响应（备用方案）

---

### 任务4：项目结构调整与代码规范 (0.5天)

#### 4.1 创建飞书相关目录结构
```bash
# 创建目录结构
cd /Users/yukun-admin/projects/pigeon/pigeon_web

mkdir -p app/api/v1/feishu_auth/{route,schema}
mkdir -p app/services/feishu/{service,utils}
mkdir -p app/models/feishu
mkdir -p tests/feishu/{unit,integration}
mkdir -p scripts/feishu

# 创建__init__.py文件
touch app/api/v1/feishu_auth/__init__.py
touch app/api/v1/feishu_auth/route/__init__.py
touch app/api/v1/feishu_auth/schema/__init__.py
touch app/services/feishu/__init__.py
touch app/services/feishu/service/__init__.py
touch app/services/feishu/utils/__init__.py
touch app/models/feishu/__init__.py
touch tests/feishu/__init__.py
touch tests/feishu/unit/__init__.py
touch tests/feishu/integration/__init__.py
```

#### 4.2 创建飞书模型文件

**创建飞书配置模型**：
```python
# app/models/feishu/config.py
from sqlalchemy import Column, Integer, String, Boolean, DateTime, Text
from sqlalchemy.dialects.postgresql import ARRAY
from app.extensions import db
from app.models.base.mixins import TimestampMixin

class FeishuAppConfig(db.Model, TimestampMixin):
    """飞书应用配置模型"""

    __tablename__ = 'feishu_app_configs'

    id = Column(Integer, primary_key=True)
    app_name = Column(String(100), unique=True, nullable=False)
    app_id = Column(String(64), unique=True, nullable=False)
    app_secret = Column(String(255), nullable=False)
    encrypt_key = Column(String(255), nullable=True)
    verification_token = Column(String(255), nullable=True)
    is_active = Column(Boolean, default=True)
    auto_create_user = Column(Boolean, default=False)
    default_role_codes = Column(ARRAY(Text), nullable=True)
    allowed_domains = Column(ARRAY(Text), nullable=True)
    webhook_url = Column(String(500), nullable=True)

    def to_dict(self) -> dict:
        """转换为字典"""
        return {
            'id': self.id,
            'app_name': self.app_name,
            'app_id': self.app_id,
            'is_active': self.is_active,
            'auto_create_user': self.auto_create_user,
            'default_role_codes': self.default_role_codes,
            'allowed_domains': self.allowed_domains,
            'webhook_url': self.webhook_url
        }

    def to_safe_dict(self) -> dict:
        """转换为安全字典（不包含敏感信息）"""
        safe_dict = self.to_dict()
        # 移除敏感信息
        safe_dict.pop('app_secret', None)
        safe_dict.pop('encrypt_key', None)
        safe_dict.pop('verification_token', None)
        return safe_dict

    def __repr__(self):
        return f'<FeishuAppConfig {self.app_name}>'
```

**创建飞书认证用户模型**：
```python
# app/models/feishu/auth_user.py
from sqlalchemy import Column, Integer, String, Boolean, DateTime, Text, ForeignKey
from sqlalchemy.dialects.postgresql import ARRAY
from sqlalchemy.orm import relationship
from app.extensions import db
from app.models.base.mixins import TimestampMixin

class FeishuAuthUser(db.Model, TimestampMixin):
    """飞书认证用户模型"""

    __tablename__ = 'feishu_auth_users'

    id = Column(Integer, primary_key=True)
    admin_user_id = Column(Integer, ForeignKey('admin_users.id'), nullable=False)
    feishu_user_id = Column(String(64), unique=True, nullable=False)
    feishu_union_id = Column(String(64), nullable=True)
    feishu_open_id = Column(String(64), nullable=True)
    feishu_name = Column(String(100), nullable=True)
    feishu_en_name = Column(String(100), nullable=True)
    feishu_email = Column(String(100), nullable=True)
    feishu_mobile = Column(String(20), nullable=True)
    feishu_avatar_url = Column(String(500), nullable=True)
    feishu_department_ids = Column(ARRAY(Text), nullable=True)
    last_sync_at = Column(DateTime, nullable=True)
    sync_enabled = Column(Boolean, default=True)
    sync_errors = Column(Text, nullable=True)

    # 关联关系
    admin_user = relationship("AdminUser", back_populates="feishu_auth")

    def to_dict(self) -> dict:
        """转换为字典"""
        return {
            'id': self.id,
            'admin_user_id': self.admin_user_id,
            'feishu_user_id': self.feishu_user_id,
            'feishu_union_id': self.feishu_union_id,
            'feishu_open_id': self.feishu_open_id,
            'feishu_name': self.feishu_name,
            'feishu_en_name': self.feishu_en_name,
            'feishu_email': self.feishu_email,
            'feishu_mobile': self.feishu_mobile,
            'feishu_avatar_url': self.feishu_avatar_url,
            'feishu_department_ids': self.feishu_department_ids,
            'last_sync_at': self.last_sync_at.isoformat() if self.last_sync_at else None,
            'sync_enabled': self.sync_enabled,
            'sync_errors': self.sync_errors,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }

    def __repr__(self):
        return f'<FeishuAuthUser {self.feishu_user_id}>'
```

#### 4.3 扩展AdminUser模型
```python
# app/models/user/admin.py - 添加到现有模型中

# 在AdminUser类中添加新字段和方法
class AdminUser(db.Model, TimestampMixin):
    # ... 现有字段 ...

    # 新增认证提供方字段
    auth_provider = Column(String(20), default='local', nullable=False)

    # 添加关联关系
    feishu_auth = relationship("FeishuAuthUser", uselist=False, back_populates="admin_user")

    def is_feishu_user(self) -> bool:
        """检查是否为飞书用户"""
        return self.auth_provider in ('feishu', 'mixed')

    def can_login_with_password(self) -> bool:
        """检查是否可以使用密码登录"""
        return self.auth_provider in ('local', 'mixed') and self.password_hash

    def can_login_with_feishu(self) -> bool:
        """检查是否可以使用飞书登录"""
        return self.auth_provider in ('feishu', 'mixed')

    def get_feishu_auth(self):
        """获取关联的飞书认证信息"""
        return self.feishu_auth

    def get_display_avatar(self) -> str:
        """获取显示头像URL"""
        if self.feishu_auth and self.feishu_auth.feishu_avatar_url:
            return self.feishu_auth.feishu_avatar_url
        return '/static/images/default-avatar.png'

    def to_dict_with_feishu(self) -> dict:
        """转换为包含飞书信息的字典"""
        base_dict = self.to_dict() if hasattr(self, 'to_dict') else {}

        base_dict.update({
            'auth_provider': self.auth_provider,
            'can_login_with_password': self.can_login_with_password(),
            'can_login_with_feishu': self.can_login_with_feishu(),
            'display_avatar': self.get_display_avatar(),
            'feishu_auth': self.feishu_auth.to_dict() if self.feishu_auth else None
        })
        return base_dict
```

**✅ 阶段测试4：代码结构验证**
```python
# scripts/test_project_structure.py
import os
from importlib import import_module

def test_project_structure():
    """测试项目结构是否正确"""
    base_path = "/Users/yukun-admin/projects/pigeon/pigeon_web"

    # 测试目录结构
    required_dirs = [
        "app/api/v1/feishu_auth/route",
        "app/api/v1/feishu_auth/schema",
        "app/services/feishu/service",
        "app/models/feishu",
        "tests/feishu/unit",
        "tests/feishu/integration"
    ]

    missing_dirs = []
    for dir_path in required_dirs:
        full_path = os.path.join(base_path, dir_path)
        if not os.path.exists(full_path):
            missing_dirs.append(dir_path)

    if missing_dirs:
        print(f"❌ 缺少目录: {missing_dirs}")
        return False

    # 测试模型导入
    try:
        from app.models.feishu.config import FeishuAppConfig
        from app.models.feishu.auth_user import FeishuAuthUser
        from app.models.user.admin import AdminUser

        # 测试新方法
        dummy_user = AdminUser()
        dummy_user.auth_provider = 'feishu'

        assert dummy_user.is_feishu_user() == True
        assert dummy_user.can_login_with_feishu() == True

        print("✅ 模型扩展验证成功")

    except Exception as e:
        print(f"❌ 模型导入失败: {e}")
        return False

    print("✅ 项目结构验证通过")
    return True

if __name__ == "__main__":
    test_project_structure()
```

**验收标准**：
- [ ] 目录结构创建正确
- [ ] 模型文件创建和扩展完成
- [ ] 新增方法功能正常
- [ ] 导入路径正确

---

## 🏁 第1阶段完成检查表

### 环境配置 ✅
- [ ] 飞书开放平台应用创建完成
- [ ] ngrok内网穿透配置成功
- [ ] 本地环境变量配置正确
- [ ] 数据库和Redis连接正常

### 数据库设计 ✅
- [ ] 数据库迁移脚本编写完成
- [ ] 迁移执行成功
- [ ] 新增表和字段验证通过
- [ ] 测试数据插入正常

### API连接 ✅
- [ ] 飞书API基础连接测试通过
- [ ] OAuth2授权流程验证完成
- [ ] Mock服务器备用方案可用
- [ ] API响应格式确认正确

### 代码结构 ✅
- [ ] 项目目录结构创建完成
- [ ] 模型文件扩展完成
- [ ] 新增方法测试通过
- [ ] 代码规范符合要求

## 🎯 下一阶段预告

**第2阶段：核心飞书认证服务实现**
- FeishuAuthService核心服务开发
- OAuth2完整流程实现
- 用户查找和创建逻辑
- 令牌管理和缓存策略
- 完整的单元测试覆盖

**预估时间**：4-6天
**主要产出**：完整可用的飞书认证后端服务

---

**第1阶段完成标志**：所有测试脚本运行通过，环境配置验证成功，为下一阶段开发做好准备。