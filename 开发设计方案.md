# 国际短信服务Web系统开发设计方案

## 1. 整体技术架构设计

### 1.1 架构模式
- **分层架构**：API层 → 服务层 → 数据层
- **模块化设计**：按业务域划分独立模块
- **RESTful API**：标准化接口设计
- **前后端分离**：API优先，支持多端访问

### 1.2 核心技术选型验证
基于现有代码架构，技术栈选择合理：
```python
# 后端核心框架
Flask + Flask-RESTful      # 轻量级，灵活性高
Flask-SQLAlchemy          # ORM映射
Flask-JWT-Extended        # JWT认证
Flask-Caching + Redis     # 缓存系统
Flask-Babel              # 国际化支持
Marshmallow              # 数据序列化验证
```

### 1.3 推荐增强技术栈
```python
# 建议添加的技术组件
flask-apispec            # API文档自动生成
celery                   # 异步任务处理
APScheduler              # 定时任务调度
flask-migrate            # 数据库版本管理
loguru                   # 日志增强
```

## 2. 模块设计方案

### 2.1 P0优先级模块设计

#### 2.1.1 客户管理系统 (Customer Management)
**核心功能**：
- 企业账号CRUD管理
- 发送账号层级管理
- 财务账户绑定
- 权限分配管理

**数据模型**：
```python
# 主要实体
- EnterpriseAccount (企业账号)
- SendingAccount (发送账号) 
- AccountFinance (账户财务)
- AccountPermission (账户权限)
```

**API设计**：
```
GET    /api/v1/customers/enterprises              # 企业账号列表
POST   /api/v1/customers/enterprises              # 创建企业账号
GET    /api/v1/customers/enterprises/{id}         # 企业账号详情
PUT    /api/v1/customers/enterprises/{id}         # 更新企业账号
DELETE /api/v1/customers/enterprises/{id}         # 删除企业账号
GET    /api/v1/customers/enterprises/{id}/sending # 发送账号列表
POST   /api/v1/customers/sending                  # 创建发送账号
```

#### 2.1.2 队列监控系统 (Queue Monitoring)
**核心功能**：
- 实时队列状态监控
- 队列堵塞检测
- 人工干预操作
- 队列性能统计

**技术方案**：
- **WebSocket实时推送**：队列状态变化实时通知
- **Redis队列状态**：缓存队列实时状态数据
- **定时任务监控**：后台定期检查队列健康度

#### 2.1.3 内容审核系统 (Content Review)
**核心功能**：
- 待审核内容队列
- 审核工作台
- 审核规则配置
- 审核历史追踪

**工作流设计**：
```
短信提交 → 自动预审 → 人工审核队列 → 审核决策 → 结果通知
```

### 2.2 P1优先级模块设计

#### 2.2.1 财务管理系统
- **充值扣费**：支持多种充值方式，自动扣费逻辑
- **账单管理**：详细的账单生成和查询
- **利润分析**：成本核算和利润统计

#### 2.2.2 收发信箱系统
- **上行短信管理**：接收、分类、转发上行消息
- **下行短信管理**：发送历史、状态追踪
- **批次管理**：批量发送任务管理

#### 2.2.3 统计报表系统
- **实时统计**：发送量、成功率实时统计
- **多维分析**：按时间、地区、通道等维度分析
- **数据导出**：支持Excel、CSV等格式导出

## 3. 数据库设计优化

### 3.1 基于现有Schema的优化建议
```sql
-- 建议添加的索引优化
CREATE INDEX CONCURRENTLY idx_short_messages_created_time_account 
ON short_messages(created_time, account_id);

CREATE INDEX CONCURRENTLY idx_delivers_message_state_time 
ON delivers(short_message_id, state, created_time);

-- 分区表设计(针对大数据量)
CREATE TABLE short_messages_y2024m01 PARTITION OF short_messages
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

### 3.2 缓存策略设计
```python
# Redis缓存层级设计
Level1: 热点数据缓存 (TTL: 5min)
  - 实时队列状态
  - 当前在线用户信息
  
Level2: 业务数据缓存 (TTL: 1hour)
  - 企业账号信息
  - 权限配置数据
  
Level3: 统计数据缓存 (TTL: 1day)  
  - 日统计报表
  - 月度分析数据
```

## 4. API设计规范

### 4.1 RESTful API设计标准
```
# URL命名规范
/api/v1/{resource}/{id}/{sub-resource}

# HTTP方法语义
GET    - 查询操作，幂等
POST   - 创建操作
PUT    - 全量更新，幂等  
PATCH  - 部分更新
DELETE - 删除操作，幂等
```

### 4.2 统一响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "pagination": {
    "page": 1,
    "size": 20,
    "total": 100,
    "pages": 5
  },
  "timestamp": "2024-01-01T00:00:00Z"
}
```

### 4.3 错误处理规范
```python
# HTTP状态码使用规范
200 OK          # 成功
201 Created     # 创建成功
400 Bad Request # 客户端错误
401 Unauthorized# 未认证
403 Forbidden   # 无权限
404 Not Found   # 资源不存在
422 Unprocessable Entity # 数据验证失败
500 Internal Server Error # 服务器错误
```

## 5. 权限系统设计

### 5.1 RBAC权限模型
```
用户(User) → 角色(Role) → 权限(Permission) → 资源(Resource)
```

### 5.2 权限粒度设计
```python
# 权限层级设计
MODULE_LEVEL = "模块级权限"      # 如：客户管理模块
RESOURCE_LEVEL = "资源级权限"    # 如：企业账号资源
OPERATION_LEVEL = "操作级权限"   # 如：查看、编辑、删除
DATA_LEVEL = "数据级权限"       # 如：只能查看自己创建的数据
```

## 6. 性能优化方案

### 6.1 数据库优化
- **读写分离**：主从复制，读操作分流
- **连接池优化**：合理配置连接池大小
- **慢查询监控**：识别和优化慢查询
- **分页优化**：使用游标分页替代offset分页

### 6.2 缓存优化
- **多级缓存**：应用缓存 + Redis缓存
- **缓存预热**：系统启动时预加载热点数据
- **缓存失效**：合理的失效策略和更新机制

### 6.3 异步处理
```python
# Celery任务队列设计
@celery.task
def generate_report_async(report_id):
    """异步生成统计报表"""
    pass

@celery.task  
def export_data_async(export_id):
    """异步导出数据"""
    pass
```

## 7. 监控和日志设计

### 7.1 系统监控指标
```python
# 关键指标监控
- API响应时间
- 数据库连接数  
- Redis内存使用
- 队列堆积情况
- 错误发生频率
```

### 7.2 业务监控指标
```python
# 业务指标监控
- 短信发送量统计
- 审核队列长度
- 用户登录活跃度
- 财务交易频率
```

### 7.3 日志系统设计
```python
# 日志分级和分类
ERROR   - 系统错误，需要立即处理
WARN    - 警告信息，需要关注
INFO    - 业务操作日志
DEBUG   - 调试信息

# 日志分类
- 系统日志：应用启动、停止、配置变更
- 业务日志：用户操作、业务流程
- 安全日志：登录、权限变更、敏感操作
- 性能日志：慢查询、高耗时操作
```

## 8. 安全设计方案

### 8.1 认证安全
- **JWT Token**：无状态认证
- **Token刷新机制**：防止长期有效token泄露
- **多因子认证**：支持短信、邮箱验证

### 8.2 数据安全
- **敏感数据加密**：密码、密钥等敏感信息加密存储
- **SQL注入防护**：使用参数化查询
- **XSS防护**：输入输出过滤和转义

### 8.3 接口安全
- **API限流**：防止接口被恶意调用
- **参数验证**：严格的输入参数校验
- **HTTPS强制**：所有API强制使用HTTPS

## 9. 部署和运维方案

### 9.1 容器化部署
```yaml
# Docker Compose示例
version: '3.8'
services:
  web:
    build: .
    ports:
      - "5000:5000"
  redis:
    image: redis:alpine
  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: pigeon_web
```

### 9.2 CI/CD流程
```
代码提交 → 自动测试 → 构建镜像 → 部署测试环境 → 人工验收 → 部署生产环境
```

### 9.3 监控告警
- **应用性能监控(APM)**：如New Relic、DataDog
- **基础设施监控**：CPU、内存、磁盘、网络
- **业务指标监控**：自定义业务指标看板

这个设计方案基于现有的技术架构，充分考虑了业务需求的复杂性和系统的可扩展性。建议按照P0 → P1 → P2的优先级顺序进行开发实施。