# 飞书登录集成开发计划 - 第5阶段：生产部署和运维管理

## 📋 阶段概述

**目标**：完成生产环境部署、用户管理界面、文档和运维工具
**预估时间**：2-3天
**优先级**：中
**依赖**：第1、2、3、4阶段完成

## 🎯 阶段目标

- [ ] 生产环境部署指南和自动化
- [ ] 管理员用户管理界面
- [ ] 完整技术文档和用户手册
- [ ] 运维工具和脚本
- [ ] 培训材料和最佳实践
- [ ] 上线检查清单和回滚方案

## 📝 详细任务清单

### 任务1：生产环境部署和配置 (1天)

#### 1.1 创建生产环境配置
```bash
# deployment/production/feishu-config.yaml

# Copyright(c) 2025
# All rights reserved.
#
# Author: yukun.xing <xingyukun@gmail.com>
# Date:   2025/09/19

# 飞书登录集成生产环境配置

apiVersion: v1
kind: ConfigMap
metadata:
  name: feishu-config
  namespace: pigeon-web
data:
  # 飞书应用配置
  FEISHU_APP_ID: "${FEISHU_APP_ID}"
  FEISHU_REDIRECT_URI: "https://pigeon.company.com/auth/feishu/callback"
  FEISHU_AUTO_CREATE_USER: "true"
  FEISHU_DEFAULT_ROLES: "user"
  FEISHU_ALLOWED_DOMAINS: "company.com,subsidiary.com"

  # 缓存配置
  FEISHU_CACHE_TTL_USER_INFO: "3600"
  FEISHU_CACHE_TTL_APP_TOKEN: "7200"

  # 安全配置
  FEISHU_MAX_LOGIN_ATTEMPTS: "5"
  FEISHU_LOCKOUT_DURATION: "3600"
  FEISHU_RATE_LIMIT_MAX: "100"
  FEISHU_RATE_LIMIT_WINDOW: "60"

  # 监控配置
  FEISHU_METRICS_ENABLED: "true"
  FEISHU_ALERT_WEBHOOK: "${FEISHU_ALERT_WEBHOOK}"

  # 日志配置
  FEISHU_LOG_LEVEL: "INFO"
  FEISHU_AUDIT_LOG_ENABLED: "true"

---
apiVersion: v1
kind: Secret
metadata:
  name: feishu-secrets
  namespace: pigeon-web
type: Opaque
data:
  FEISHU_APP_SECRET: "${FEISHU_APP_SECRET_BASE64}"
  FEISHU_ENCRYPT_KEY: "${FEISHU_ENCRYPT_KEY_BASE64}"
  FEISHU_VERIFICATION_TOKEN: "${FEISHU_VERIFICATION_TOKEN_BASE64}"
```

#### 1.2 创建部署脚本
```bash
#!/bin/bash

# deployment/scripts/deploy-feishu-integration.sh

# Copyright(c) 2025
# All rights reserved.
#
# Author: yukun.xing <xingyukun@gmail.com>
# Date:   2025/09/19

set -e

echo "🚀 Deploying Feishu Login Integration to Production..."

# 配置变量
NAMESPACE="pigeon-web"
APP_NAME="pigeon-web"
CONFIG_FILE="deployment/production/feishu-config.yaml"
BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"

# 函数定义
check_prerequisites() {
    echo "🔍 Checking prerequisites..."

    # 检查kubectl
    if ! command -v kubectl &> /dev/null; then
        echo "❌ kubectl not found. Please install kubectl."
        exit 1
    fi

    # 检查namespace
    if ! kubectl get namespace $NAMESPACE &> /dev/null; then
        echo "❌ Namespace $NAMESPACE not found."
        exit 1
    fi

    # 检查必需的环境变量
    required_vars=("FEISHU_APP_ID" "FEISHU_APP_SECRET" "FEISHU_ENCRYPT_KEY" "FEISHU_VERIFICATION_TOKEN")
    for var in "${required_vars[@]}"; do
        if [[ -z "${!var}" ]]; then
            echo "❌ Environment variable $var is not set."
            exit 1
        fi
    done

    echo "✅ Prerequisites check passed."
}

backup_current_config() {
    echo "💾 Creating backup of current configuration..."
    mkdir -p $BACKUP_DIR

    # 备份现有配置
    kubectl get configmap feishu-config -n $NAMESPACE -o yaml > $BACKUP_DIR/feishu-config.yaml 2>/dev/null || true
    kubectl get secret feishu-secrets -n $NAMESPACE -o yaml > $BACKUP_DIR/feishu-secrets.yaml 2>/dev/null || true

    echo "✅ Backup created in $BACKUP_DIR"
}

apply_database_migrations() {
    echo "🗃️ Applying database migrations..."

    # 应用飞书相关的数据库迁移
    kubectl exec -n $NAMESPACE deployment/$APP_NAME -- python -c "
from app import create_app
from app.extensions import db
from app.models.feishu.metrics import FeishuMetrics, FeishuOperationLog

app = create_app()
with app.app_context():
    db.create_all()
    print('Database tables created successfully')
"

    echo "✅ Database migrations applied."
}

deploy_configuration() {
    echo "⚙️ Deploying Feishu configuration..."

    # 替换环境变量并应用配置
    envsubst < $CONFIG_FILE | kubectl apply -f -

    echo "✅ Configuration deployed."
}

update_application() {
    echo "📦 Updating application with Feishu integration..."

    # 重启应用以加载新配置
    kubectl rollout restart deployment/$APP_NAME -n $NAMESPACE

    # 等待部署完成
    kubectl rollout status deployment/$APP_NAME -n $NAMESPACE --timeout=300s

    echo "✅ Application updated."
}

run_health_checks() {
    echo "🏥 Running health checks..."

    # 等待应用启动
    sleep 30

    # 检查应用健康状态
    APP_URL=$(kubectl get service $APP_NAME -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
    if [[ -z "$APP_URL" ]]; then
        APP_URL="localhost:8080"  # fallback for port-forward testing
    fi

    # 健康检查
    if curl -f -s "http://$APP_URL/api/v1/health" > /dev/null; then
        echo "✅ Application health check passed."
    else
        echo "❌ Application health check failed."
        exit 1
    fi

    # 飞书集成健康检查
    if curl -f -s "http://$APP_URL/api/v1/feishu-auth/health" > /dev/null; then
        echo "✅ Feishu integration health check passed."
    else
        echo "⚠️ Feishu integration health check failed. Check configuration."
    fi
}

rollback() {
    echo "🔄 Rolling back deployment..."

    if [[ -f "$BACKUP_DIR/feishu-config.yaml" ]]; then
        kubectl apply -f $BACKUP_DIR/feishu-config.yaml
    fi

    if [[ -f "$BACKUP_DIR/feishu-secrets.yaml" ]]; then
        kubectl apply -f $BACKUP_DIR/feishu-secrets.yaml
    fi

    kubectl rollout undo deployment/$APP_NAME -n $NAMESPACE
    kubectl rollout status deployment/$APP_NAME -n $NAMESPACE --timeout=300s

    echo "✅ Rollback completed."
}

# 主部署流程
main() {
    echo "🎯 Starting Feishu Integration Deployment"
    echo "Namespace: $NAMESPACE"
    echo "Timestamp: $(date)"
    echo ""

    # 设置错误处理
    trap 'echo "❌ Deployment failed. Rolling back..."; rollback; exit 1' ERR

    check_prerequisites
    backup_current_config
    apply_database_migrations
    deploy_configuration
    update_application
    run_health_checks

    echo ""
    echo "🎉 Feishu Integration Deployment Completed Successfully!"
    echo "Backup location: $BACKUP_DIR"
    echo ""
    echo "📋 Post-deployment checklist:"
    echo "1. Verify Feishu login functionality"
    echo "2. Check monitoring dashboards"
    echo "3. Review application logs"
    echo "4. Test user synchronization"
    echo "5. Validate security settings"
}

# 支持命令行参数
case "${1:-deploy}" in
    deploy)
        main
        ;;
    rollback)
        if [[ -z "$2" ]]; then
            echo "Usage: $0 rollback <backup_directory>"
            exit 1
        fi
        BACKUP_DIR="$2"
        rollback
        ;;
    health-check)
        run_health_checks
        ;;
    *)
        echo "Usage: $0 {deploy|rollback|health-check}"
        exit 1
        ;;
esac
```

#### 1.3 创建监控和告警配置
```yaml
# deployment/monitoring/feishu-alerts.yaml

# Copyright(c) 2025
# All rights reserved.
#
# Author: yukun.xing <xingyukun@gmail.com>
# Date:   2025/09/19

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: feishu-integration-alerts
  namespace: pigeon-web
  labels:
    app: pigeon-web
    component: feishu-integration
spec:
  groups:
  - name: feishu.rules
    rules:
    - alert: FeishuLoginFailureRateHigh
      expr: feishu_login_failure_rate > 0.1
      for: 5m
      labels:
        severity: warning
        service: feishu-integration
      annotations:
        summary: "Feishu login failure rate is high"
        description: "Feishu login failure rate is {{ $value | humanizePercentage }} for the last 5 minutes"

    - alert: FeishuAPIResponseTimeSlow
      expr: feishu_api_response_time_avg > 5000
      for: 2m
      labels:
        severity: error
        service: feishu-integration
      annotations:
        summary: "Feishu API response time is slow"
        description: "Feishu API average response time is {{ $value }}ms for the last 2 minutes"

    - alert: FeishuTokenRefreshFailureHigh
      expr: feishu_token_refresh_failure_rate > 0.05
      for: 3m
      labels:
        severity: warning
        service: feishu-integration
      annotations:
        summary: "Feishu token refresh failure rate is high"
        description: "Token refresh failure rate is {{ $value | humanizePercentage }}"

    - alert: FeishuIntegrationDown
      expr: up{job="feishu-integration"} == 0
      for: 1m
      labels:
        severity: critical
        service: feishu-integration
      annotations:
        summary: "Feishu integration service is down"
        description: "Feishu integration service has been down for more than 1 minute"

    - alert: FeishuAPIQuotaHigh
      expr: feishu_api_quota_usage_rate > 0.8
      for: 5m
      labels:
        severity: warning
        service: feishu-integration
      annotations:
        summary: "Feishu API quota usage is high"
        description: "API quota usage is {{ $value | humanizePercentage }}, approaching limit"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: feishu-grafana-dashboard
  namespace: pigeon-web
data:
  dashboard.json: |
    {
      "dashboard": {
        "title": "Feishu Integration Monitoring",
        "panels": [
          {
            "title": "Login Success Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "feishu_login_success_rate",
                "legendFormat": "Success Rate"
              }
            ]
          },
          {
            "title": "API Response Time",
            "type": "graph",
            "targets": [
              {
                "expr": "feishu_api_response_time_avg",
                "legendFormat": "Average Response Time"
              }
            ]
          },
          {
            "title": "Active Users",
            "type": "stat",
            "targets": [
              {
                "expr": "feishu_active_users_total",
                "legendFormat": "Active Users"
              }
            ]
          }
        ]
      }
    }
```

**✅ 阶段测试1：部署验证**
```bash
#!/bin/bash
# deployment/scripts/test-deployment.sh

# Copyright(c) 2025
# All rights reserved.
#
# Author: yukun.xing <xingyukun@gmail.com>
# Date:   2025/09/19

echo "🧪 Testing Feishu Integration Deployment..."

# 设置测试环境变量
export FEISHU_APP_ID="cli_test123456"
export FEISHU_APP_SECRET="test_secret"
export FEISHU_ENCRYPT_KEY="test_encrypt_key"
export FEISHU_VERIFICATION_TOKEN="test_verification_token"

# 1. 测试配置验证
echo "1️⃣ Testing configuration validation..."
if ./deployment/scripts/deploy-feishu-integration.sh health-check; then
    echo "✅ Configuration validation passed"
else
    echo "❌ Configuration validation failed"
    exit 1
fi

# 2. 测试API端点
echo "2️⃣ Testing API endpoints..."
APP_URL="http://localhost:5000"  # 本地测试

endpoints=(
    "/api/v1/health"
    "/api/v1/feishu-auth/health"
    "/api/v1/feishu-auth/authorize"
)

for endpoint in "${endpoints[@]}"; do
    if curl -f -s "$APP_URL$endpoint" > /dev/null; then
        echo "✅ $endpoint is accessible"
    else
        echo "❌ $endpoint is not accessible"
    fi
done

# 3. 测试数据库连接
echo "3️⃣ Testing database connectivity..."
python3 -c "
from app import create_app
from app.extensions import db
app = create_app()
with app.app_context():
    try:
        db.session.execute('SELECT 1')
        print('✅ Database connection successful')
    except Exception as e:
        print(f'❌ Database connection failed: {e}')
        exit(1)
"

# 4. 测试缓存连接
echo "4️⃣ Testing cache connectivity..."
python3 -c "
from app import create_app
from app.extensions import cache
app = create_app()
with app.app_context():
    try:
        cache.ping()
        print('✅ Cache connection successful')
    except Exception as e:
        print(f'❌ Cache connection failed: {e}')
        exit(1)
"

echo "🎉 Deployment test completed successfully!"
```

### 任务2：管理员用户管理界面 (1天)

#### 2.1 创建飞书用户管理页面
```typescript
// frontend/src/pages/system/feishu/FeishuUserManagement.tsx

/*
 * Copyright(c) 2025
 * All rights reserved.
 *
 * Author: yukun.xing <xingyukun@gmail.com>
 * Date:   2025/09/19
 */

import React, { useState } from 'react';
import {
  Card, Table, Button, Space, Tag, Tooltip, Modal, Form,
  Input, Select, DatePicker, Statistic, Row, Col, Alert,
  Typography, Divider, Switch, message
} from 'antd';
import {
  UserOutlined, SyncOutlined, SettingOutlined,
  ExclamationCircleOutlined, ReloadOutlined
} from '@ant-design/icons';
import { useFeishuUserManagement } from '../../../hooks/useFeishuUserManagement';

const { Title, Text } = Typography;
const { RangePicker } = DatePicker;
const { confirm } = Modal;

interface FeishuUser {
  id: string;
  username: string;
  email: string;
  full_name: string;
  avatar_url?: string;
  auth_provider: 'feishu';
  feishu_info: {
    user_id: string;
    name: string;
    en_name?: string;
    email?: string;
    mobile?: string;
    department_ids?: string[];
    union_id?: string;
    open_id?: string;
  };
  last_feishu_sync?: string;
  is_active: boolean;
  created_at: string;
  last_login?: string;
}

const FeishuUserManagement: React.FC = () => {
  const [selectedRowKeys, setSelectedRowKeys] = useState<string[]>([]);
  const [configModalVisible, setConfigModalVisible] = useState(false);
  const [syncModalVisible, setSyncModalVisible] = useState(false);

  const {
    users,
    loading,
    statistics,
    configuration,
    syncUser,
    batchSyncUsers,
    updateConfiguration,
    refreshUsers
  } = useFeishuUserManagement();

  const columns = [
    {
      title: 'User',
      key: 'user',
      render: (record: FeishuUser) => (
        <Space>
          <img
            src={record.avatar_url || record.feishu_info?.avatar_url}
            alt={record.full_name}
            style={{ width: 32, height: 32, borderRadius: '50%' }}
            onError={(e) => {
              (e.target as HTMLImageElement).src = '/default-avatar.png';
            }}
          />
          <div>
            <div style={{ fontWeight: 'bold' }}>{record.full_name}</div>
            <Text type="secondary">{record.email}</Text>
          </div>
        </Space>
      ),
    },
    {
      title: 'Feishu Info',
      key: 'feishu_info',
      render: (record: FeishuUser) => (
        <div>
          <div>ID: <Text code>{record.feishu_info.user_id}</Text></div>
          {record.feishu_info.en_name && (
            <div>EN: {record.feishu_info.en_name}</div>
          )}
          {record.feishu_info.mobile && (
            <div>Mobile: {record.feishu_info.mobile}</div>
          )}
        </div>
      ),
    },
    {
      title: 'Departments',
      dataIndex: ['feishu_info', 'department_ids'],
      render: (departments: string[]) => (
        <div>
          {departments?.map(dept => (
            <Tag key={dept} size="small">{dept}</Tag>
          ))}
        </div>
      ),
    },
    {
      title: 'Status',
      key: 'status',
      render: (record: FeishuUser) => (
        <Space direction="vertical" size="small">
          <Tag color={record.is_active ? 'green' : 'red'}>
            {record.is_active ? 'Active' : 'Inactive'}
          </Tag>
          {record.last_feishu_sync && (
            <Tooltip title={`Last sync: ${new Date(record.last_feishu_sync).toLocaleString()}`}>
              <Tag color="blue" size="small">Synced</Tag>
            </Tooltip>
          )}
        </Space>
      ),
    },
    {
      title: 'Last Login',
      dataIndex: 'last_login',
      render: (date: string) => date ? new Date(date).toLocaleDateString() : 'Never',
    },
    {
      title: 'Actions',
      key: 'actions',
      render: (record: FeishuUser) => (
        <Space>
          <Button
            type="link"
            icon={<SyncOutlined />}
            onClick={() => handleSyncUser(record.id)}
            loading={loading}
          >
            Sync
          </Button>
          <Button
            type="link"
            danger
            onClick={() => handleDeactivateUser(record.id)}
          >
            Deactivate
          </Button>
        </Space>
      ),
    },
  ];

  const handleSyncUser = async (userId: string) => {
    try {
      await syncUser(userId);
      message.success('User synced successfully');
    } catch (error: any) {
      message.error(`Sync failed: ${error.message}`);
    }
  };

  const handleBatchSync = () => {
    if (selectedRowKeys.length === 0) {
      message.warning('Please select users to sync');
      return;
    }

    confirm({
      title: 'Batch Sync Users',
      content: `Are you sure you want to sync ${selectedRowKeys.length} users with Feishu?`,
      icon: <ExclamationCircleOutlined />,
      async onOk() {
        try {
          await batchSyncUsers(selectedRowKeys);
          message.success(`${selectedRowKeys.length} users synced successfully`);
          setSelectedRowKeys([]);
        } catch (error: any) {
          message.error(`Batch sync failed: ${error.message}`);
        }
      },
    });
  };

  const handleDeactivateUser = (userId: string) => {
    confirm({
      title: 'Deactivate User',
      content: 'Are you sure you want to deactivate this user?',
      danger: true,
      async onOk() {
        try {
          // Call deactivate API
          message.success('User deactivated successfully');
          refreshUsers();
        } catch (error: any) {
          message.error(`Deactivation failed: ${error.message}`);
        }
      },
    });
  };

  const ConfigurationModal = () => (
    <Modal
      title="Feishu Integration Configuration"
      open={configModalVisible}
      onCancel={() => setConfigModalVisible(false)}
      footer={null}
      width={600}
    >
      <Form
        layout="vertical"
        initialValues={configuration}
        onFinish={async (values) => {
          try {
            await updateConfiguration(values);
            message.success('Configuration updated successfully');
            setConfigModalVisible(false);
          } catch (error: any) {
            message.error(`Configuration update failed: ${error.message}`);
          }
        }}
      >
        <Form.Item
          name="auto_create_user"
          label="Auto Create User"
          valuePropName="checked"
        >
          <Switch />
        </Form.Item>

        <Form.Item
          name="allowed_domains"
          label="Allowed Email Domains"
          help="Comma-separated list of allowed email domains"
        >
          <Input placeholder="company.com,subsidiary.com" />
        </Form.Item>

        <Form.Item
          name="default_roles"
          label="Default Roles"
          help="Default roles assigned to new Feishu users"
        >
          <Select mode="multiple" placeholder="Select default roles">
            <Select.Option value="user">User</Select.Option>
            <Select.Option value="viewer">Viewer</Select.Option>
            <Select.Option value="admin">Admin</Select.Option>
          </Select>
        </Form.Item>

        <Form.Item
          name="sync_frequency"
          label="Sync Frequency (hours)"
        >
          <Input type="number" min={1} max={168} />
        </Form.Item>

        <Form.Item>
          <Space>
            <Button type="primary" htmlType="submit">
              Update Configuration
            </Button>
            <Button onClick={() => setConfigModalVisible(false)}>
              Cancel
            </Button>
          </Space>
        </Form.Item>
      </Form>
    </Modal>
  );

  return (
    <div style={{ padding: '24px' }}>
      <Title level={2}>
        <UserOutlined /> Feishu User Management
      </Title>

      {/* Statistics */}
      <Row gutter={16} style={{ marginBottom: '24px' }}>
        <Col span={6}>
          <Card>
            <Statistic
              title="Total Feishu Users"
              value={statistics?.total_users || 0}
              prefix={<UserOutlined />}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="Active Users"
              value={statistics?.active_users || 0}
              valueStyle={{ color: '#3f8600' }}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="Recent Logins (7d)"
              value={statistics?.recent_logins || 0}
              valueStyle={{ color: '#1890ff' }}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="Sync Failures"
              value={statistics?.sync_failures || 0}
              valueStyle={{ color: statistics?.sync_failures ? '#cf1322' : undefined }}
            />
          </Card>
        </Col>
      </Row>

      {/* Alerts */}
      {statistics?.sync_failures > 0 && (
        <Alert
          type="warning"
          message="Sync Issues Detected"
          description={`${statistics.sync_failures} users have sync failures. Please check the logs and retry synchronization.`}
          showIcon
          style={{ marginBottom: '16px' }}
        />
      )}

      {/* Actions */}
      <Card style={{ marginBottom: '16px' }}>
        <Space>
          <Button
            type="primary"
            icon={<SyncOutlined />}
            onClick={handleBatchSync}
            disabled={selectedRowKeys.length === 0}
          >
            Batch Sync ({selectedRowKeys.length})
          </Button>
          <Button
            icon={<ReloadOutlined />}
            onClick={refreshUsers}
            loading={loading}
          >
            Refresh
          </Button>
          <Button
            icon={<SettingOutlined />}
            onClick={() => setConfigModalVisible(true)}
          >
            Configuration
          </Button>
        </Space>
      </Card>

      {/* User Table */}
      <Card>
        <Table
          columns={columns}
          dataSource={users}
          loading={loading}
          rowKey="id"
          rowSelection={{
            selectedRowKeys,
            onChange: setSelectedRowKeys,
          }}
          pagination={{
            total: users?.length || 0,
            pageSize: 20,
            showSizeChanger: true,
            showTotal: (total, range) =>
              `${range[0]}-${range[1]} of ${total} users`,
          }}
        />
      </Card>

      <ConfigurationModal />
    </div>
  );
};

export default FeishuUserManagement;
```

#### 2.2 创建管理Hook
```typescript
// frontend/src/hooks/useFeishuUserManagement.ts

/*
 * Copyright(c) 2025
 * All rights reserved.
 *
 * Author: yukun.xing <xingyukun@gmail.com>
 * Date:   2025/09/19
 */

import { useState, useEffect, useCallback } from 'react';
import { feishuManagementApi } from '../api/feishuManagementApi';

interface FeishuStatistics {
  total_users: number;
  active_users: number;
  recent_logins: number;
  sync_failures: number;
  last_sync: string;
}

interface FeishuConfiguration {
  auto_create_user: boolean;
  allowed_domains: string;
  default_roles: string[];
  sync_frequency: number;
}

export const useFeishuUserManagement = () => {
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(false);
  const [statistics, setStatistics] = useState<FeishuStatistics | null>(null);
  const [configuration, setConfiguration] = useState<FeishuConfiguration | null>(null);

  const fetchUsers = useCallback(async () => {
    setLoading(true);
    try {
      const response = await feishuManagementApi.getUsers();
      setUsers(response.data);
    } catch (error) {
      console.error('Failed to fetch users:', error);
    } finally {
      setLoading(false);
    }
  }, []);

  const fetchStatistics = useCallback(async () => {
    try {
      const response = await feishuManagementApi.getStatistics();
      setStatistics(response.data);
    } catch (error) {
      console.error('Failed to fetch statistics:', error);
    }
  }, []);

  const fetchConfiguration = useCallback(async () => {
    try {
      const response = await feishuManagementApi.getConfiguration();
      setConfiguration(response.data);
    } catch (error) {
      console.error('Failed to fetch configuration:', error);
    }
  }, []);

  const syncUser = useCallback(async (userId: string) => {
    await feishuManagementApi.syncUser(userId);
    await fetchUsers();
    await fetchStatistics();
  }, [fetchUsers, fetchStatistics]);

  const batchSyncUsers = useCallback(async (userIds: string[]) => {
    await feishuManagementApi.batchSyncUsers(userIds);
    await fetchUsers();
    await fetchStatistics();
  }, [fetchUsers, fetchStatistics]);

  const updateConfiguration = useCallback(async (config: FeishuConfiguration) => {
    await feishuManagementApi.updateConfiguration(config);
    await fetchConfiguration();
  }, [fetchConfiguration]);

  const refreshUsers = useCallback(() => {
    fetchUsers();
    fetchStatistics();
  }, [fetchUsers, fetchStatistics]);

  useEffect(() => {
    fetchUsers();
    fetchStatistics();
    fetchConfiguration();
  }, [fetchUsers, fetchStatistics, fetchConfiguration]);

  return {
    users,
    loading,
    statistics,
    configuration,
    syncUser,
    batchSyncUsers,
    updateConfiguration,
    refreshUsers
  };
};
```

**✅ 阶段测试2：管理界面验证**
```typescript
// frontend/src/tests/pages/FeishuUserManagement.test.tsx

import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { Provider } from 'react-redux';
import FeishuUserManagement from '../../pages/system/feishu/FeishuUserManagement';
import { mockStore } from '../testUtils';

// Mock the management hook
jest.mock('../../hooks/useFeishuUserManagement', () => ({
  useFeishuUserManagement: jest.fn(() => ({
    users: [
      {
        id: '1',
        username: 'testuser',
        email: 'test@company.com',
        full_name: 'Test User',
        auth_provider: 'feishu',
        feishu_info: {
          user_id: 'ou_123456',
          name: 'Test User',
          email: 'test@company.com'
        },
        is_active: true,
        created_at: '2025-01-01T00:00:00Z'
      }
    ],
    loading: false,
    statistics: {
      total_users: 1,
      active_users: 1,
      recent_logins: 1,
      sync_failures: 0
    },
    configuration: {
      auto_create_user: true,
      allowed_domains: 'company.com',
      default_roles: ['user'],
      sync_frequency: 24
    },
    syncUser: jest.fn(),
    batchSyncUsers: jest.fn(),
    updateConfiguration: jest.fn(),
    refreshUsers: jest.fn()
  }))
}));

describe('FeishuUserManagement', () => {
  const renderWithProviders = (component: React.ReactElement) => {
    return render(
      <Provider store={mockStore}>
        {component}
      </Provider>
    );
  };

  test('renders user management page', () => {
    renderWithProviders(<FeishuUserManagement />);

    expect(screen.getByText('Feishu User Management')).toBeInTheDocument();
    expect(screen.getByText('Total Feishu Users')).toBeInTheDocument();
    expect(screen.getByText('Test User')).toBeInTheDocument();
  });

  test('displays statistics correctly', () => {
    renderWithProviders(<FeishuUserManagement />);

    expect(screen.getByText('1')).toBeInTheDocument(); // total users
    expect(screen.getByText('Active Users')).toBeInTheDocument();
  });

  test('handles user sync', async () => {
    const mockSyncUser = jest.fn();
    require('../../hooks/useFeishuUserManagement').useFeishuUserManagement.mockReturnValue({
      ...require('../../hooks/useFeishuUserManagement').useFeishuUserManagement(),
      syncUser: mockSyncUser
    });

    renderWithProviders(<FeishuUserManagement />);

    const syncButton = screen.getByText('Sync');
    fireEvent.click(syncButton);

    await waitFor(() => {
      expect(mockSyncUser).toHaveBeenCalledWith('1');
    });
  });
});
```

### 任务3：文档和培训材料 (0.5天)

#### 3.1 创建用户手册
```markdown
# 飞书登录集成用户手册

## 概述

飞书登录集成为Pigeon Web平台提供了安全、便捷的单点登录(SSO)功能。用户可以使用飞书账号直接登录系统，无需记住额外的用户名和密码。

## 用户指南

### 首次使用飞书登录

1. **访问登录页面**
   - 在浏览器中打开 `https://pigeon.company.com/auth/login`
   - 您将看到标准登录表单和"Login with Feishu"按钮

2. **点击飞书登录**
   - 点击蓝色的"Login with Feishu"按钮
   - 系统将重定向您到飞书授权页面

3. **飞书授权**
   - 在飞书页面中，确认授权信息
   - 点击"授权"按钮允许应用访问您的基本信息

4. **完成登录**
   - 授权成功后，系统将自动重定向回Pigeon Web
   - 您将看到"Login Successful"消息
   - 几秒钟后自动跳转到主界面

### 账号关联

如果您已有Pigeon Web账号：
- 系统将根据邮箱地址自动关联您的飞书账号和现有账号
- 关联成功后，您可以使用飞书或传统方式登录

### 用户信息同步

飞书登录会自动同步以下信息：
- 姓名和英文名
- 邮箱地址
- 头像
- 手机号码（如果设置为公开）
- 部门信息

## 故障排除

### 常见问题

**Q: 点击飞书登录按钮后页面无响应**
A: 请检查：
- 浏览器是否阻止弹窗
- 网络连接是否正常
- 清除浏览器缓存后重试

**Q: 授权后显示"Login Failed"**
A: 可能原因：
- 您的邮箱域名不在允许列表中
- 系统正在维护
- 请联系管理员检查配置

**Q: 无法看到最新的飞书信息**
A: 信息同步可能需要一些时间，您可以：
- 退出登录后重新登录
- 联系管理员手动同步

### 安全提醒

- 确保在官方域名下进行登录
- 不要在公共电脑上保持登录状态
- 如发现异常登录活动，请立即联系管理员

## 联系支持

如需技术支持，请联系：
- 邮箱：support@company.com
- 内部工单系统
- 飞书群：Pigeon Web技术支持群
```

#### 3.2 创建管理员手册
```markdown
# 飞书登录集成管理员手册

## 管理界面

### 访问用户管理
1. 登录Pigeon Web管理后台
2. 导航到"系统管理" > "飞书用户管理"
3. 查看用户列表和统计信息

### 用户同步管理

#### 手动同步单个用户
1. 在用户列表中找到目标用户
2. 点击"Sync"按钮
3. 等待同步完成的提示

#### 批量同步用户
1. 选择需要同步的用户（勾选复选框）
2. 点击"Batch Sync"按钮
3. 确认同步操作
4. 监控同步进度和结果

#### 自动同步配置
1. 点击"Configuration"按钮
2. 设置同步频率（建议24小时）
3. 配置其他自动化选项

### 配置管理

#### 基础配置
- **自动创建用户**: 是否为新的飞书用户自动创建账号
- **允许的邮箱域名**: 限制可以登录的邮箱域名
- **默认角色**: 新用户的默认权限角色
- **同步频率**: 自动同步的时间间隔

#### 安全配置
- **IP白名单**: 限制登录来源IP
- **登录尝试限制**: 防暴力破解设置
- **会话超时**: 用户会话的有效期

### 监控和告警

#### 关键指标监控
- 登录成功率
- API响应时间
- 用户同步状态
- 系统错误率

#### 告警设置
- 登录失败率过高
- API响应时间过长
- 同步失败达到阈值
- 系统服务异常

### 故障排除

#### 常见问题处理

**用户无法登录**
1. 检查用户邮箱域名是否在允许列表中
2. 验证用户在飞书中的状态
3. 检查系统日志中的错误信息
4. 尝试手动同步用户信息

**同步失败**
1. 检查飞书API配置和密钥
2. 验证网络连接和防火墙设置
3. 查看错误日志确定具体原因
4. 重启相关服务组件

**性能问题**
1. 检查数据库和缓存状态
2. 监控系统资源使用情况
3. 优化同步频率和批量大小
4. 考虑扩展系统容量

### 运维操作

#### 日常维护
- 定期检查同步状态
- 监控系统性能指标
- 审查安全日志
- 更新配置和密钥

#### 应急响应
- 系统故障时的降级方案
- 安全事件的处理流程
- 数据恢复和备份策略
- 用户通知和沟通机制

## 最佳实践

### 安全建议
1. 定期轮换API密钥
2. 启用详细的审计日志
3. 配置合适的IP白名单
4. 监控异常登录模式

### 性能优化
1. 合理设置缓存TTL
2. 优化数据库查询
3. 使用批量操作
4. 监控和调整资源配置

### 用户体验
1. 提供清晰的错误提示
2. 优化登录流程
3. 及时同步用户信息
4. 提供便捷的支持渠道
```

**✅ 阶段测试3：文档完整性验证**
```bash
#!/bin/bash
# deployment/scripts/validate-documentation.sh

# Copyright(c) 2025
# All rights reserved.
#
# Author: yukun.xing <xingyukun@gmail.com>
# Date:   2025/09/19

echo "📚 Validating Feishu Integration Documentation..."

# 检查必需的文档文件
docs=(
    "docs/user-guide/feishu-login.md"
    "docs/admin-guide/feishu-management.md"
    "docs/api/feishu-endpoints.md"
    "docs/deployment/feishu-deployment.md"
    "docs/troubleshooting/feishu-issues.md"
)

echo "📋 Checking required documentation files..."
for doc in "${docs[@]}"; do
    if [[ -f "$doc" ]]; then
        echo "✅ $doc exists"
    else
        echo "❌ $doc is missing"
        exit 1
    fi
done

# 检查文档内容完整性
echo "🔍 Checking documentation content..."

# 检查用户手册关键章节
if grep -q "首次使用飞书登录" "docs/user-guide/feishu-login.md"; then
    echo "✅ User guide contains login instructions"
else
    echo "❌ User guide missing login instructions"
fi

# 检查管理员手册关键章节
if grep -q "用户同步管理" "docs/admin-guide/feishu-management.md"; then
    echo "✅ Admin guide contains sync management"
else
    echo "❌ Admin guide missing sync management"
fi

# 验证API文档
if grep -q "/api/v1/feishu-auth" "docs/api/feishu-endpoints.md"; then
    echo "✅ API documentation contains endpoints"
else
    echo "❌ API documentation missing endpoints"
fi

echo "✅ Documentation validation completed!"
```

## 🎯 阶段交付物

### 部署工具
- [ ] 生产环境配置文件和脚本
- [ ] 自动化部署脚本
- [ ] 监控和告警配置
- [ ] 健康检查和测试脚本

### 管理界面
- [ ] 飞书用户管理页面
- [ ] 配置管理界面
- [ ] 统计和监控面板
- [ ] 管理Hook和API集成

### 文档材料
- [ ] 用户使用手册
- [ ] 管理员操作指南
- [ ] API接口文档
- [ ] 故障排除指南
- [ ] 部署和运维手册

### 运维工具
- [ ] 数据库迁移脚本
- [ ] 缓存管理工具
- [ ] 日志分析脚本
- [ ] 性能监控工具

## 📈 成功标准

1. **部署自动化**：一键部署成功率100%，回滚时间 < 5分钟
2. **管理便捷性**：管理员可通过界面完成所有配置和管理任务
3. **文档完整性**：用户和管理员能通过文档独立完成所有操作
4. **运维友好**：提供完整的监控、日志和故障排除工具
5. **用户满意度**：登录成功率 > 99%，用户反馈良好

---

**预计完成时间**：2-3天
**关键依赖**：第1、2、3、4阶段完成
**最终成果**：完整可用的飞书登录集成系统，ready for production