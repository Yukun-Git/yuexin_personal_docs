# ğŸ“‹ **Pigeon SMSç³»ç»ŸIDæ˜ å°„å…³ç³»è¯¦ç»†æŠ¥å‘Š**

## ğŸ“Š **æŠ¥å‘Šæ¦‚è¿°**

æœ¬æŠ¥å‘Šè¯¦ç»†åˆ†æäº†Pigeon SMSç³»ç»Ÿä¸­`sms.short_messages`å’Œ`sms.delivers`ä¸¤ä¸ªæ ¸å¿ƒè¡¨ä¸­æ‰€æœ‰IDå­—æ®µçš„åˆ›å»ºã€æ›´æ–°å’Œå…³è”æœºåˆ¶ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„é•¿çŸ­ä¿¡å¤„ç†ç¤ºä¾‹æ¥å±•ç¤ºæ•´ä¸ªIDç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

---

## ğŸ”§ **1. IDåˆ›å»ºæœºåˆ¶åˆ†æ**

### **1.1 MessageIDç”Ÿæˆå™¨ (`protocol/utils/message_id_generator.go`)**

```go
type MessageID struct {
    prefix      string    // é€šé“/ç½‘å…³å‰ç¼€ (8ä½)
    timeStr     string    // æ—¶é—´æˆ³ (10ä½: mmddhhmmss)
    sequenceNum int32     // åºåˆ—å· (8ä½: 00000001-99999999)
}

// æ ¼å¼: xxxxxxxx-mmddhhmmss-yyyyyyyy
// ç¤ºä¾‹: GATEWAY1-250930143822-00001234
```

**ç”Ÿæˆç­–ç•¥**:
- **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨`atomic.Int32`ä¿è¯å¹¶å‘å®‰å…¨
- **å”¯ä¸€æ€§**: æ—¶é—´æˆ³+è‡ªå¢åºåˆ—å·ç¡®ä¿å”¯ä¸€æ€§
- **å¾ªç¯é‡ç½®**: åºåˆ—å·è¶…è¿‡99999999æ—¶é‡ç½®ä¸º1

### **1.2 åˆ†æ®µæ¶ˆæ¯IDç”Ÿæˆ (`base/utils/long_message_key.go`)**

```go
func NewSegMessageID(parentMsgID string, segNum int) string {
    return fmt.Sprintf("%s_%d", parentMsgID, segNum)
}

// ç¤ºä¾‹: GATEWAY1-250930143822-00001234_1
//       GATEWAY1-250930143822-00001234_2
```

---

## ğŸ—„ï¸ **2. æ•°æ®åº“è¡¨ç»“æ„åˆ†æ**

### **2.1 sms.short_messagesè¡¨IDå­—æ®µ**

| å­—æ®µå | æ•°æ®ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|----------|------|--------|
| `message_id` | VARCHAR(255) PRIMARY KEY | ä¸»æ¶ˆæ¯ID | `GATEWAY1-250930143822-00001234` |
| `channel_msg_id` | VARCHAR(255) | é€šé“è¿”å›çš„æ¶ˆæ¯ID | `CHNL001-20250930-98765432` |
| `gateway_code` | VARCHAR(50) | ç½‘å…³ä»£ç  | `GATEWAY1-250930143822-00001234` |

### **2.2 sms.deliversè¡¨IDå­—æ®µ**

| å­—æ®µå | æ•°æ®ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|----------|------|--------|
| `message_id` | VARCHAR(255) PRIMARY KEY | ä¸short_messageså…³è”çš„ä¸»ID | `GATEWAY1-250930143822-00001234` |
| `channel_msg_id` | VARCHAR(255) | é€šé“æ¶ˆæ¯ID(æ¥è‡ªè¿è¥å•†) | `CHNL001-20250930-98765432` |
| `gateway_msg_id` | VARCHAR(255) | ç½‘å…³æ¶ˆæ¯ID(å‘ç»™å®¢æˆ·ç«¯) | `GATEWAY1-250930143822-00001234` |

### **2.3 é€šé“è¿”å›çš„æ¶ˆæ¯IDè¯¦è§£**

#### **ä»€ä¹ˆæ˜¯"é€šé“"ï¼Ÿ**

åœ¨pigeonç³»ç»Ÿä¸­ï¼Œ**"é€šé“"æŒ‡çš„æ˜¯SMSè¿è¥å•†æˆ–ç¬¬ä¸‰æ–¹çŸ­ä¿¡æœåŠ¡æä¾›å•†**ï¼Œæ¯”å¦‚ï¼š
- ä¸­å›½ç§»åŠ¨ã€è”é€šã€ç”µä¿¡çš„SMPPæ¥å£
- ç¬¬ä¸‰æ–¹çŸ­ä¿¡å¹³å°ï¼ˆå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘SMSæœåŠ¡ï¼‰
- å›½é™…è¿è¥å•†æ¥å£

#### **ä¸ºä»€ä¹ˆä¼šæœ‰"é€šé“è¿”å›çš„æ¶ˆæ¯ID"ï¼Ÿ**

**åŸå› **: æ¯ä¸ªè¿è¥å•†éƒ½æœ‰è‡ªå·±çš„æ¶ˆæ¯IDç”Ÿæˆè§„åˆ™å’Œæ ¼å¼

**æµç¨‹è§£é‡Š**:
```
1. Pigeonç”Ÿæˆå†…éƒ¨ID: GATEWAY1-250930143822-00001234
2. å‘é€ç»™è¿è¥å•†é€šé“: "è¯·å‘é€è¿™æ¡çŸ­ä¿¡"
3. è¿è¥å•†æ¥æ”¶åç”Ÿæˆè‡ªå·±çš„ID: CHNL001-20250930-98765432
4. è¿è¥å•†è¿”å›: "æˆ‘å·²æ¥æ”¶ï¼Œæˆ‘çš„æ¶ˆæ¯IDæ˜¯ CHNL001-20250930-98765432"
5. Pigeonä¿å­˜: channel_msg_id = CHNL001-20250930-98765432
```

#### **å…·ä½“ä»£ç ä½“ç°**

åœ¨ `channel_worker/usecase/processor.go:315-325` ä¸­ï¼š

```go
func (u *channelProcessorU) ReceiveSubmitResponse(
    sm *models.ShortMessage, status modelErr.SubmitResponseStatus) {

    if status == modelErr.SubmitSuccess {
        // è¿™é‡Œå»ºç«‹æ˜ å°„ï¼šè¿è¥å•†ID â†’ pigeonå†…éƒ¨ID
        u.cacheRepo.SetMsgIDMapping(
            u.channel.ChannelID,
            sm.ChannelMsgID,    // è¿è¥å•†è¿”å›çš„ID
            sm.MessageID)       // pigeonå†…éƒ¨ID
    }
}
```

#### **ä¸ºä»€ä¹ˆéœ€è¦ä¿å­˜è¿è¥å•†çš„IDï¼Ÿ**

**å…³é”®åŸå› **: **çŠ¶æ€æŠ¥å‘Šè¯†åˆ«**

å½“è¿è¥å•†å‘é€æŠ•é€’çŠ¶æ€æŠ¥å‘Šæ—¶ï¼Œä»–ä»¬ä¼šè¯´ï¼š
- "æ¶ˆæ¯ `CHNL001-20250930-98765432` å·²æŠ•é€’æˆåŠŸ"
- è€Œä¸ä¼šè¯´ "æ¶ˆæ¯ `GATEWAY1-250930143822-00001234` å·²æŠ•é€’æˆåŠŸ"

å› ä¸ºè¿è¥å•†ä¸çŸ¥é“pigeonå†…éƒ¨çš„IDæ ¼å¼ã€‚

#### **å®é™…ä¾‹å­å¯¹æ¯”**

| ç³»ç»Ÿ | IDæ ¼å¼ | ç¤ºä¾‹ | è¯´æ˜ |
|------|--------|------|------|
| **Pigeonå†…éƒ¨** | `å‰ç¼€-æ—¶é—´æˆ³-åºåˆ—å·` | `GATEWAY1-250930143822-00001234` | ç»Ÿä¸€æ ¼å¼ï¼Œä¾¿äºè¿½è¸ª |
| **ä¸­å›½ç§»åŠ¨** | `è¿è¥å•†å‰ç¼€+æ•°å­—` | `CMCC20250930001234567` | ç§»åŠ¨å†…éƒ¨æ ¼å¼ |
| **é˜¿é‡Œäº‘SMS** | `bizIdæ ¼å¼` | `ALY123456789^1234567890` | é˜¿é‡Œäº‘æ ¼å¼ |
| **å›½é™…è¿è¥å•†** | `å„è‡ªæ ‡å‡†` | `INTL-GB-20250930-789` | å›½é™…æ ‡å‡†æ ¼å¼ |

#### **æ˜ å°„å…³ç³»çš„é‡è¦æ€§**

```
Pigeonå‘é€æ—¶:
message_id: GATEWAY1-250930143822-00001234
    â†“ å‘é€ç»™è¿è¥å•†
è¿è¥å•†è¿”å›:
channel_msg_id: CHNL001-20250930-98765432

çŠ¶æ€æŠ¥å‘Šæ—¶:
è¿è¥å•†å‘é€: "CHNL001-20250930-98765432 å·²æŠ•é€’"
    â†“ pigeonæŸ¥æ‰¾æ˜ å°„
pigeonæ‰¾åˆ°: GATEWAY1-250930143822-00001234
    â†“ é€šçŸ¥å®¢æˆ·ç«¯
å®¢æˆ·ç«¯æ”¶åˆ°: "GATEWAY1-250930143822-00001234 å·²æŠ•é€’"
```

**æ€»ç»“**: `channel_msg_id` å°±æ˜¯**è¿è¥å•†åœ¨æ¥æ”¶åˆ°pigeonçš„çŸ­ä¿¡å‘é€è¯·æ±‚åï¼Œç”±è¿è¥å•†è‡ªå·±ç”Ÿæˆå¹¶è¿”å›ç»™pigeonçš„æ¶ˆæ¯æ ‡è¯†ID**ã€‚è¿™ä¸ªIDæ˜¯è¿è¥å•†åç»­å‘é€çŠ¶æ€æŠ¥å‘Šæ—¶ç”¨æ¥æ ‡è¯†æ¶ˆæ¯çš„å”¯ä¸€å‡­è¯ã€‚

---

## ğŸ”„ **3. IDå…³è”æœºåˆ¶è¯¦è§£**

### **3.1 IDæ˜ å°„ç¼“å­˜æœºåˆ¶**

**å»ºç«‹æ˜ å°„** (`channel_worker/usecase/processor.go:323-324`):
```go
u.cacheRepo.SetMsgIDMapping(
    u.channel.ChannelID, sm.ChannelMsgID, sm.MessageID)
```

**æŸ¥æ‰¾æ˜ å°„** (`channel_worker/usecase/processor.go:405-406`):
```go
msgID, err := u.cacheRepo.GetMsgIDMapping(
    u.channel.ChannelID, deliver.ChannelMsgID)
```

### **3.2 å…³è”å…³ç³»å›¾**

```
sms.short_messages                    sms.delivers
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ message_id      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ message_id      â”‚
â”‚ channel_msg_id  â”‚                  â”‚ channel_msg_id  â”‚
â”‚ gateway_code    â”‚                  â”‚ gateway_msg_id  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                                    â–²
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç¼“å­˜æ˜ å°„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ **4. å®Œæ•´é•¿çŸ­ä¿¡å¤„ç†ç¤ºä¾‹**

### **4.1 åœºæ™¯è®¾å®š**

**ç”¨æˆ·æ“ä½œ**: å‘é€ä¸€æ¡é•¿çŸ­ä¿¡ï¼Œå®¢æˆ·ç«¯åˆ†æˆ4ä¸ªç‰‡æ®µå‘é€ç»™Pigeon
**Pigeonå¤„ç†**: åˆå¹¶4ä¸ªç‰‡æ®µä¸º1æ¡å®Œæ•´æ¶ˆæ¯
**é€šé“é™åˆ¶**: æ ¹æ®é€šé“èƒ½åŠ›æ‹†åˆ†ä¸º5ä¸ªç‰‡æ®µå‘é€
**ç»“æœ**: 5ä¸ªç‰‡æ®µéƒ½æ”¶åˆ°æŠ•é€’å›æ‰§

### **4.2 è¯¦ç»†å¤„ç†æµç¨‹**

#### **é˜¶æ®µ1: å®¢æˆ·ç«¯åˆ†æ®µå‘é€ (4ä¸ªç‰‡æ®µ)**

**æ­¥éª¤1**: å®¢æˆ·ç«¯å‘é€4ä¸ªåˆ†æ®µæ¶ˆæ¯åˆ°Gateway

```
ç‰‡æ®µ1: message_id = "GATEWAY1-250930143822-00001234_1"
ç‰‡æ®µ2: message_id = "GATEWAY1-250930143822-00001234_2"
ç‰‡æ®µ3: message_id = "GATEWAY1-250930143822-00001234_3"
ç‰‡æ®µ4: message_id = "GATEWAY1-250930143822-00001234_4"
```

**æ•°æ®å­˜å‚¨** (`sms.short_messages`):
```sql
INSERT INTO sms.short_messages (
    message_id,
    gateway_code,
    "gateway_segment_info.is_parent",
    "gateway_segment_info.parent_message_id",
    "gateway_segment_info.reference_id",
    "gateway_segment_info.total_segments",
    "gateway_segment_info.segment_num",
    content
) VALUES
('GATEWAY1-250930143822-00001234_1', 'GATEWAY1-250930143822-00001234', false, '', 12345, 4, 1, 'å†…å®¹ç‰‡æ®µ1'),
('GATEWAY1-250930143822-00001234_2', 'GATEWAY1-250930143822-00001234', false, '', 12345, 4, 2, 'å†…å®¹ç‰‡æ®µ2'),
('GATEWAY1-250930143822-00001234_3', 'GATEWAY1-250930143822-00001234', false, '', 12345, 4, 3, 'å†…å®¹ç‰‡æ®µ3'),
('GATEWAY1-250930143822-00001234_4', 'GATEWAY1-250930143822-00001234', false, '', 12345, 4, 4, 'å†…å®¹ç‰‡æ®µ4');
```

#### **é˜¶æ®µ2: Gatewayé•¿çŸ­ä¿¡åˆå¹¶**

**æ­¥éª¤2**: Gatewayæ£€æµ‹åˆ°é•¿çŸ­ä¿¡ï¼Œè§¦å‘åˆå¹¶é€»è¾‘ (`gateway/usecase/long_message.go:209-242`)

**åˆå¹¶è¿‡ç¨‹**:
1. **ç”Ÿæˆæ–°çš„çˆ¶æ¶ˆæ¯ID**:
   ```go
   msgID := protocolUtils.MessageIDGenerator.Generate("GATEWAY1")
   // ç»“æœ: "GATEWAY1-250930143824-00001235"
   ```

2. **åˆ›å»ºçˆ¶æ¶ˆæ¯è®°å½•**:
   ```sql
   INSERT INTO sms.short_messages (
       message_id,
       gateway_code,
       "gateway_segment_info.is_parent",
       "gateway_segment_info.sub_message_ids",
       "gateway_segment_info.total_segments",
       "gateway_segment_info.reference_id",
       content
   ) VALUES (
       'GATEWAY1-250930143824-00001235',
       'GATEWAY1',
       true,
       '["GATEWAY1-250930143822-00001234_1","GATEWAY1-250930143822-00001234_2","GATEWAY1-250930143822-00001234_3","GATEWAY1-250930143822-00001234_4"]',
       4,
       12345,
       'å†…å®¹ç‰‡æ®µ1å†…å®¹ç‰‡æ®µ2å†…å®¹ç‰‡æ®µ3å†…å®¹ç‰‡æ®µ4'
   );
   ```

3. **æ›´æ–°å­æ¶ˆæ¯å…³è”**:
   ```sql
   UPDATE sms.short_messages SET
       "gateway_segment_info.parent_message_id" = 'GATEWAY1-250930143824-00001235'
   WHERE message_id IN (
       'GATEWAY1-250930143822-00001234_1',
       'GATEWAY1-250930143822-00001234_2',
       'GATEWAY1-250930143822-00001234_3',
       'GATEWAY1-250930143822-00001234_4'
   );
   ```

#### **é˜¶æ®µ3: Channel Workeræ‹†åˆ†å‘é€ (5ä¸ªç‰‡æ®µ)**

**æ­¥éª¤3**: Channel Workeræ¥æ”¶åˆ°åˆå¹¶æ¶ˆæ¯ï¼Œæ ¹æ®é€šé“é™åˆ¶æ‹†åˆ† (`channel_worker/usecase/processor.go:198-244`)

**æ‹†åˆ†è¿‡ç¨‹**:
1. **ç”Ÿæˆåˆ†æ®µæ¶ˆæ¯ID**:
   ```go
   // çˆ¶æ¶ˆæ¯ID: GATEWAY1-250930143824-00001235
   subMsg1.MessageID = "GATEWAY1-250930143824-00001235_1"
   subMsg2.MessageID = "GATEWAY1-250930143824-00001235_2"
   subMsg3.MessageID = "GATEWAY1-250930143824-00001235_3"
   subMsg4.MessageID = "GATEWAY1-250930143824-00001235_4"
   subMsg5.MessageID = "GATEWAY1-250930143824-00001235_5"
   ```

2. **ç”Ÿæˆæ–°çš„å¼•ç”¨ID**:
   ```go
   referenceID := utils.NewLongMessageReferenceID() // ä¾‹å¦‚: 54321
   ```

3. **åˆ›å»ºå­æ¶ˆæ¯è®°å½•**:
   ```sql
   INSERT INTO sms.short_messages (
       message_id,
       channel_msg_id,
       "channel_segment_info.is_parent",
       "channel_segment_info.parent_message_id",
       "channel_segment_info.reference_id",
       "channel_segment_info.total_segments",
       "channel_segment_info.segment_num",
       content
   ) VALUES
   ('GATEWAY1-250930143824-00001235_1', '', false, 'GATEWAY1-250930143824-00001235', 54321, 5, 1, 'æ‹†åˆ†å†…å®¹1'),
   ('GATEWAY1-250930143824-00001235_2', '', false, 'GATEWAY1-250930143824-00001235', 54321, 5, 2, 'æ‹†åˆ†å†…å®¹2'),
   ('GATEWAY1-250930143824-00001235_3', '', false, 'GATEWAY1-250930143824-00001235', 54321, 5, 3, 'æ‹†åˆ†å†…å®¹3'),
   ('GATEWAY1-250930143824-00001235_4', '', false, 'GATEWAY1-250930143824-00001235', 54321, 5, 4, 'æ‹†åˆ†å†…å®¹4'),
   ('GATEWAY1-250930143824-00001235_5', '', false, 'GATEWAY1-250930143824-00001235', 54321, 5, 5, 'æ‹†åˆ†å†…å®¹5');
   ```

4. **æ›´æ–°çˆ¶æ¶ˆæ¯ä¿¡æ¯**:
   ```sql
   UPDATE sms.short_messages SET
       "channel_segment_info.is_parent" = true,
       "channel_segment_info.sub_message_ids" = '["GATEWAY1-250930143824-00001235_1","GATEWAY1-250930143824-00001235_2","GATEWAY1-250930143824-00001235_3","GATEWAY1-250930143824-00001235_4","GATEWAY1-250930143824-00001235_5"]',
       "channel_segment_info.total_segments" = 5,
       "channel_segment_info.reference_id" = 54321
   WHERE message_id = 'GATEWAY1-250930143824-00001235';
   ```

#### **é˜¶æ®µ4: å‘é€åˆ°è¿è¥å•†å¹¶å»ºç«‹æ˜ å°„**

**æ­¥éª¤4**: å‘è¿è¥å•†å‘é€5ä¸ªç‰‡æ®µï¼Œæ”¶åˆ°Submit Responseåå»ºç«‹IDæ˜ å°„

**è¿è¥å•†è¿”å›çš„Channel Message IDs**:
```
CHNL001-20250930-98765431 â†’ GATEWAY1-250930143824-00001235_1
CHNL001-20250930-98765432 â†’ GATEWAY1-250930143824-00001235_2
CHNL001-20250930-98765433 â†’ GATEWAY1-250930143824-00001235_3
CHNL001-20250930-98765434 â†’ GATEWAY1-250930143824-00001235_4
CHNL001-20250930-98765435 â†’ GATEWAY1-250930143824-00001235_5
```

**å»ºç«‹ç¼“å­˜æ˜ å°„** (`channel_worker/usecase/processor.go:323-324`):
```go
// ä¸ºæ¯ä¸ªç‰‡æ®µå»ºç«‹æ˜ å°„
u.cacheRepo.SetMsgIDMapping("CHNL001", "CHNL001-20250930-98765431", "GATEWAY1-250930143824-00001235_1")
u.cacheRepo.SetMsgIDMapping("CHNL001", "CHNL001-20250930-98765432", "GATEWAY1-250930143824-00001235_2")
u.cacheRepo.SetMsgIDMapping("CHNL001", "CHNL001-20250930-98765433", "GATEWAY1-250930143824-00001235_3")
u.cacheRepo.SetMsgIDMapping("CHNL001", "CHNL001-20250930-98765434", "GATEWAY1-250930143824-00001235_4")
u.cacheRepo.SetMsgIDMapping("CHNL001", "CHNL001-20250930-98765435", "GATEWAY1-250930143824-00001235_5")
```

**æ›´æ–°short_messagesè¡¨**:
```sql
UPDATE sms.short_messages SET
    channel_msg_id = 'CHNL001-20250930-98765431',
    status = 'ChannelSendSuccess'
WHERE message_id = 'GATEWAY1-250930143824-00001235_1';

-- å¯¹å…¶ä»–4ä¸ªç‰‡æ®µæ‰§è¡Œç±»ä¼¼æ›´æ–°...
```

#### **é˜¶æ®µ5: æ¥æ”¶æŠ•é€’å›æ‰§å¹¶åˆ›å»ºDeliverè®°å½•**

**æ­¥éª¤5**: è¿è¥å•†å‘é€5ä¸ªæŠ•é€’å›æ‰§ï¼ŒChannel Workerå¤„ç† (`channel_worker/usecase/processor.go:403-427`)

**å›æ‰§å¤„ç†è¿‡ç¨‹**:

1. **ç‰‡æ®µ1å›æ‰§å¤„ç†**:
   ```go
   // æ”¶åˆ°å›æ‰§: channel_msg_id = "CHNL001-20250930-98765431"
   // æŸ¥æ‰¾æ˜ å°„
   msgID, err := u.cacheRepo.GetMsgIDMapping("CHNL001", "CHNL001-20250930-98765431")
   // ç»“æœ: msgID = "GATEWAY1-250930143824-00001235_1"

   // è®¾ç½®deliverå­—æ®µ
   deliver.MessageID = "GATEWAY1-250930143824-00001235_1"
   deliver.ChannelMsgID = "CHNL001-20250930-98765431"
   deliver.GatewayMsgID = "GATEWAY1-250930143824-00001235_1"
   ```

2. **åˆ›å»ºDeliverè®°å½•**:
   ```sql
   INSERT INTO sms.delivers (
       message_id,
       channel_id,
       channel_msg_id,
       gateway_msg_id,
       gateway_code,
       account_id,
       deliver_type,
       receipt_code,
       content,
       status
   ) VALUES (
       'GATEWAY1-250930143824-00001235_1',
       'CHNL001',
       'CHNL001-20250930-98765431',
       'GATEWAY1-250930143824-00001235_1',
       'DELIVERED',
       'ACCT001',
       'DeliverReceipt',
       '000',
       'id:CHNL001-20250930-98765431 submit date:2409301438 done date:2409301439 stat:DELIVRD err:000',
       'ChannelReceived'
   );
   ```

3. **ä¸ºå…¶ä½™4ä¸ªç‰‡æ®µåˆ›å»ºç±»ä¼¼çš„Deliverè®°å½•**...

#### **é˜¶æ®µ6: é•¿çŸ­ä¿¡å­ç‰‡æ®µå¤„ç†ç‰¹æ®Šé€»è¾‘**

**æ­¥éª¤6**: Deliver Workerå¤„ç†é•¿çŸ­ä¿¡å­ç‰‡æ®µå›æ‰§ (`deliver_worker/usecase/usecase.go:238-276`)

**ç‰¹æ®Šå¤„ç†é€»è¾‘**:

1. **å­ç‰‡æ®µGateway IDæ˜ å°„**:
   ```go
   // å¯¹äºå­ç‰‡æ®µ GATEWAY1-250930143824-00001235_1
   parentMsgID, segNum, err := utils.ParseSegMessageID("GATEWAY1-250930143824-00001235_1")
   // parentMsgID = "GATEWAY1-250930143824-00001235"
   // segNum = 1

   // è·å–çˆ¶æ¶ˆæ¯çš„Gatewayåˆ†æ®µä¿¡æ¯
   parentSM := getShortMessageByMsgID("GATEWAY1-250930143824-00001235")
   segInfo := parentSM.GatewaySegmentInfo

   // è®¾ç½®æ­£ç¡®çš„Gateway Message ID
   deliver.GatewayMsgID = segInfo.SubMesaageageIDs[segNum-1]
   // ç»“æœ: "GATEWAY1-250930143822-00001234_1"
   ```

2. **æœ€ç»ˆDeliverè®°å½•æ›´æ–°**:
   ```sql
   UPDATE sms.delivers SET
       gateway_msg_id = 'GATEWAY1-250930143822-00001234_1'
   WHERE message_id = 'GATEWAY1-250930143824-00001235_1';
   ```

---

## ğŸ“Š **5. å®Œæ•´IDæ˜ å°„è¡¨**

### **5.1 æœ€ç»ˆæ•°æ®çŠ¶æ€**

#### **short_messagesè¡¨ (10æ¡è®°å½•)**

| message_id | channel_msg_id | gateway_code | è¯´æ˜ |
|------------|----------------|--------------|------|
| `GATEWAY1-250930143822-00001234_1` | - | `GATEWAY1-250930143822-00001234` | å®¢æˆ·ç«¯ç‰‡æ®µ1 |
| `GATEWAY1-250930143822-00001234_2` | - | `GATEWAY1-250930143822-00001234` | å®¢æˆ·ç«¯ç‰‡æ®µ2 |
| `GATEWAY1-250930143822-00001234_3` | - | `GATEWAY1-250930143822-00001234` | å®¢æˆ·ç«¯ç‰‡æ®µ3 |
| `GATEWAY1-250930143822-00001234_4` | - | `GATEWAY1-250930143822-00001234` | å®¢æˆ·ç«¯ç‰‡æ®µ4 |
| `GATEWAY1-250930143824-00001235` | - | `GATEWAY1` | åˆå¹¶åçš„çˆ¶æ¶ˆæ¯ |
| `GATEWAY1-250930143824-00001235_1` | `CHNL001-20250930-98765431` | `GATEWAY1` | é€šé“ç‰‡æ®µ1 |
| `GATEWAY1-250930143824-00001235_2` | `CHNL001-20250930-98765432` | `GATEWAY1` | é€šé“ç‰‡æ®µ2 |
| `GATEWAY1-250930143824-00001235_3` | `CHNL001-20250930-98765433` | `GATEWAY1` | é€šé“ç‰‡æ®µ3 |
| `GATEWAY1-250930143824-00001235_4` | `CHNL001-20250930-98765434` | `GATEWAY1` | é€šé“ç‰‡æ®µ4 |
| `GATEWAY1-250930143824-00001235_5` | `CHNL001-20250930-98765435` | `GATEWAY1` | é€šé“ç‰‡æ®µ5 |

#### **deliversè¡¨ (5æ¡è®°å½•)**

| message_id | channel_msg_id | gateway_msg_id | è¯´æ˜ |
|------------|----------------|----------------|------|
| `GATEWAY1-250930143824-00001235_1` | `CHNL001-20250930-98765431` | `GATEWAY1-250930143822-00001234_1` | å›æ‰§1 |
| `GATEWAY1-250930143824-00001235_2` | `CHNL001-20250930-98765432` | `GATEWAY1-250930143822-00001234_2` | å›æ‰§2 |
| `GATEWAY1-250930143824-00001235_3` | `CHNL001-20250930-98765433` | `GATEWAY1-250930143822-00001234_3` | å›æ‰§3 |
| `GATEWAY1-250930143824-00001235_4` | `CHNL001-20250930-98765434` | `GATEWAY1-250930143822-00001234_4` | å›æ‰§4 |
| `GATEWAY1-250930143824-00001235_5` | `CHNL001-20250930-98765435` | `GATEWAY1-250930143822-00001234_1` | å›æ‰§5(æ˜ å°„åˆ°ç‰‡æ®µ1) |

### **5.2 å…³é”®å…³è”å…³ç³»**

```
ä¸¤è¡¨å…³è”: delivers.message_id â†â†’ short_messages.message_id

IDå±‚æ¬¡ç»“æ„:
å®¢æˆ·ç«¯å±‚é¢: GATEWAY1-250930143822-00001234_{1,2,3,4}
  â†“ (åˆå¹¶)
ç³»ç»Ÿå†…éƒ¨: GATEWAY1-250930143824-00001235
  â†“ (æ‹†åˆ†)
é€šé“å±‚é¢: GATEWAY1-250930143824-00001235_{1,2,3,4,5}
  â†“ (å›æ‰§)
å›æ‰§å…³è”: é€šè¿‡message_idå…³è”ï¼Œgateway_msg_idæŒ‡å‘åŸå§‹å®¢æˆ·ç«¯ç‰‡æ®µ
```

---

## ğŸ¯ **6. æ ¸å¿ƒå‘ç°ä¸æ€»ç»“**

### **6.1 IDç®¡ç†çš„å…³é”®ç‰¹ç‚¹**

1. **ä¸‰å±‚IDä½“ç³»**:
   - **Client Layer**: å®¢æˆ·ç«¯åŸå§‹åˆ†æ®µID
   - **System Layer**: ç³»ç»Ÿå†…éƒ¨åˆå¹¶åçš„å®Œæ•´æ¶ˆæ¯ID
   - **Channel Layer**: æ ¹æ®é€šé“èƒ½åŠ›é‡æ–°æ‹†åˆ†çš„ID

2. **åŒå‘æ˜ å°„æœºåˆ¶**:
   - **Cacheæ˜ å°„**: `channel_msg_id` â†” `message_id`
   - **æ•°æ®åº“å…³è”**: `delivers.message_id` â†” `short_messages.message_id`

3. **é•¿çŸ­ä¿¡ç‰¹æ®Šå¤„ç†**:
   - **Gatewayåˆ†æ®µ**: å®¢æˆ·ç«¯é•¿çŸ­ä¿¡åˆå¹¶å¤„ç†
   - **Channelåˆ†æ®µ**: æ ¹æ®é€šé“é™åˆ¶é‡æ–°æ‹†åˆ†
   - **å›æ‰§æ˜ å°„**: å›æ‰§é€šè¿‡å¤æ‚é€»è¾‘æ˜ å°„å›åŸå§‹å®¢æˆ·ç«¯ç‰‡æ®µ

### **6.2 æ•°æ®ä¸€è‡´æ€§ä¿è¯**

1. **åŸå­æ€§æ“ä½œ**: ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿å¤šæ¡è®°å½•åŒæ—¶æˆåŠŸ
2. **ç¼“å­˜åŒæ­¥**: IDæ˜ å°„åŒæ—¶æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“
3. **å®¹é”™æœºåˆ¶**: é€šè¿‡waiting listå¤„ç†å›æ‰§å»¶è¿Ÿåˆ°è¾¾

### **6.3 æ€§èƒ½ä¼˜åŒ–è®¾è®¡**

1. **IDç”Ÿæˆå™¨**: ä½¿ç”¨åŸå­æ“ä½œé¿å…é”ç«äº‰
2. **ç¼“å­˜ä¼˜å…ˆ**: å›æ‰§å¤„ç†ä¼˜å…ˆæŸ¥è¯¢ç¼“å­˜æ˜ å°„
3. **æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡åˆ›å»ºå’Œæ›´æ–°å‡å°‘æ•°æ®åº“å‹åŠ›

è¿™å¥—IDç®¡ç†æœºåˆ¶ç¡®ä¿äº†ä»å®¢æˆ·ç«¯åˆ†æ®µå‘é€åˆ°è¿è¥å•†æŠ•é€’å†åˆ°å›æ‰§åé¦ˆçš„å®Œæ•´é“¾è·¯è¿½è¸ªï¼Œæ”¯æŒå¤æ‚çš„é•¿çŸ­ä¿¡åˆå¹¶æ‹†åˆ†åœºæ™¯ï¼ŒåŒæ—¶ä¿è¯äº†é«˜æ€§èƒ½å’Œæ•°æ®ä¸€è‡´æ€§ã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-09-30
**åˆ†ææ·±åº¦**: å®Œæ•´æºç åˆ†æ
**è¦†ç›–èŒƒå›´**: Gatewayã€Channel Workerã€Deliver Workerå…¨é“¾è·¯
**ç¤ºä¾‹å®Œæ•´æ€§**: åŒ…å«4â†’1â†’5é•¿çŸ­ä¿¡å®Œæ•´å¤„ç†æµç¨‹