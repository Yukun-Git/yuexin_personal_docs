# SMSæ¨¡å— V1 vs V2 åŠŸèƒ½å®Œæ•´æ€§æŠ¥å‘Š

> ç”Ÿæˆæ—¶é—´ï¼š2025-10-29
> çŠ¶æ€ï¼šå·²ç¡®è®¤
> ç›®çš„ï¼šè¯„ä¼°SMSæ¨¡å—V2æ˜¯å¦å¯ä»¥å®Œå…¨æ›¿ä»£V1

---

## ä¸€ã€åŠŸèƒ½å¯¹æ¯”æ€»è§ˆ

### 1.1 ç«¯ç‚¹å¯¹æ¯”è¡¨

| åŠŸèƒ½æ¨¡å— | V1ç«¯ç‚¹ | V2ç«¯ç‚¹ | çŠ¶æ€ | å‰ç«¯ä½¿ç”¨æƒ…å†µ | è¯´æ˜ |
|---------|--------|--------|------|--------------|------|
| **å‘ä»¶ç®±åˆ—è¡¨** | `GET /api/v1/sms/outbox` | `GET /api/v1/sms/v2/outbox` | âœ… **å·²æ›¿ä»£** | âœ… ä½¿ç”¨V2 | V2æ”¯æŒæ‹†åˆ†çŸ­ä¿¡æ˜¾ç¤º |
| **å‘ä»¶ç®±è¯¦æƒ…** | `GET /api/v1/sms/outbox/<id>` | `GET /api/v1/sms/v2/outbox/<id>` | âœ… **å·²æ›¿ä»£** | âœ… ä½¿ç”¨V2 | V2åŒ…å«å®Œæ•´timeline |
| **å‘ä»¶ç®±å¯¼å‡º** | `POST /api/v1/sms/outbox/export` | `POST /api/v1/sms/v2/outbox/export` | âœ… **å·²æ›¿ä»£** | âœ… ä½¿ç”¨V2 | V2æ”¯æŒmerge/splitæ¨¡å¼ |
| **æ¶ˆæ¯è´¹ç”¨æŸ¥è¯¢** | `GET /api/v1/sms/outbox/<id>/cost` | âŒ æ— V2ç‰ˆæœ¬ | âš ï¸ **ç¼ºå¤±** | âŒ æœªä½¿ç”¨ | ä½†å‰ç«¯éœ€è¦costæ•°æ® |
| **å›æ‰§é‡å‘** | âŒ æ— V1ç‰ˆæœ¬ | `POST /api/v1/sms/v2/outbox/<id>/resend-receipt` | â• **V2æ–°å¢** | âœ… ä½¿ç”¨ | V2ç‹¬æœ‰åŠŸèƒ½ |
| **æ—¶é—´è½´æŸ¥è¯¢** | âŒ æ— V1ç‰ˆæœ¬ | `GET /api/v1/sms/v2/outbox/<id>/timeline` | â• **V2æ–°å¢** | å¯é€‰ | V2ç‹¬æœ‰åŠŸèƒ½ |
| **æ”¶ä»¶ç®±åˆ—è¡¨** | `GET /api/v1/sms/inbox` | âŒ æ— V2ç‰ˆæœ¬ | ğŸ”´ **æœªè¿ç§»** | âŒ æœªä½¿ç”¨ | V2æœªå®ç° |
| **æ”¶ä»¶ç®±è¯¦æƒ…** | `GET /api/v1/sms/inbox/<id>` | âŒ æ— V2ç‰ˆæœ¬ | ğŸ”´ **æœªè¿ç§»** | âŒ æœªä½¿ç”¨ | V2æœªå®ç° |
| **æ”¶ä»¶ç®±å¯¼å‡º** | `POST /api/v1/sms/inbox/export` | âŒ æ— V2ç‰ˆæœ¬ | ğŸ”´ **æœªè¿ç§»** | âŒ æœªä½¿ç”¨ | V2æœªå®ç° |
| **ç»Ÿè®¡æ•°æ®** | `GET /api/v1/sms/statistics` | âŒ æ— V2ç‰ˆæœ¬ | ğŸ”´ **æœªè¿ç§»** | âŒ æœªä½¿ç”¨ | V2æœªå®ç° |
| **æ¦‚è§ˆç»Ÿè®¡** | `GET /api/v1/sms/overview` | âŒ æ— V2ç‰ˆæœ¬ | ğŸ”´ **æœªè¿ç§»** | âŒ æœªä½¿ç”¨ | V2æœªå®ç° |

### 1.2 çŠ¶æ€è¯´æ˜

- âœ… **å·²æ›¿ä»£**ï¼šV2å®Œå…¨å®ç°äº†V1çš„åŠŸèƒ½ï¼Œä¸”åŠŸèƒ½æ›´å¼º
- âš ï¸ **ç¼ºå¤±**ï¼šV2ç¼ºå°‘è¯¥åŠŸèƒ½ï¼Œä½†æœ‰æ›¿ä»£æ–¹æ¡ˆæˆ–å½±å“è¾ƒå°
- ğŸ”´ **æœªè¿ç§»**ï¼šV2å®Œå…¨æœªå®ç°è¯¥åŠŸèƒ½
- â• **V2æ–°å¢**ï¼šV2æ–°å¢çš„åŠŸèƒ½ï¼ŒV1æ²¡æœ‰

---

## äºŒã€è¯¦ç»†åŠŸèƒ½åˆ†æ

### 2.1 Outboxï¼ˆå‘ä»¶ç®±ï¼‰æ¨¡å—

#### âœ… å·²å®Œå…¨è¿ç§»å¹¶å¢å¼º

**V1åŠŸèƒ½ï¼š**
```python
# app/api/v1/sms/route/outbox.py
class OutboxListResource:     # åˆ—è¡¨æŸ¥è¯¢
class OutboxDetailResource:   # è¯¦æƒ…æŸ¥è¯¢
class OutboxExportResource:   # æ•°æ®å¯¼å‡º
```

**V2åŠŸèƒ½ï¼š**
```python
# app/api/v1/sms/route/outbox_v2.py
class OutboxListResourceV2:         # å¢å¼ºçš„åˆ—è¡¨æŸ¥è¯¢
class OutboxDetailResourceV2:       # å¢å¼ºçš„è¯¦æƒ…æŸ¥è¯¢ï¼ˆå«timelineï¼‰
class OutboxExportResourceV2:       # å¢å¼ºçš„å¯¼å‡ºï¼ˆæ”¯æŒmerge/splitï¼‰
class OutboxResendReceiptResource:  # æ–°å¢ï¼šå›æ‰§é‡å‘
class OutboxTimelineResource:       # æ–°å¢ï¼šç‹¬ç«‹timelineæŸ¥è¯¢
```

**V2å¢å¼ºç‚¹ï¼š**

1. **æ‹†åˆ†çŸ­ä¿¡æ”¯æŒ**
   - `split_display_mode`: 'merged'ï¼ˆåˆå¹¶æ˜¾ç¤ºï¼‰æˆ– 'individual'ï¼ˆç‹¬ç«‹æ˜¾ç¤ºï¼‰
   - è‡ªåŠ¨èšåˆæ‹†åˆ†çŸ­ä¿¡çš„çŠ¶æ€
   - æ˜¾ç¤ºæ¯ä¸ªåˆ†æ®µçš„è¯¦ç»†ä¿¡æ¯

2. **å®Œæ•´æ—¶é—´è½´**
   - ç»Ÿä¸€çš„timelineå±•ç¤ºï¼ˆä»è¯·æ±‚åˆ°é€è¾¾ï¼‰
   - åŒ…å«å„é˜¶æ®µè€—æ—¶ç»Ÿè®¡
   - æ”¯æŒæ‹†åˆ†çŸ­ä¿¡çš„å­æ¶ˆæ¯timeline

3. **å¢å¼ºçš„å¯¼å‡º**
   - æ”¯æŒä¸¤ç§å¯¼å‡ºæ¨¡å¼ï¼šmergeï¼ˆåˆå¹¶ï¼‰å’Œ splitï¼ˆæ‹†åˆ†ï¼‰
   - å¯è‡ªå®šä¹‰å¯¼å‡ºå­—æ®µ
   - æƒé™æ§åˆ¶ï¼ˆæ•æ„Ÿå­—æ®µï¼‰
   - æ”¯æŒå¤§æ‰¹é‡å¯¼å‡ºï¼ˆæœ€å¤š10ä¸‡æ¡ï¼‰

4. **å›æ‰§é‡å‘åŠŸèƒ½**
   - å¯æ‰‹åŠ¨è§¦å‘å›æ‰§é‡å‘
   - åŒ…å«é‡å‘çŠ¶æ€æ£€æŸ¥
   - è®°å½•æ“ä½œæ—¥å¿—

**å‰ç«¯ä½¿ç”¨æƒ…å†µï¼š**
- âœ… å‰ç«¯å·²å®Œå…¨è¿ç§»åˆ°V2ç«¯ç‚¹
- âœ… `/frontend/src/api/outboxApi.ts` å…¨éƒ¨ä½¿ç”¨ `/sms/v2/outbox`
- âœ… æµ‹è¯•ä»£ç éœ€è¦æ›´æ–°ï¼ˆéƒ¨åˆ†ä»ä½¿ç”¨V1ï¼‰

**ç»“è®ºï¼š** Outboxæ¨¡å—å¯ä»¥**å®‰å…¨åˆ é™¤V1ä»£ç **

---

### 2.2 Costï¼ˆè´¹ç”¨æŸ¥è¯¢ï¼‰ç«¯ç‚¹

#### âš ï¸ V2æœªæä¾›ç‹¬ç«‹ç«¯ç‚¹ï¼Œä½†æœ‰æ›¿ä»£æ–¹æ¡ˆ

**V1åŠŸèƒ½ï¼š**
```python
# app/api/v1/sms/route/outbox_cost.py
class OutboxCostResource:
    GET /api/v1/sms/outbox/<message_id>/cost
    # è¿”å›ï¼šactual_cost, adjusted_cost, cost_difference
```

**V2æƒ…å†µï¼š**
- âŒ æ²¡æœ‰ç‹¬ç«‹çš„ `/sms/v2/outbox/<id>/cost` ç«¯ç‚¹
- â“ Costä¿¡æ¯æ˜¯å¦åŒ…å«åœ¨ `OutboxDetailResourceV2` çš„è¿”å›æ•°æ®ä¸­ï¼Ÿ

**å‰ç«¯éœ€æ±‚åˆ†æï¼š**

å‰ç«¯ç±»å‹å®šä¹‰ä¸­åŒ…å«costå­—æ®µï¼š
```typescript
// frontend/src/types/entities/outbox.ts
export interface OutboxRecord {
  costRmb?: number;         // Cost in RMB
  costUsd?: number;         // Cost in USD
  // ...
}

export interface SplitMessage {
  cost?: number;            // æ‹†åˆ†çŸ­ä¿¡çš„è´¹ç”¨
  // ...
}
```

å‰ç«¯ä½¿ç”¨æƒ…å†µï¼š
```typescript
// frontend/src/pages/MessageBox/Outbox/components/DetailModal.tsx:237
{split.cost !== undefined && <span>è´¹ç”¨: Â¥{split.cost.toFixed(2)}</span>}
```

**å®é™…è°ƒç”¨æƒ…å†µï¼š**
- âŒ å‰ç«¯**æ²¡æœ‰**å•ç‹¬è°ƒç”¨ `/sms/outbox/<id>/cost` ç«¯ç‚¹
- âœ… Costæ•°æ®æ˜¯é€šè¿‡ `OutboxDetailResourceV2` çš„è¯¦æƒ…æ¥å£ä¸€èµ·è¿”å›çš„

**ShortMessageæ¨¡å‹æ£€æŸ¥ï¼š**
- âŒ `ShortMessage` æ¨¡å‹ä¸­**æ²¡æœ‰**ç›´æ¥çš„ cost å­—æ®µ
- è¯´æ˜costæ˜¯é€šè¿‡è®¡ç®—å¾—å‡ºï¼Œè€Œéç›´æ¥å­˜å‚¨

**åˆ†æç»“è®ºï¼š**

æœ‰ä¸¤ç§å¯èƒ½ï¼š

1. **å¯èƒ½æ€§Aï¼ˆæ¨èï¼‰ï¼š** V2çš„ `OutboxDetailResourceV2` å·²ç»åŒ…å«äº†costè®¡ç®—
   - Costä¿¡æ¯é€šè¿‡å…¶ä»–serviceè®¡ç®—ååŒ…å«åœ¨è¿”å›æ•°æ®ä¸­
   - ä¸éœ€è¦ç‹¬ç«‹çš„costç«¯ç‚¹
   - **éœ€è¦éªŒè¯ï¼š** æ£€æŸ¥V2 detailæ¥å£è¿”å›çš„æ•°æ®æ˜¯å¦åŒ…å«cost

2. **å¯èƒ½æ€§Bï¼ˆéœ€ä¿®å¤ï¼‰ï¼š** V2 detailæ¥å£æ²¡æœ‰è¿”å›costä¿¡æ¯
   - éœ€è¦åœ¨V2ä¸­é›†æˆcostè®¡ç®—é€»è¾‘
   - æˆ–è€…ä¿ç•™V1çš„costç«¯ç‚¹

**å»ºè®®æ“ä½œï¼š**
```bash
# éªŒè¯V2 detailæ¥å£æ˜¯å¦è¿”å›cost
curl -H "Authorization: Bearer <token>" \
  http://localhost:5000/api/v1/sms/v2/outbox/<message_id>
# æŸ¥çœ‹è¿”å›æ•°æ®ä¸­æ˜¯å¦åŒ…å« costRmbã€costUsd å­—æ®µ
```

**æš‚å®šç»“è®ºï¼š** éœ€è¦å…ˆ**éªŒè¯V2æ˜¯å¦è¿”å›costæ•°æ®**ï¼Œå†å†³å®šæ˜¯å¦å¯ä»¥åˆ é™¤V1 costç«¯ç‚¹

---

### 2.3 Inboxï¼ˆæ”¶ä»¶ç®±ï¼‰æ¨¡å—

#### ğŸ”´ V2å®Œå…¨æœªå®ç°

**V1åŠŸèƒ½ï¼š**
```python
# app/api/v1/sms/route/inbox.py
class InboxListResource:    # æ”¶ä»¶ç®±åˆ—è¡¨
class InboxDetailResource:  # æ”¶ä»¶ç®±è¯¦æƒ…
class InboxExportResource:  # æ”¶ä»¶ç®±å¯¼å‡º
```

**V2æƒ…å†µï¼š**
- âŒ æ²¡æœ‰ `inbox_v2.py` æ–‡ä»¶
- âŒ æ²¡æœ‰ä»»ä½•inboxç›¸å…³çš„V2ç«¯ç‚¹

**å‰ç«¯ä½¿ç”¨æƒ…å†µï¼š**
- âŒ å‰ç«¯æ²¡æœ‰ `inboxApi.ts` æ–‡ä»¶
- âŒ å‰ç«¯ä»£ç ä¸­æœªæœç´¢åˆ° `/sms/inbox` çš„è°ƒç”¨
- **è¯´æ˜ï¼š** å‰ç«¯**å½“å‰ä¸ä½¿ç”¨**inboxåŠŸèƒ½

**æµ‹è¯•ä½¿ç”¨æƒ…å†µï¼š**
- â“ éœ€è¦æ£€æŸ¥æµ‹è¯•ä»£ç æ˜¯å¦ä½¿ç”¨inboxç«¯ç‚¹

**ä¸šåŠ¡å½±å“è¯„ä¼°ï¼š**

Inboxï¼ˆæ”¶ä»¶ç®±ï¼‰ç”¨äºï¼š
- MOæ¶ˆæ¯ï¼ˆMobile Originatedï¼‰ï¼šç»ˆç«¯ç”¨æˆ·å‘ç»™å®¢æˆ·çš„çŸ­ä¿¡
- ä¸Šè¡ŒçŸ­ä¿¡çš„ç®¡ç†å’ŒæŸ¥è¯¢

**å¯èƒ½çš„æƒ…å†µï¼š**
1. é¡¹ç›®å½“å‰åªåšMTï¼ˆä¸‹è¡Œï¼‰æ¶ˆæ¯ï¼Œä¸å¤„ç†MOï¼ˆä¸Šè¡Œï¼‰
2. InboxåŠŸèƒ½å·²è®¡åˆ’åºŸå¼ƒ
3. InboxåŠŸèƒ½æ­£åœ¨é‡æ–°è®¾è®¡ä¸­

**å»ºè®®ï¼š**
- ä¸äº§å“ç¡®è®¤æ˜¯å¦è¿˜éœ€è¦InboxåŠŸèƒ½
- å¦‚æœéœ€è¦ï¼Œåˆ¶å®šInbox V2çš„å¼€å‘è®¡åˆ’
- å¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥æ ‡è®°V1 inboxä»£ç ä¸ºdeprecated

**ç»“è®ºï¼š** Inbox V1ä»£ç **æš‚æ—¶ä¿ç•™**ï¼Œå¾…ç¡®è®¤ä¸šåŠ¡éœ€æ±‚

---

### 2.4 Statisticsï¼ˆç»Ÿè®¡ï¼‰æ¨¡å—

#### ğŸ”´ V2å®Œå…¨æœªå®ç°

**V1åŠŸèƒ½ï¼š**
```python
# app/api/v1/sms/route/statistics.py
class StatisticsResource:   # ç»Ÿè®¡æ•°æ®æŸ¥è¯¢
class OverviewResource:      # æ¦‚è§ˆç»Ÿè®¡æŸ¥è¯¢
```

**V2æƒ…å†µï¼š**
- âŒ æ²¡æœ‰ `statistics_v2.py` æ–‡ä»¶
- âŒ æ²¡æœ‰ä»»ä½•statisticsç›¸å…³çš„V2ç«¯ç‚¹

**å‰ç«¯ä½¿ç”¨æƒ…å†µï¼š**
- âŒ å‰ç«¯ä»£ç ä¸­æœªæœç´¢åˆ° `/sms/statistics` æˆ– `/sms/overview` çš„è°ƒç”¨
- **è¯´æ˜ï¼š** å‰ç«¯**å½“å‰ä¸ä½¿ç”¨**statisticsåŠŸèƒ½

**ä¸šåŠ¡å½±å“è¯„ä¼°ï¼š**

Statisticsæ¨¡å—ç”¨äºï¼š
- æŒ‰æ—¶é—´æ®µç»Ÿè®¡å‘é€/æ¥æ”¶æ•°é‡
- æŒ‰çŠ¶æ€åˆ†ç»„ç»Ÿè®¡
- æŒ‰è´¦å·ã€é€šé“ç­‰ç»´åº¦æ±‡æ€»
- Dashboardæ¦‚è§ˆæ•°æ®

**å¯èƒ½çš„æƒ…å†µï¼š**
1. ç»Ÿè®¡åŠŸèƒ½è¿˜åœ¨è§„åˆ’ä¸­
2. ä½¿ç”¨äº†å…¶ä»–çš„æ•°æ®åˆ†æç³»ç»Ÿ
3. åŠŸèƒ½å·²åºŸå¼ƒ

**å»ºè®®ï¼š**
- ä¸äº§å“ç¡®è®¤æ˜¯å¦éœ€è¦StatisticsåŠŸèƒ½
- å¦‚æœéœ€è¦ï¼Œåº”ä¼˜å…ˆå®ç°V2ç‰ˆæœ¬ï¼ˆå¯ä»¥åˆ©ç”¨V2çš„å¢å¼ºæŸ¥è¯¢èƒ½åŠ›ï¼‰
- å¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥æ ‡è®°V1ä»£ç ä¸ºdeprecated

**ç»“è®ºï¼š** Statistics V1ä»£ç **æš‚æ—¶ä¿ç•™**ï¼Œå¾…ç¡®è®¤ä¸šåŠ¡éœ€æ±‚

---

## ä¸‰ã€V1 vs V2 ä»£ç å®ç°å¯¹æ¯”

### 3.1 æ¶æ„å·®å¼‚

**V1è®¾è®¡ï¼š**
- ç®€å•çš„Resourceç±»
- ç›´æ¥è°ƒç”¨Serviceå±‚
- è¾ƒå°‘çš„æƒé™æ§åˆ¶
- åŸºç¡€çš„æŸ¥è¯¢å’Œå¯¼å‡ºåŠŸèƒ½

**V2è®¾è®¡ï¼š**
- æ¨¡å—åŒ–æœåŠ¡ï¼ˆSplitMessageServiceã€TimelineServiceã€ReceiptResendServiceï¼‰
- QueryBuilderæ¨¡å¼ï¼ˆOutboxQueryBuilderï¼‰
- å®Œå–„çš„æƒé™æ§åˆ¶ï¼ˆ@permission_requiredè£…é¥°å™¨ï¼‰
- å¢å¼ºçš„æŸ¥è¯¢æ€§èƒ½ï¼ˆé¢„åŠ è½½ã€é¿å…N+1æŸ¥è¯¢ï¼‰
- æ›´å¥½çš„é”™è¯¯å¤„ç†

### 3.2 æ•°æ®æ ¼å¼å·®å¼‚

**V1è¿”å›æ ¼å¼ï¼š**
```json
{
  "success": true,
  "data": {
    "records": [...],
    "pagination": {...}
  }
}
```

**V2è¿”å›æ ¼å¼ï¼ˆå¢å¼ºï¼‰ï¼š**
```json
{
  "success": true,
  "data": {
    "records": [
      {
        "messageId": "...",
        "splitMessages": [...],      // V2æ–°å¢
        "timelineEvents": [...],     // V2æ–°å¢
        "duration_stats": {...},     // V2æ–°å¢
        "canResendReceipt": true     // V2æ–°å¢
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "totalCount": 100,
      "totalPages": 5
    }
  }
}
```

### 3.3 æ€§èƒ½ä¼˜åŒ–

**V2ä¼˜åŒ–ç‚¹ï¼š**

1. **æŸ¥è¯¢ä¼˜åŒ–**
   ```python
   # V2é¢„åŠ è½½deliverè®°å½•ï¼Œé¿å…N+1æŸ¥è¯¢
   delivers = Deliver.query.filter(
       Deliver.gateway_msg_id.in_(message_ids)
   ).all()
   deliver_map = {deliver.gateway_msg_id: deliver for deliver in delivers}
   ```

2. **ç‹¬ç«‹çš„countæŸ¥è¯¢**
   ```python
   # V2ä½¿ç”¨ä¸“é—¨çš„count query builder
   count_builder = OutboxQueryBuilder()
   count_query = count_builder.build_count_query(...)
   ```

3. **æ‰¹é‡å¯¼å‡ºä¼˜åŒ–**
   - åˆ†æ‰¹æŸ¥è¯¢
   - æµå¼å†™å…¥Excel
   - é™åˆ¶æœ€å¤§å¯¼å‡ºæ•°é‡

---

## å››ã€æµ‹è¯•è¦†ç›–æƒ…å†µ

### 4.1 éœ€è¦æ›´æ–°çš„æµ‹è¯•æ–‡ä»¶

| æµ‹è¯•æ–‡ä»¶ | ç±»å‹ | å½“å‰ä½¿ç”¨ | éœ€è¦æ“ä½œ | ä¼˜å…ˆçº§ |
|---------|------|----------|----------|--------|
| `tests/api/sms/test_outbox_routes.py` | å•å…ƒæµ‹è¯• | V1ç«¯ç‚¹ | æ”¹å†™ä¸ºV2æˆ–åˆ é™¤ | ğŸ”´ é«˜ |
| `tests/integration/tests/sms/test_sms_outbox_query.py` | é›†æˆæµ‹è¯• | V1ç«¯ç‚¹ | æ›´æ–°ä¸ºV2 | ğŸ”´ é«˜ |
| `tests/integration/tests/prices/test_price_db_features.py` | é›†æˆæµ‹è¯• | V1 costç«¯ç‚¹ | å¾…å®šï¼ˆéªŒè¯V2åï¼‰ | ğŸŸ¡ ä¸­ |
| `tests/integration/tests/sms/test_sms_status_workflow.py` | é›†æˆæµ‹è¯• | âœ… V2ç«¯ç‚¹ | æ— éœ€ä¿®æ”¹ | âœ… - |

### 4.2 æµ‹è¯•è¿ç§»å»ºè®®

**é€‰é¡¹Aï¼šå®Œå…¨åˆ é™¤V1æµ‹è¯•**
```bash
rm tests/api/sms/test_outbox_routes.py
# å‰æï¼šV2æœ‰å®Œæ•´çš„æµ‹è¯•è¦†ç›–
```

**é€‰é¡¹Bï¼šæ”¹å†™ä¸ºV2æµ‹è¯•ï¼ˆæ¨èï¼‰**
```bash
# ä¿ç•™æµ‹è¯•åœºæ™¯ï¼Œæ›´æ–°ç«¯ç‚¹URL
# ä» /api/v1/sms/outbox æ”¹ä¸º /api/v1/sms/v2/outbox
```

**é€‰é¡¹Cï¼šæš‚æ—¶ä¿ç•™**
```bash
# åœ¨V2æµ‹è¯•è¦†ç›–å®Œæ•´å‰ï¼Œæš‚æ—¶ä¿ç•™V1æµ‹è¯•
# ç¡®ä¿å›å½’æµ‹è¯•é€šè¿‡
```

---

## äº”ã€åˆ é™¤V1ä»£ç çš„é£é™©è¯„ä¼°

### 5.1 å¯ä»¥å®‰å…¨åˆ é™¤çš„ä»£ç 

#### ğŸŸ¢ ä½é£é™©ï¼ˆå¯ç«‹å³åˆ é™¤ï¼‰

**Outbox V1è·¯ç”±æ³¨å†Œï¼ˆæ¨èæ“ä½œï¼‰ï¼š**

```python
# app/api/v1/sms/route/routes.py
# æ³¨é‡Šæˆ–åˆ é™¤ä»¥ä¸‹è·¯ç”±ï¼š
# api.add_resource(OutboxListResource, '/outbox')
# api.add_resource(OutboxDetailResource, '/outbox/<string:message_id>')
# api.add_resource(OutboxExportResource, '/outbox/export')
```

**å½±å“èŒƒå›´ï¼š**
- âœ… å‰ç«¯å·²å®Œå…¨ä½¿ç”¨V2ï¼Œæ— å½±å“
- âš ï¸ éœ€è¦æ›´æ–°2ä¸ªé›†æˆæµ‹è¯•
- âš ï¸ éœ€è¦åˆ é™¤æˆ–æ”¹å†™1ä¸ªå•å…ƒæµ‹è¯•

**å›æ»šæ–¹æ¡ˆï¼š**
```bash
# å¦‚æœ‰é—®é¢˜ï¼Œå¯å¿«é€Ÿæ¢å¤
git checkout app/api/v1/sms/route/routes.py
```

### 5.2 éœ€è¦éªŒè¯ååˆ é™¤çš„ä»£ç 

#### ğŸŸ¡ ä¸­é£é™©ï¼ˆéœ€éªŒè¯ï¼‰

**Costç«¯ç‚¹ï¼š**

```python
# app/api/v1/sms/route/routes.py
# api.add_resource(OutboxCostResource, '/outbox/<string:message_id>/cost')
```

**åˆ é™¤å‰éœ€è¦éªŒè¯ï¼š**
1. V2 detailæ¥å£æ˜¯å¦è¿”å›costæ•°æ®
2. å‰ç«¯æ˜¾ç¤ºçš„costæ•°æ®æ¥æº
3. é›†æˆæµ‹è¯•ä¸­costç›¸å…³çš„æ–­è¨€

**éªŒè¯æ­¥éª¤ï¼š**
```bash
# 1. æµ‹è¯•V2 detailæ¥å£
curl -X GET "http://localhost:5000/api/v1/sms/v2/outbox/<message_id>" \
  -H "Authorization: Bearer <token>"

# 2. æ£€æŸ¥è¿”å›æ•°æ®ä¸­æ˜¯å¦æœ‰ï¼š
# - costRmb
# - costUsd
# - æˆ– splitMessages[].cost

# 3. å¦‚æœæœ‰ï¼Œå¯ä»¥åˆ é™¤V1 costç«¯ç‚¹
# å¦‚æœæ²¡æœ‰ï¼Œéœ€è¦åœ¨V2ä¸­è¡¥å……costè®¡ç®—é€»è¾‘
```

### 5.3 æš‚æ—¶ä¸èƒ½åˆ é™¤çš„ä»£ç 

#### ğŸ”´ é«˜é£é™©ï¼ˆä¿ç•™ï¼‰

**Inboxç«¯ç‚¹ï¼š**
```python
# app/api/v1/sms/route/inbox.py
# å…¨éƒ¨ä¿ç•™ï¼Œå› ä¸ºV2æœªå®ç°
```

**Statisticsç«¯ç‚¹ï¼š**
```python
# app/api/v1/sms/route/statistics.py
# å…¨éƒ¨ä¿ç•™ï¼Œå› ä¸ºV2æœªå®ç°
```

**åŸå› ï¼š**
- è™½ç„¶å‰ç«¯å½“å‰ä¸ä½¿ç”¨
- ä½†å¯èƒ½æœ‰å…¶ä»–ç³»ç»Ÿæˆ–è„šæœ¬åœ¨è°ƒç”¨
- éœ€è¦ä¸äº§å“/æ¶æ„ç¡®è®¤åå†å†³å®š

---

## å…­ã€æ¸…ç†è¡ŒåŠ¨è®¡åˆ’

### é˜¶æ®µ1ï¼šéªŒè¯ä¸å‡†å¤‡ï¼ˆ1-2å¤©ï¼‰

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] éªŒè¯V2 detailæ¥å£æ˜¯å¦è¿”å›costæ•°æ®
- [ ] è¿è¡Œæ‰€æœ‰SMSç›¸å…³æµ‹è¯•ï¼Œç¡®ä¿V2åŠŸèƒ½æ­£å¸¸
- [ ] ç¡®è®¤å‰ç«¯æ‰€æœ‰SMSåŠŸèƒ½æ­£å¸¸è¿è¡Œ
- [ ] ä¸äº§å“ç¡®è®¤inboxå’ŒstatisticsåŠŸèƒ½çš„è§„åˆ’

**éªŒè¯å‘½ä»¤ï¼š**
```bash
# 1. è¿è¡Œå•å…ƒæµ‹è¯•
cd /Users/yukun-admin/projects/pigeon/pigeon_web
source /Users/yukun-admin/projects/pigeon/venv/bin/activate
pytest tests/api/sms/ -v

# 2. è¿è¡Œé›†æˆæµ‹è¯•
cd tests/integration
make test

# 3. å‰ç«¯ç±»å‹æ£€æŸ¥
cd frontend
npm run type-check
npm run build
```

### é˜¶æ®µ2ï¼šæ›´æ–°æµ‹è¯•ä»£ç ï¼ˆ2-3å¤©ï¼‰

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] æ›´æ–° `tests/integration/tests/sms/test_sms_outbox_query.py`
  - å°† `/sms/outbox` æ”¹ä¸º `/sms/v2/outbox`
  - æ›´æ–°å“åº”æ•°æ®ç»“æ„çš„æ–­è¨€
- [ ] å¤„ç† `tests/api/sms/test_outbox_routes.py`
  - é€‰é¡¹Aï¼šåˆ é™¤ï¼ˆå¦‚V2æœ‰å®Œæ•´æµ‹è¯•ï¼‰
  - é€‰é¡¹Bï¼šæ”¹å†™ä¸ºV2æµ‹è¯•
- [ ] å¤„ç† `tests/integration/tests/prices/test_price_db_features.py`
  - æ ¹æ®costç«¯ç‚¹çš„éªŒè¯ç»“æœå†³å®š

**æ›´æ–°ç¤ºä¾‹ï¼š**
```python
# ä¿®æ”¹å‰
response = requests.get(
    f"{integration_base_url}/sms/outbox",
    params={...},
    headers=user_headers
)

# ä¿®æ”¹å
response = requests.get(
    f"{integration_base_url}/sms/v2/outbox",
    params={...},
    headers=user_headers
)
```

### é˜¶æ®µ3ï¼šåˆ é™¤V1è·¯ç”±ï¼ˆåŠå¤©ï¼‰

**æ“ä½œæ­¥éª¤ï¼š**

1. **å¤‡ä»½å½“å‰ä»£ç **
   ```bash
   cd /Users/yukun-admin/projects/pigeon/pigeon_web
   git checkout -b cleanup/sms-v1-removal
   git add -A
   git commit -m "backup: before SMS V1 cleanup"
   ```

2. **ä¿®æ”¹è·¯ç”±æ³¨å†Œæ–‡ä»¶**
   ```bash
   # ç¼–è¾‘ app/api/v1/sms/route/routes.py
   # æ³¨é‡Šæˆ–åˆ é™¤V1è·¯ç”±æ³¨å†Œ
   ```

3. **éªŒè¯ä¿®æ”¹**
   ```bash
   # é‡å¯æœåŠ¡
   python run.py

   # æµ‹è¯•V2ç«¯ç‚¹å¯ç”¨
   curl http://localhost:5000/api/v1/sms/v2/outbox?...

   # ç¡®è®¤V1ç«¯ç‚¹è¿”å›404
   curl http://localhost:5000/api/v1/sms/outbox?...
   # åº”è¯¥è¿”å› 404 Not Found
   ```

4. **è¿è¡Œå®Œæ•´æµ‹è¯•**
   ```bash
   pytest tests/ -v
   cd tests/integration && make test
   cd frontend && npm run build
   ```

### é˜¶æ®µ4ï¼šè§‚å¯Ÿä¸ç›‘æ§ï¼ˆ3-7å¤©ï¼‰

**ç›‘æ§å†…å®¹ï¼š**
- [ ] å‰ç«¯åŠŸèƒ½æ­£å¸¸
- [ ] æ²¡æœ‰404é”™è¯¯ï¼ˆè®¿é—®æ—§ç«¯ç‚¹ï¼‰
- [ ] æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™
- [ ] æ—¥å¿—ä¸­æ— å¼‚å¸¸

**ç›‘æ§å‘½ä»¤ï¼š**
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/app.log | grep -E "404|error|/sms/outbox"

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f logs/error.log
```

### é˜¶æ®µ5ï¼šåˆ é™¤ä»£ç æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

**å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå¯ä»¥åˆ é™¤V1æ–‡ä»¶ï¼š**

```bash
# åˆ é™¤V1 outboxå®ç°
rm app/api/v1/sms/route/outbox.py

# æ ¹æ®éªŒè¯ç»“æœå†³å®šæ˜¯å¦åˆ é™¤
rm app/api/v1/sms/route/outbox_cost.py  # å¦‚V2å·²åŒ…å«cost

# åˆ é™¤V1æµ‹è¯•æ–‡ä»¶
rm tests/api/sms/test_outbox_routes.py  # å¦‚å·²æœ‰V2æµ‹è¯•

# æäº¤
git add -A
git commit -m "feat: remove SMS V1 outbox endpoints"
```

**æ³¨æ„ï¼š** å»ºè®®å…ˆæ³¨é‡Šè·¯ç”±ï¼Œè§‚å¯Ÿä¸€æ®µæ—¶é—´åå†åˆ é™¤æ–‡ä»¶

---

## ä¸ƒã€æ€»ç»“ä¸å»ºè®®

### 7.1 æ ¸å¿ƒç»“è®º

| æ¨¡å— | V2å®Œæ•´æ€§ | å¯åˆ é™¤V1 | å‰ææ¡ä»¶ |
|------|---------|---------|---------|
| **Outbox** | âœ… 100%å®Œæˆ | âœ… å¯ä»¥åˆ é™¤ | æ›´æ–°æµ‹è¯•ä»£ç  |
| **Cost** | âš ï¸ å¾…éªŒè¯ | âš ï¸ éœ€éªŒè¯ | ç¡®è®¤V2è¿”å›costæ•°æ® |
| **Inbox** | âŒ æœªå®ç° | âŒ ä¸èƒ½åˆ é™¤ | éœ€ç¡®è®¤ä¸šåŠ¡éœ€æ±‚ |
| **Statistics** | âŒ æœªå®ç° | âŒ ä¸èƒ½åˆ é™¤ | éœ€ç¡®è®¤ä¸šåŠ¡éœ€æ±‚ |

### 7.2 ç«‹å³å¯æ‰§è¡Œçš„æ“ä½œ

**æœ€å°é£é™©æ–¹æ¡ˆï¼ˆæ¨èï¼‰ï¼š**

1. âœ… **æ³¨é‡ŠOutbox V1è·¯ç”±** - åœ¨ `routes.py` ä¸­æ³¨é‡Šæ‰3ä¸ªoutboxè·¯ç”±
2. âœ… **æ›´æ–°é›†æˆæµ‹è¯•** - å°†V1ç«¯ç‚¹æ”¹ä¸ºV2ç«¯ç‚¹
3. âœ… **éªŒè¯costæ•°æ®** - ç¡®è®¤V2 detailæ¥å£æ˜¯å¦åŒ…å«cost
4. â¸ï¸ **ä¿ç•™inboxå’Œstatistics** - å¾…ç¡®è®¤ä¸šåŠ¡éœ€æ±‚åå†å¤„ç†

**é¢„æœŸæ•ˆæœï¼š**
- å‰ç«¯åŠŸèƒ½æ— å½±å“ï¼ˆå·²ä½¿ç”¨V2ï¼‰
- å‡å°‘ä»£ç ç»´æŠ¤è´Ÿæ‹…
- ä¿æŒç³»ç»Ÿç¨³å®šæ€§
- å¯å¿«é€Ÿå›æ»š

### 7.3 å¾…ç¡®è®¤çš„é—®é¢˜

**éœ€è¦ä¸äº§å“/ä¸šåŠ¡ç¡®è®¤ï¼š**

1. â“ **Inboxï¼ˆæ”¶ä»¶ç®±ï¼‰åŠŸèƒ½**
   - æ˜¯å¦è¿˜éœ€è¦MOæ¶ˆæ¯ç®¡ç†ï¼Ÿ
   - å¦‚æœéœ€è¦ï¼Œä½•æ—¶å®ç°V2ç‰ˆæœ¬ï¼Ÿ
   - å¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥æ ‡è®°åºŸå¼ƒ

2. â“ **Statisticsï¼ˆç»Ÿè®¡ï¼‰åŠŸèƒ½**
   - æ˜¯å¦éœ€è¦SMSç»Ÿè®¡Dashboardï¼Ÿ
   - æ˜¯å¦ä½¿ç”¨äº†å…¶ä»–çš„æ•°æ®åˆ†æç³»ç»Ÿï¼Ÿ
   - å¦‚æœéœ€è¦ï¼Œåº”è¯¥çº³å…¥å¼€å‘è®¡åˆ’

3. â“ **Costï¼ˆè´¹ç”¨ï¼‰æŸ¥è¯¢**
   - V2 detailæ¥å£æ˜¯å¦å·²åŒ…å«costè®¡ç®—ï¼Ÿ
   - å‰ç«¯æ˜¾ç¤ºçš„costæ•°æ®ä»å“ªé‡Œæ¥ï¼Ÿ
   - æ˜¯å¦éœ€è¦ä¿ç•™ç‹¬ç«‹çš„costç«¯ç‚¹ï¼Ÿ

### 7.4 åç»­è§„åˆ’å»ºè®®

**çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰ï¼š**
- æ¸…ç†Outbox V1ä»£ç 
- éªŒè¯costæ•°æ®æ¥æº
- æ›´æ–°æµ‹è¯•ä»£ç 

**ä¸­æœŸï¼ˆ1-2æœˆï¼‰ï¼š**
- ç¡®è®¤inboxå’Œstatisticsçš„ä¸šåŠ¡éœ€æ±‚
- å¦‚éœ€è¦ï¼Œå®ç°inboxå’Œstatisticsçš„V2ç‰ˆæœ¬
- å®Œå–„V2çš„æµ‹è¯•è¦†ç›–

**é•¿æœŸï¼ˆ3-6æœˆï¼‰ï¼š**
- å…¨é¢æ¸…ç†SMS V1ä»£ç 
- å»ºç«‹APIç‰ˆæœ¬ç®¡ç†è§„èŒƒ
- ä¸ºå…¶ä»–æ¨¡å—åˆ¶å®šV2å‡çº§è®¡åˆ’

---

## å…«ã€é£é™©æç¤º

### 8.1 åˆ é™¤V1ä»£ç çš„æ½œåœ¨é£é™©

1. **ç¬¬ä¸‰æ–¹é›†æˆ**
   - å¯èƒ½æœ‰å¤–éƒ¨ç³»ç»Ÿç›´æ¥è°ƒç”¨V1 API
   - éœ€è¦æ£€æŸ¥APIè°ƒç”¨æ—¥å¿—
   - å»ºè®®ä¿ç•™ä¸€æ®µæ—¶é—´çš„å…¼å®¹æ€§

2. **å†…éƒ¨è„šæœ¬**
   - å¯èƒ½æœ‰è¿ç»´è„šæœ¬ä½¿ç”¨V1ç«¯ç‚¹
   - éœ€è¦æ£€æŸ¥æ‰€æœ‰è‡ªåŠ¨åŒ–è„šæœ¬
   - éœ€è¦æ›´æ–°æ–‡æ¡£å’Œç¤ºä¾‹

3. **æµ‹è¯•ç¯å¢ƒ**
   - æµ‹è¯•ç¯å¢ƒå¯èƒ½è¿˜åœ¨ä½¿ç”¨V1
   - éœ€è¦åŒæ­¥æ›´æ–°æ‰€æœ‰ç¯å¢ƒ
   - éœ€è¦é€šçŸ¥æµ‹è¯•å›¢é˜Ÿ

### 8.2 ç¼“è§£æªæ–½

1. **ç°åº¦å‘å¸ƒ**
   - å…ˆåœ¨æµ‹è¯•ç¯å¢ƒåˆ é™¤V1
   - è§‚å¯Ÿ1-2å‘¨æ— é—®é¢˜åå†åˆ°ç”Ÿäº§ç¯å¢ƒ

2. **æ—¥å¿—ç›‘æ§**
   - æ·»åŠ deprecatedè­¦å‘Šæ—¥å¿—
   - ç›‘æ§V1ç«¯ç‚¹çš„è®¿é—®é¢‘ç‡
   - è¯†åˆ«æ‰€æœ‰V1è°ƒç”¨æ¥æº

3. **ç‰ˆæœ¬æ ‡è®°**
   - åœ¨V1è·¯ç”±ä¸Šæ·»åŠ  `@deprecated` è£…é¥°å™¨
   - åœ¨å“åº”å¤´ä¸­æ·»åŠ  `X-API-Deprecated: true`
   - æä¾›V2è¿ç§»æŒ‡å—é“¾æ¥

4. **å›æ»šå‡†å¤‡**
   - ä¿ç•™V1ä»£ç çš„å®Œæ•´å¤‡ä»½
   - å‡†å¤‡å¿«é€Ÿå›æ»šè„šæœ¬
   - å»ºç«‹ç´§æ€¥è”ç³»æœºåˆ¶

---

## ä¹ã€éªŒè¯æ£€æŸ¥æ¸…å•

### åˆ é™¤V1å‰å¿…é¡»å®Œæˆçš„æ£€æŸ¥é¡¹

**æŠ€æœ¯éªŒè¯ï¼š**
- [ ] V2æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] å‰ç«¯é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•æ— æ˜æ˜¾ä¸‹é™
- [ ] V2 detailæ¥å£åŒ…å«costæ•°æ®ï¼ˆæˆ–ç¡®è®¤ä¸éœ€è¦ï¼‰

**ä¸šåŠ¡ç¡®è®¤ï¼š**
- [ ] äº§å“ç¡®è®¤inboxåŠŸèƒ½çš„è§„åˆ’
- [ ] äº§å“ç¡®è®¤statisticsåŠŸèƒ½çš„è§„åˆ’
- [ ] ç¡®è®¤æ— å¤–éƒ¨ç³»ç»Ÿä¾èµ–V1 API

**ä»£ç å‡†å¤‡ï¼š**
- [ ] æ‰€æœ‰æµ‹è¯•å·²æ›´æ–°åˆ°V2
- [ ] ä»£ç å·²å¤‡ä»½åˆ°ä¸“é—¨çš„åˆ†æ”¯
- [ ] å‡†å¤‡å¥½å›æ»šæ–¹æ¡ˆ

**å›¢é˜Ÿæ²Ÿé€šï¼š**
- [ ] å·²é€šçŸ¥å‰ç«¯å›¢é˜Ÿ
- [ ] å·²é€šçŸ¥æµ‹è¯•å›¢é˜Ÿ
- [ ] å·²é€šçŸ¥è¿ç»´å›¢é˜Ÿ
- [ ] æ›´æ–°äº†APIæ–‡æ¡£

---

## é™„å½•

### é™„å½•Aï¼šå¿«é€ŸéªŒè¯å‘½ä»¤

```bash
# 1. æ£€æŸ¥V2 APIæ˜¯å¦è¿”å›cost
curl -X GET "http://localhost:5000/api/v1/sms/v2/outbox/<message_id>" \
  -H "Authorization: Bearer <token>" | jq '.data.costRmb, .data.costUsd'

# 2. æ£€æŸ¥æ˜¯å¦æœ‰ç³»ç»Ÿåœ¨è°ƒç”¨V1
tail -f logs/app.log | grep "/api/v1/sms/outbox" | grep -v "/v2/"

# 3. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
source /Users/yukun-admin/projects/pigeon/venv/bin/activate
pytest tests/ -v --tb=short

# 4. å‰ç«¯æ„å»ºæµ‹è¯•
cd frontend && npm run build
```

### é™„å½•Bï¼šV1ä¸V2ç«¯ç‚¹æ˜ å°„

```
V1 â†’ V2 æ˜ å°„ï¼š
GET  /api/v1/sms/outbox                    â†’ GET  /api/v1/sms/v2/outbox
GET  /api/v1/sms/outbox/<id>               â†’ GET  /api/v1/sms/v2/outbox/<id>
POST /api/v1/sms/outbox/export             â†’ POST /api/v1/sms/v2/outbox/export
GET  /api/v1/sms/outbox/<id>/cost          â†’ ï¼ˆå¾…éªŒè¯ï¼‰å¯èƒ½åŒ…å«åœ¨detailä¸­
æ—                                          â†’ POST /api/v1/sms/v2/outbox/<id>/resend-receipt
æ—                                          â†’ GET  /api/v1/sms/v2/outbox/<id>/timeline

æœªè¿ç§»ï¼š
GET  /api/v1/sms/inbox                     â†’ æ— V2ç‰ˆæœ¬
GET  /api/v1/sms/inbox/<id>                â†’ æ— V2ç‰ˆæœ¬
POST /api/v1/sms/inbox/export              â†’ æ— V2ç‰ˆæœ¬
GET  /api/v1/sms/statistics                â†’ æ— V2ç‰ˆæœ¬
GET  /api/v1/sms/overview                  â†’ æ— V2ç‰ˆæœ¬
```

### é™„å½•Cï¼šè”ç³»ä¿¡æ¯

**æŠ€æœ¯å’¨è¯¢ï¼š**
- åç«¯è´Ÿè´£äººï¼šlinquan <linquan.isaac@gmail.com>
- ç³»ç»Ÿæ¶æ„ï¼šyukun.xing <xingyukun@gmail.com>

**ä¸šåŠ¡ç¡®è®¤ï¼š**
- äº§å“ç»ç†ï¼šï¼ˆå¾…è¡¥å……ï¼‰

**ç´§æ€¥è”ç³»ï¼š**
- å¦‚å‘ç°é—®é¢˜ï¼Œç«‹å³è”ç³»æŠ€æœ¯è´Ÿè´£äºº
- å‡†å¤‡å¿«é€Ÿå›æ»šæ–¹æ¡ˆ
