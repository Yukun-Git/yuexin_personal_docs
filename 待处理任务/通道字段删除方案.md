# é€šé“å­—æ®µåˆ é™¤æ–¹æ¡ˆ

## æ–‡æ¡£ä¿¡æ¯
- **åˆ›å»ºæ—¥æœŸ**: 2025-10-29
- **ç»´æŠ¤äºº**: yukun.xing
- **çŠ¶æ€**: å¾…æ‰§è¡Œ

---

## 1. åˆ é™¤æ¦‚è¿°

### 1.1 åˆ é™¤å­—æ®µæ¸…å•

æœ¬æ¬¡éœ€è¦åˆ é™¤ä»¥ä¸‹7ä¸ªé€šé“é…ç½®å­—æ®µï¼š

| å­—æ®µå | å­˜å‚¨ä½ç½® | æ•°æ®ç±»å‹ | è¯´æ˜ |
|-------|---------|---------|------|
| `source_addr_ton` | `channels.channel_config` (JSONB) | Integer | SMPPåè®®æºåœ°å€ç±»å‹ç¼–å· |
| `source_addr_npi` | `channels.channel_config` (JSONB) | Integer | SMPPåè®®æºåœ°å€ç¼–å·è®¡åˆ’ |
| `dest_addr_ton` | `channels.channel_config` (JSONB) | Integer | SMPPåè®®ç›®æ ‡åœ°å€ç±»å‹ç¼–å· |
| `dest_addr_npi` | `channels.channel_config` (JSONB) | Integer | SMPPåè®®ç›®æ ‡åœ°å€ç¼–å·è®¡åˆ’ |
| `gateway_signature` | `channels` è¡¨ç‹¬ç«‹åˆ— | Boolean | ç½‘å…³ç­¾åå¼€å…³ |
| `remove_signature` | `channels` è¡¨ç‹¬ç«‹åˆ— | Boolean | æ‹†é™¤ç­¾åå¼€å…³ |
| `uplink_config` | `channels` è¡¨ç‹¬ç«‹åˆ— | Enum | ä¸Šè¡ŒåŒ¹é…é…ç½® |

### 1.2 å½±å“èŒƒå›´åˆ†æ

#### æ•°æ®åº“å±‚é¢
- **è¡¨ç»“æ„å˜æ›´**: éœ€è¦åˆ é™¤ `channels` è¡¨çš„3ä¸ªç‹¬ç«‹åˆ—
- **æšä¸¾ç±»å‹**: éœ€è¦åˆ é™¤ `mgmt.uplink_config` æšä¸¾ç±»å‹
- **Mockæ•°æ®**: éœ€è¦æ›´æ–°æµ‹è¯•æ•°æ®
- **é£é™©ç­‰çº§**: ğŸ”´ é«˜ - éœ€è¦æ‰§è¡Œæ•°æ®åº“è¿ç§»

#### åº”ç”¨å±‚é¢
- **å‰ç«¯æ–‡ä»¶**: 3ä¸ªæ–‡ä»¶éœ€è¦ä¿®æ”¹
- **åç«¯æ–‡ä»¶**: 3ä¸ªæ–‡ä»¶éœ€è¦ä¿®æ”¹
- **APIæ¥å£**: 2ä¸ªæ¥å£å—å½±å“ï¼ˆè·å–/æ›´æ–°é€šé“å‚æ•°ï¼‰
- **é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ - å¯èƒ½å½±å“ç°æœ‰APIè°ƒç”¨

#### ä¸šåŠ¡å±‚é¢
- **åŠŸèƒ½å½±å“**: é€šé“åˆ›å»º/ç¼–è¾‘ç•Œé¢å­—æ®µå‡å°‘
- **æ•°æ®è¿ç§»**: ç°æœ‰é€šé“çš„è¿™7ä¸ªå­—æ®µå€¼å°†è¢«ä¸¢å¼ƒ
- **å‘åå…¼å®¹**: ä¸å…¼å®¹ - å‰ç«¯æ—§ç‰ˆæœ¬å°†æ— æ³•æ­£å¸¸å·¥ä½œ
- **é£é™©ç­‰çº§**: ğŸŸ¢ ä½ - ä»…å½±å“ç®¡ç†ç•Œé¢ï¼Œä¸å½±å“çŸ­ä¿¡å‘é€

---

## 2. æ¶‰åŠæ–‡ä»¶æ¸…å•

### 2.1 æ•°æ®åº“æ–‡ä»¶ (4ä¸ª)

```
pigeon_web/sql/modules/base.sql                    # åˆ é™¤ uplink_config æšä¸¾å®šä¹‰
pigeon_web/sql/modules/channels.sql               # åˆ é™¤3ä¸ªåˆ—å®šä¹‰å’Œæ³¨é‡Š
pigeon_web/sql/mock_data/channels.sql             # æ— éœ€ä¿®æ”¹ï¼ˆINSERTè¯­å¥æœªåŒ…å«è¿™äº›å­—æ®µï¼‰
pigeon_web/sql/pigeon_web.sql                     # å¦‚æœé‡æ–°ç”Ÿæˆï¼Œä¼šè‡ªåŠ¨æ›´æ–°
```

### 2.2 åç«¯æ–‡ä»¶ (3ä¸ª)

```
app/models/customers/channel.py                    # åˆ é™¤Modelå­—æ®µå®šä¹‰å’ŒUplinkConfigæšä¸¾
app/api/v1/channels/schema/channel.py             # åˆ é™¤Schemaå­—æ®µéªŒè¯
app/services/channels/channel_service.py          # åˆ é™¤ä¸šåŠ¡é€»è¾‘å¤„ç†ä»£ç 
```

### 2.3 å‰ç«¯æ–‡ä»¶ (3ä¸ª)

```
frontend/src/api/channelApi.ts                    # åˆ é™¤æ¥å£ç±»å‹å®šä¹‰
frontend/src/pages/ChannelManagement/components/ChannelFormModal.tsx   # åˆ é™¤è¡¨å•å­—æ®µ
frontend/src/pages/ChannelManagement/components/ParamConfigModal.tsx   # åˆ é™¤å‚æ•°é…ç½®å­—æ®µ
```

---

## 3. æ‰§è¡Œæ­¥éª¤

### 3.1 å‡†å¤‡é˜¶æ®µ

#### âœ… æ­¥éª¤1: æ•°æ®å¤‡ä»½
```bash
# 1.1 å¤‡ä»½channelsè¡¨
cd /Users/yukun-admin/projects/pigeon/pigeon_web
pg_dump -h localhost -p 5433 -U postgres -d pigeon_web \
  -t mgmt.channels --data-only \
  > backup/channels_backup_$(date +%Y%m%d_%H%M%S).sql

# 1.2 å¤‡ä»½å®Œæ•´æ•°æ®åº“schema
pg_dump -h localhost -p 5433 -U postgres -d pigeon_web \
  --schema-only \
  > backup/schema_backup_$(date +%Y%m%d_%H%M%S).sql
```

#### âœ… æ­¥éª¤2: æ£€æŸ¥ç°æœ‰æ•°æ®
```sql
-- 2.1 æ£€æŸ¥æœ‰å¤šå°‘é€šé“ä½¿ç”¨äº†è¿™äº›å­—æ®µ
SELECT
    COUNT(*) as total_channels,
    COUNT(CASE WHEN gateway_signature = TRUE THEN 1 END) as using_gateway_signature,
    COUNT(CASE WHEN remove_signature = TRUE THEN 1 END) as using_remove_signature,
    COUNT(CASE WHEN uplink_config = 'extend_match' THEN 1 END) as using_extend_match,
    COUNT(CASE WHEN uplink_config = 'deliver_match' THEN 1 END) as using_deliver_match,
    COUNT(CASE WHEN channel_config ? 'source_addr_ton' THEN 1 END) as using_source_addr_ton,
    COUNT(CASE WHEN channel_config ? 'dest_addr_ton' THEN 1 END) as using_dest_addr_ton
FROM mgmt.channels;

-- 2.2 åˆ—å‡ºä½¿ç”¨è¿™äº›å­—æ®µçš„é€šé“è¯¦æƒ…
SELECT
    channel_id,
    channel_name,
    gateway_signature,
    remove_signature,
    uplink_config,
    channel_config->'source_addr_ton' as source_addr_ton,
    channel_config->'dest_addr_ton' as dest_addr_ton
FROM mgmt.channels
WHERE gateway_signature = TRUE
   OR remove_signature = TRUE
   OR uplink_config = 'extend_match'
   OR channel_config ? 'source_addr_ton';
```

#### âœ… æ­¥éª¤3: åˆ›å»ºGitåˆ†æ”¯
```bash
cd /Users/yukun-admin/projects/pigeon/pigeon_web
git checkout main
git pull origin main
git checkout -b refactor/remove-unused-channel-fields
```

---

### 3.2 ä»£ç ä¿®æ”¹é˜¶æ®µ

#### ä¿®æ”¹é¡ºåºè¯´æ˜
æŒ‰ç…§ä»¥ä¸‹é¡ºåºä¿®æ”¹ï¼Œç¡®ä¿æ¯ä¸€æ­¥éƒ½å¯ä»¥ç¼–è¯‘å’Œæµ‹è¯•ï¼š

**é¡ºåº**: å‰ç«¯ â†’ åç«¯ â†’ æ•°æ®åº“

åŸå› ï¼š
1. å‰ç«¯å…ˆç§»é™¤å­—æ®µï¼ŒAPIä»ç„¶å…¼å®¹ï¼ˆåç«¯ä¼šå¿½ç•¥å‰ç«¯ä¸å‘é€çš„å­—æ®µï¼‰
2. åç«¯ç§»é™¤å­—æ®µå¤„ç†ï¼Œæ•°æ®åº“åˆ—ä»å­˜åœ¨ï¼ˆè¯»å–æ—¶å¿½ç•¥è¿™äº›åˆ—ï¼‰
3. æœ€ååˆ é™¤æ•°æ®åº“åˆ—ï¼ˆæœ€å±é™©çš„æ“ä½œï¼‰

---

#### ğŸ“ æ­¥éª¤4: ä¿®æ”¹å‰ç«¯ä»£ç 

##### 4.1 ä¿®æ”¹ `frontend/src/api/channelApi.ts`

**ä½ç½®1**: åˆ é™¤æ¥å£å®šä¹‰ä¸­çš„å­—æ®µï¼ˆçº¦ç¬¬100è¡Œé™„è¿‘ï¼‰
```typescript
// åˆ é™¤ä»¥ä¸‹å­—æ®µ
export interface Channel {
  // ... å…¶ä»–å­—æ®µ ...
  // åˆ é™¤è¿™3è¡Œ âŒ
  // gateway_signature?: boolean;
  // remove_signature?: boolean;
  // uplink_config?: 'extend_match' | 'deliver_match';
}
```

**ä½ç½®2**: åˆ é™¤ UpdateChannelParametersRequest æ¥å£ä¸­çš„SMPPå­—æ®µï¼ˆçº¦ç¬¬438è¡Œï¼‰
```typescript
export interface UpdateChannelParametersRequest {
  gateway_address: string;
  gateway_port: number;
  account: string;
  password: string;
  connection_count: number;
  total_speed: number;
  default_encoding: number;
  // åˆ é™¤ä»¥ä¸‹4è¡Œ âŒ
  // source_addr_ton: number;
  // source_addr_npi: number;
  // dest_addr_ton: number;
  // dest_addr_npi: number;
}
```

**ä½ç½®3**: åˆ é™¤ ChannelParameterDetail æ¥å£ä¸­çš„SMPPå­—æ®µï¼ˆæœç´¢è¯¥æ¥å£ï¼‰
```typescript
export interface ChannelParameterDetail {
  // ... å…¶ä»–å­—æ®µ ...
  // åˆ é™¤ä»¥ä¸‹4è¡Œ âŒ
  // source_addr_ton: number;
  // source_addr_npi: number;
  // dest_addr_ton: number;
  // dest_addr_npi: number;
}
```

##### 4.2 ä¿®æ”¹ `frontend/src/pages/ChannelManagement/components/ChannelFormModal.tsx`

**ä½ç½®1**: åˆ é™¤è¡¨å•æ•°æ®æ¥å£ä¸­çš„å­—æ®µï¼ˆçº¦ç¬¬34è¡Œï¼‰
```typescript
interface ChannelFormData {
  // ... å…¶ä»–å­—æ®µ ...
  // åˆ é™¤ä»¥ä¸‹3è¡Œ âŒ
  // gateway_signature: boolean;
  // remove_signature: boolean;
  // uplink_config: 'extend_match' | 'deliver_match';
}
```

**ä½ç½®2**: åˆ é™¤é»˜è®¤å€¼è®¾ç½®ï¼ˆçº¦ç¬¬139-156è¡Œï¼‰
```typescript
// åœ¨ useEffect ä¸­åˆ é™¤è¿™äº›å­—æ®µçš„è®¾ç½®
useEffect(() => {
  if (mode === 'edit' && channelData && open) {
    form.setFieldsValue({
      // ... å…¶ä»–å­—æ®µ ...
      // åˆ é™¤è¿™3è¡Œ âŒ
      // gateway_signature: channelData.gateway_signature || false,
      // remove_signature: channelData.remove_signature || false,
      // uplink_config: channelData.uplink_config || 'deliver_match',
    });
  } else if (mode === 'create' && open) {
    form.setFieldsValue({
      // ... å…¶ä»–å­—æ®µ ...
      // åˆ é™¤è¿™3è¡Œ âŒ
      // gateway_signature: false,
      // remove_signature: false,
      // uplink_config: 'deliver_match',
    });
  }
}, [mode, channelData, open, form]);
```

**ä½ç½®3**: åˆ é™¤è¡¨å•UIç»„ä»¶ï¼ˆæœç´¢ "ç½‘å…³ç­¾å"ã€"æ‹†é™¤ç­¾å"ã€"ä¸Šè¡ŒåŒ¹é…"ï¼‰
æ‰¾åˆ°ç±»ä¼¼ä»¥ä¸‹çš„ Form.Item å¹¶åˆ é™¤ï¼š
```typescript
{/* åˆ é™¤æ•´ä¸ªCardæˆ–ç›¸å…³çš„Form.Item */}
<Card title="é€šé“é…ç½®" size="small" style={{ marginBottom: 16 }}>
  {/* åˆ é™¤ gateway_signature ç›¸å…³çš„ Form.Item */}
  {/* åˆ é™¤ remove_signature ç›¸å…³çš„ Form.Item */}
  {/* åˆ é™¤ uplink_config ç›¸å…³çš„ Form.Item */}
</Card>
```

##### 4.3 ä¿®æ”¹ `frontend/src/pages/ChannelManagement/components/ParamConfigModal.tsx`

**ä½ç½®1**: åˆ é™¤æ¥å£æ‰©å±•ä¸­çš„å­—æ®µï¼ˆçº¦ç¬¬35è¡Œï¼‰
```typescript
interface ParameterFormValues extends UpdateChannelParametersRequest {
  protocol: string;
  // UpdateChannelParametersRequestå·²ç»ä¸åŒ…å«SMPPå­—æ®µäº†
}
```

**ä½ç½®2**: åˆ é™¤é»˜è®¤å€¼ï¼ˆçº¦ç¬¬41-54è¡Œï¼‰
```typescript
const DEFAULT_FORM_VALUES: ParameterFormValues = {
  protocol: '',
  gateway_address: '',
  gateway_port: 2775,
  account: '',
  password: '',
  connection_count: 1,
  total_speed: 1,
  default_encoding: 0,
  // åˆ é™¤ä»¥ä¸‹4è¡Œ âŒ
  // source_addr_ton: 0,
  // source_addr_npi: 0,
  // dest_addr_ton: 0,
  // dest_addr_npi: 0,
};
```

**ä½ç½®3**: åˆ é™¤useEffectä¸­çš„å­—æ®µè®¾ç½®ï¼ˆçº¦ç¬¬78-92è¡Œï¼‰
```typescript
useEffect(() => {
  if (!open) {
    form.resetFields();
    return;
  }

  if (parameterDetail) {
    form.setFieldsValue({
      // ... å…¶ä»–å­—æ®µ ...
      // åˆ é™¤ä»¥ä¸‹4è¡Œ âŒ
      // source_addr_ton: parameterDetail.source_addr_ton,
      // source_addr_npi: parameterDetail.source_addr_npi,
      // dest_addr_ton: parameterDetail.dest_addr_ton,
      // dest_addr_npi: parameterDetail.dest_addr_npi,
    });
  }
}, [open, parameterDetail, form]);
```

**ä½ç½®4**: åˆ é™¤æäº¤æ—¶çš„å­—æ®µï¼ˆçº¦ç¬¬113-125è¡Œï¼‰
```typescript
const payload: UpdateChannelParametersRequest = {
  gateway_address: values.gateway_address,
  gateway_port: values.gateway_port,
  account: values.account.trim(),
  password: values.password,
  connection_count: values.connection_count,
  total_speed: values.total_speed,
  default_encoding: values.default_encoding,
  // åˆ é™¤ä»¥ä¸‹4è¡Œ âŒ
  // source_addr_ton: values.source_addr_ton,
  // source_addr_npi: values.source_addr_npi,
  // dest_addr_ton: values.dest_addr_ton,
  // dest_addr_npi: values.dest_addr_npi,
};
```

**ä½ç½®5**: åˆ é™¤è¡¨å•UIï¼ˆçº¦ç¬¬269-327è¡Œï¼Œæœç´¢ "åè®®å‚æ•°"ï¼‰
```typescript
{/* åˆ é™¤æ•´ä¸ª "åè®®å‚æ•°" éƒ¨åˆ†çš„ Row å’Œ Col */}
<Divider />
<Title level={5}>åè®®å‚æ•°</Title>
<Row gutter={16}>
  {/* åˆ é™¤æ‰€æœ‰åŒ…å« source_addr_ton, source_addr_npi, dest_addr_ton, dest_addr_npi çš„ Form.Item */}
</Row>
```

##### 4.4 å‰ç«¯æµ‹è¯•éªŒè¯
```bash
cd /Users/yukun-admin/projects/pigeon/pigeon_web/frontend
npm run build  # ç¡®ä¿æ²¡æœ‰TypeScripté”™è¯¯
npm run type-check  # ç¡®ä¿ç±»å‹æ£€æŸ¥é€šè¿‡
```

---

#### ğŸ”§ æ­¥éª¤5: ä¿®æ”¹åç«¯ä»£ç 

##### 5.1 ä¿®æ”¹ `app/models/customers/channel.py`

**ä½ç½®1**: åˆ é™¤æšä¸¾ç±»å®šä¹‰ï¼ˆçº¦ç¬¬52-56è¡Œï¼‰
```python
# åˆ é™¤æ•´ä¸ª UplinkConfig æšä¸¾ç±» âŒ
# class UplinkConfig(enum.Enum):
#     """Uplink configuration enumeration."""
#     EXTEND_MATCH = 'extend_match'
#     DELIVER_MATCH = 'deliver_match'
```

**ä½ç½®2**: åˆ é™¤Modelå­—æ®µå®šä¹‰ï¼ˆçº¦ç¬¬81-84è¡Œï¼‰
```python
class Channel(db.Model):
    # ... å…¶ä»–å­—æ®µ ...

    # åˆ é™¤ä»¥ä¸‹3ä¸ªå­—æ®µ âŒ
    # gateway_signature = db.Column(db.Boolean, default=False, comment='Gateway signature enabled')
    # remove_signature = db.Column(db.Boolean, default=False, comment='Remove signature enabled')
    # uplink_config = db.Column(db.Enum(UplinkConfig, values_callable=lambda obj: [e.value for e in obj]),
    #                          default=UplinkConfig.DELIVER_MATCH, comment='Uplink configuration type')
```

**ä½ç½®3**: åˆ é™¤to_dictæ–¹æ³•ä¸­çš„å­—æ®µï¼ˆçº¦ç¬¬314è¡Œï¼‰
```python
def to_dict(self, include_relationships=False):
    result = {
        # ... å…¶ä»–å­—æ®µ ...
        # åˆ é™¤ä»¥ä¸‹3è¡Œ âŒ
        # 'gateway_signature': self.gateway_signature,
        # 'remove_signature': self.remove_signature,
        # 'uplink_config': self.uplink_config.value if self.uplink_config else None,
    }
```

**ä½ç½®4**: æ›´æ–° `app/models/customers/__init__.py`ï¼ˆçº¦ç¬¬26å’Œ67è¡Œï¼‰
```python
# åˆ é™¤å¯¼å…¥å’Œå¯¼å‡º
from app.models.customers.channel import (
    Channel,
    ConnectionStatus,
    ChannelStatus,
    ChannelType,
    PaymentType,
    BillingMethod,
    # UplinkConfig  # âŒ åˆ é™¤è¿™ä¸€è¡Œ
)

__all__ = [
    # ... å…¶ä»–å¯¼å‡º ...
    'PaymentType',
    'BillingMethod',
    # 'UplinkConfig',  # âŒ åˆ é™¤è¿™ä¸€è¡Œ
]
```

##### 5.2 ä¿®æ”¹ `app/api/v1/channels/schema/channel.py`

**ä½ç½®1**: åˆ é™¤ChannelSchemaä¸­çš„å­—æ®µï¼ˆçº¦ç¬¬32-38è¡Œï¼‰
```python
class ChannelSchema(Schema):
    # ... å…¶ä»–å­—æ®µ ...

    # åˆ é™¤ä»¥ä¸‹3ä¸ªå­—æ®µ âŒ
    # gateway_signature = fields.Bool(load_default=False)
    # remove_signature = fields.Bool(load_default=False)
    # uplink_config = fields.Str(
    #     validate=validate.OneOf(['extend_match', 'deliver_match']),
    #     load_default='deliver_match'
    # )
```

**ä½ç½®2**: åˆ é™¤ChannelParameterDetailSchemaä¸­çš„SMPPå­—æ®µï¼ˆçº¦ç¬¬657-660è¡Œï¼‰
```python
class ChannelParameterDetailSchema(Schema):
    # ... å…¶ä»–å­—æ®µ ...
    # åˆ é™¤ä»¥ä¸‹4è¡Œ âŒ
    # source_addr_ton = fields.Int(required=True)
    # source_addr_npi = fields.Int(required=True)
    # dest_addr_ton = fields.Int(required=True)
    # dest_addr_npi = fields.Int(required=True)
```

**ä½ç½®3**: åˆ é™¤ChannelParameterUpdateSchemaä¸­çš„SMPPå­—æ®µï¼ˆçº¦ç¬¬677-680è¡Œï¼‰
```python
class ChannelParameterUpdateSchema(Schema):
    # ... å…¶ä»–å­—æ®µ ...
    # åˆ é™¤ä»¥ä¸‹4è¡Œ âŒ
    # source_addr_ton = fields.Int(required=True, validate=validate.OneOf([0, 1, 2, 3, 4, 5, 6]))
    # source_addr_npi = fields.Int(required=True, validate=validate.OneOf([0, 1, 3, 4, 6, 8, 9, 10, 14, 18]))
    # dest_addr_ton = fields.Int(required=True, validate=validate.OneOf([0, 1, 2, 3, 4, 5, 6]))
    # dest_addr_npi = fields.Int(required=True, validate=validate.OneOf([0, 1, 3, 4, 6, 8, 9, 10, 14, 18]))
```

##### 5.3 ä¿®æ”¹ `app/services/channels/channel_service.py`

**ä½ç½®1**: åˆ é™¤æ›´æ–°å‚æ•°æ—¶çš„SMPPå­—æ®µå¤„ç†ï¼ˆçº¦ç¬¬706-709è¡Œï¼‰
```python
def update_channel_parameters(self, channel_id: str, data: dict, admin_id: int = None):
    # ... å…¶ä»–ä»£ç  ...

    # åˆ é™¤ä»¥ä¸‹4è¡Œ âŒ
    # config['source_addr_ton'] = params['source_addr_ton']
    # config['source_addr_npi'] = params['source_addr_npi']
    # config['dest_addr_ton'] = params['dest_addr_ton']
    # config['dest_addr_npi'] = params['dest_addr_npi']
```

**ä½ç½®2**: åˆ é™¤å¯¼å‡ºå­—æ®µå®šä¹‰ï¼ˆçº¦ç¬¬1164-1165, 1178-1181è¡Œï¼‰
```python
# åˆ é™¤å¯¼å‡ºå­—æ®µåˆ—è¡¨ä¸­çš„SMPPå­—æ®µ
default_fields = [
    'protocol', 'path', 'port', 'upstream_account', 'password',
    'max_connection', 'rate_limit',  # 'gmp7_attribute'
    # åˆ é™¤è¿™4ä¸ªå­—æ®µ âŒ
    # 'source_addr_ton', 'source_addr_npi',
    # 'dest_addr_ton', 'dest_addr_npi',
]

# åˆ é™¤ä¸­æ–‡è¡¨å¤´æ˜ å°„
chinese_headers = {
    # ... å…¶ä»–å­—æ®µ ...
    # åˆ é™¤è¿™4è¡Œ âŒ
    # 'source_addr_ton': 'source_addr_ton',
    # 'source_addr_npi': 'source_addr_npi',
    # 'dest_addr_ton': 'dest_addr_ton',
    # 'dest_addr_npi': 'dest_addr_npi'
}
```

**ä½ç½®3**: åˆ é™¤è·å–å‚æ•°è¯¦æƒ…æ—¶çš„å­—æ®µï¼ˆçº¦ç¬¬2486-2489è¡Œï¼‰
```python
def get_channel_parameters(self, channel_id: str):
    # ... å…¶ä»–ä»£ç  ...
    parameters = {
        # ... å…¶ä»–å­—æ®µ ...
        # åˆ é™¤ä»¥ä¸‹4è¡Œ âŒ
        # 'source_addr_ton': _to_int(config.get('source_addr_ton')),
        # 'source_addr_npi': _to_int(config.get('source_addr_npi')),
        # 'dest_addr_ton': _to_int(config.get('dest_addr_ton')),
        # 'dest_addr_npi': _to_int(config.get('dest_addr_npi')),
    }
```

**ä½ç½®4**: åˆ é™¤å‚æ•°éªŒè¯é€»è¾‘ï¼ˆçº¦ç¬¬2584-2589è¡Œï¼‰
```python
def _validate_parameters(self, data: dict) -> None:
    # ... å…¶ä»–éªŒè¯ ...

    # åˆ é™¤TONå­—æ®µéªŒè¯ âŒ
    # ton_fields = ['source_addr_ton', 'dest_addr_ton']
    # valid_ton_values = [0, 1, 2, 3, 4, 5, 6]
    # for field in ton_fields:
    #     value = int(data[field])
    #     if value not in valid_ton_values:
    #         raise ValueError(f'{field} å¿…é¡»ä¸ºä»¥ä¸‹å€¼ä¹‹ä¸€: {valid_ton_values}')

    # ç±»ä¼¼åœ°åˆ é™¤NPIå­—æ®µéªŒè¯
```

**ä½ç½®5**: åˆ é™¤å¯¼å‡ºå­—æ®µæ ¼å¼åŒ–é€»è¾‘ï¼ˆçº¦ç¬¬2616-2618è¡Œï¼‰
```python
def _format_export_field_value(self, channel, field: str) -> str:
    # åˆ é™¤SMPPå­—æ®µçš„ç‰¹æ®Šå¤„ç† âŒ
    # if field in ['source_addr_ton', 'source_addr_npi', 'dest_addr_ton', 'dest_addr_npi']:
    #     config = channel.channel_config or {}
    #     return str(config.get(field, ''))
```

##### 5.4 åç«¯æµ‹è¯•éªŒè¯
```bash
cd /Users/yukun-admin/projects/pigeon/pigeon_web

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source /Users/yukun-admin/projects/pigeon/venv/bin/activate

# è¿è¡Œè¯­æ³•æ£€æŸ¥
python -m py_compile app/models/customers/channel.py
python -m py_compile app/api/v1/channels/schema/channel.py
python -m py_compile app/services/channels/channel_service.py

# è¿è¡Œç›¸å…³æµ‹è¯•
pytest tests/channels/ -v
```

---

#### ğŸ—„ï¸ æ­¥éª¤6: ä¿®æ”¹æ•°æ®åº“ç»“æ„

âš ï¸ **è­¦å‘Š**: è¿™æ˜¯æœ€å±é™©çš„æ­¥éª¤ï¼Œä¸€æ—¦æ‰§è¡Œæ— æ³•é€šè¿‡ä»£ç å›æ»šï¼Œåªèƒ½é€šè¿‡æ•°æ®åº“å¤‡ä»½æ¢å¤ã€‚

##### 6.1 åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬

åˆ›å»ºæ–‡ä»¶: `pigeon_web/sql/migrations/remove_unused_channel_fields.sql`

```sql
-- Copyright(c) 2025
-- All rights reserved.
--
-- Author: yukun.xing <xingyukun@gmail.com>
-- Date:   2025/10/29
--
-- Migration: Remove unused channel configuration fields
-- åˆ é™¤ä¸å†ä½¿ç”¨çš„é€šé“é…ç½®å­—æ®µ

BEGIN;

-- Step 1: åˆ é™¤channelsè¡¨çš„3ä¸ªåˆ—
-- æ³¨æ„ï¼šè¿™ä¼šæ°¸ä¹…åˆ é™¤è¿™äº›åˆ—çš„æ‰€æœ‰æ•°æ®
ALTER TABLE mgmt.channels DROP COLUMN IF EXISTS gateway_signature;
ALTER TABLE mgmt.channels DROP COLUMN IF EXISTS remove_signature;
ALTER TABLE mgmt.channels DROP COLUMN IF EXISTS uplink_config;

-- Step 2: åˆ é™¤uplink_configæšä¸¾ç±»å‹
-- æ³¨æ„ï¼šåªæœ‰åœ¨æ²¡æœ‰å…¶ä»–åœ°æ–¹ä½¿ç”¨æ—¶æ‰èƒ½åˆ é™¤
DROP TYPE IF EXISTS mgmt.uplink_config;

-- Step 3: æ¸…ç†channel_configä¸­çš„SMPPå­—æ®µï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
-- è¿™äº›å­—æ®µå­˜å‚¨åœ¨JSONBä¸­ï¼Œåˆ é™¤å®ƒä»¬å¯ä»¥å‡å°‘å­˜å‚¨ç©ºé—´
UPDATE mgmt.channels
SET channel_config = channel_config - 'source_addr_ton' - 'source_addr_npi' - 'dest_addr_ton' - 'dest_addr_npi'
WHERE channel_config ?| ARRAY['source_addr_ton', 'source_addr_npi', 'dest_addr_ton', 'dest_addr_npi'];

COMMIT;

-- éªŒè¯ï¼šæ£€æŸ¥å­—æ®µæ˜¯å¦å·²åˆ é™¤
SELECT
    column_name,
    data_type
FROM information_schema.columns
WHERE table_schema = 'mgmt'
  AND table_name = 'channels'
  AND column_name IN ('gateway_signature', 'remove_signature', 'uplink_config');
-- åº”è¯¥è¿”å›0è¡Œ

-- éªŒè¯ï¼šæ£€æŸ¥æšä¸¾ç±»å‹æ˜¯å¦å·²åˆ é™¤
SELECT typname
FROM pg_type
WHERE typname = 'uplink_config'
  AND typnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'mgmt');
-- åº”è¯¥è¿”å›0è¡Œ
```

##### 6.2 ä¿®æ”¹æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

**æ–‡ä»¶1**: `pigeon_web/sql/modules/base.sql`

æ‰¾åˆ° uplink_config æšä¸¾å®šä¹‰ï¼ˆçº¦ç¬¬131-136è¡Œï¼‰å¹¶åˆ é™¤ï¼š
```sql
-- åˆ é™¤ä»¥ä¸‹éƒ¨åˆ† âŒ
-- -- Uplink configuration enum - FEAT-6-2-1
-- DO $$ BEGIN
--     CREATE TYPE mgmt.uplink_config AS ENUM ('extend_match', 'deliver_match');
-- EXCEPTION
--     WHEN duplicate_object THEN null;
-- END$$;
```

**æ–‡ä»¶2**: `pigeon_web/sql/modules/channels.sql`

æ‰¾åˆ° channels è¡¨å®šä¹‰ï¼ˆçº¦ç¬¬29-32è¡Œï¼‰å¹¶åˆ é™¤è¿™3ä¸ªå­—æ®µï¼š
```sql
CREATE TABLE IF NOT EXISTS mgmt.channels (
    -- ... å…¶ä»–å­—æ®µ ...

    -- åˆ é™¤ä»¥ä¸‹3è¡Œ âŒ
    -- gateway_signature BOOLEAN DEFAULT FALSE,
    -- remove_signature BOOLEAN DEFAULT FALSE,
    -- uplink_config mgmt.uplink_config DEFAULT 'deliver_match',

    -- ... å…¶ä»–å­—æ®µ ...
);
```

åŒæ—¶åˆ é™¤ç›¸å…³çš„æ³¨é‡Šè¯´æ˜ï¼ˆæœç´¢ "Status configuration - FEAT-6-2-1"ï¼‰ã€‚

##### 6.3 æ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
# 1. ç¡®ä¿æ•°æ®åº“æœåŠ¡è¿è¡Œ
cd /Users/yukun-admin/projects/pigeon/pigeon_web/tests/e2e/docker
docker-compose ps  # æ£€æŸ¥æ•°æ®åº“çŠ¶æ€

# 2. è¿æ¥åˆ°æ•°æ®åº“
PGPASSWORD=integration_test_password psql -h localhost -p 5433 -U postgres -d pigeon_web

# 3. åœ¨psqlä¸­æ‰§è¡Œè¿ç§»
\i /Users/yukun-admin/projects/pigeon/pigeon_web/sql/migrations/remove_unused_channel_fields.sql

# 4. éªŒè¯è¡¨ç»“æ„
\d mgmt.channels

# 5. é€€å‡ºpsql
\q
```

##### 6.4 éªŒè¯æ•°æ®åº“å˜æ›´
```sql
-- è¿æ¥æ•°æ®åº“åæ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢

-- 1. ç¡®è®¤åˆ—å·²åˆ é™¤
SELECT column_name
FROM information_schema.columns
WHERE table_schema = 'mgmt'
  AND table_name = 'channels'
  AND column_name IN ('gateway_signature', 'remove_signature', 'uplink_config');
-- æœŸæœ›: 0è¡Œ

-- 2. ç¡®è®¤æšä¸¾ç±»å‹å·²åˆ é™¤
SELECT typname
FROM pg_type
WHERE typname = 'uplink_config'
  AND typnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'mgmt');
-- æœŸæœ›: 0è¡Œ

-- 3. æ£€æŸ¥channel_configä¸­çš„SMPPå­—æ®µæ˜¯å¦æ¸…ç†
SELECT
    channel_id,
    channel_name,
    channel_config ? 'source_addr_ton' as has_source_ton,
    channel_config ? 'dest_addr_ton' as has_dest_ton
FROM mgmt.channels
WHERE channel_config ?| ARRAY['source_addr_ton', 'source_addr_npi', 'dest_addr_ton', 'dest_addr_npi'];
-- æœŸæœ›: 0è¡Œ

-- 4. éšæœºæŠ½æŸ¥å‡ æ¡é€šé“æ•°æ®å®Œæ•´æ€§
SELECT
    channel_id,
    channel_name,
    status,
    is_enabled,
    payment_type,
    billing_method
FROM mgmt.channels
LIMIT 5;
-- æœŸæœ›: æ•°æ®æ­£å¸¸ï¼Œæ²¡æœ‰NULLå€¼å¼‚å¸¸
```

---

### 3.3 æµ‹è¯•éªŒè¯é˜¶æ®µ

#### âœ… æ­¥éª¤7: é›†æˆæµ‹è¯•

##### 7.1 å¯åŠ¨æœåŠ¡
```bash
# 1. å¯åŠ¨æ•°æ®åº“å’Œä¸­é—´ä»¶
cd /Users/yukun-admin/projects/pigeon/pigeon_web/tests/e2e/docker
docker-compose up -d

# 2. å¯åŠ¨åç«¯æœåŠ¡
cd /Users/yukun-admin/projects/pigeon/pigeon_web
source /Users/yukun-admin/projects/pigeon/venv/bin/activate
python run.py

# 3. å¯åŠ¨å‰ç«¯æœåŠ¡ï¼ˆæ–°ç»ˆç«¯ï¼‰
cd /Users/yukun-admin/projects/pigeon/pigeon_web/frontend
npm run dev
```

##### 7.2 åŠŸèƒ½æµ‹è¯•æ¸…å•

| æµ‹è¯•é¡¹ | æµ‹è¯•å†…å®¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|-------|---------|---------|---------|------|
| é€šé“åˆ—è¡¨ | è®¿é—®é€šé“ç®¡ç†é¡µé¢ | æ­£å¸¸æ˜¾ç¤ºé€šé“åˆ—è¡¨ | | â¬œ |
| é€šé“è¯¦æƒ… | æŸ¥çœ‹ä»»æ„é€šé“è¯¦æƒ… | è¯¦æƒ…é¡µé¢ä¸æ˜¾ç¤ºå·²åˆ é™¤å­—æ®µ | | â¬œ |
| åˆ›å»ºé€šé“ | åˆ›å»ºæ–°é€šé“ | è¡¨å•ä¸åŒ…å«å·²åˆ é™¤å­—æ®µï¼Œåˆ›å»ºæˆåŠŸ | | â¬œ |
| ç¼–è¾‘é€šé“ | ç¼–è¾‘ç°æœ‰é€šé“ | è¡¨å•ä¸åŒ…å«å·²åˆ é™¤å­—æ®µï¼Œä¿å­˜æˆåŠŸ | | â¬œ |
| å‚æ•°é…ç½® | æ‰“å¼€å‚æ•°é…ç½®å¯¹è¯æ¡† | ä¸æ˜¾ç¤ºSMPP 4ä¸ªå­—æ®µ | | â¬œ |
| å‚æ•°ä¿®æ”¹ | ä¿®æ”¹é€šé“å‚æ•° | ä¿®æ”¹æˆåŠŸï¼Œä¸åŒ…å«å·²åˆ é™¤å­—æ®µ | | â¬œ |
| APIå…¼å®¹ | è°ƒç”¨æ—§APIï¼ˆå¦‚æœæœ‰ï¼‰ | è¿”å›æ•°æ®ä¸åŒ…å«å·²åˆ é™¤å­—æ®µ | | â¬œ |
| æ•°æ®å®Œæ•´æ€§ | æ£€æŸ¥ç°æœ‰é€šé“æ•°æ® | å…¶ä»–å­—æ®µæ•°æ®å®Œæ•´ï¼Œæ— å¼‚å¸¸ | | â¬œ |

##### 7.3 APIæµ‹è¯•

ä½¿ç”¨ curl æˆ– Postman æµ‹è¯•ä»¥ä¸‹APIï¼š

```bash
# 1. è·å–é€šé“åˆ—è¡¨
curl -X GET "http://localhost:5173/api/v1/channels?page=1&page_size=10" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. è·å–å•ä¸ªé€šé“è¯¦æƒ…
curl -X GET "http://localhost:5173/api/v1/channels/25090501" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. è·å–é€šé“å‚æ•°
curl -X GET "http://localhost:5173/api/v1/channels/25090501/parameters" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 4. æ›´æ–°é€šé“å‚æ•°ï¼ˆä¸åŒ…å«å·²åˆ é™¤å­—æ®µï¼‰
curl -X PUT "http://localhost:5173/api/v1/channels/25090501/parameters" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "gateway_address": "127.0.0.1",
    "gateway_port": 2775,
    "account": "test_account",
    "password": "test_pass",
    "connection_count": 5,
    "total_speed": 100,
    "default_encoding": 0
  }'

# æœŸæœ›: æ‰€æœ‰APIæ­£å¸¸è¿”å›ï¼Œä¸åŒ…å«å·²åˆ é™¤çš„7ä¸ªå­—æ®µ
```

##### 7.4 å‰ç«¯ç•Œé¢æµ‹è¯•

æ‰“å¼€æµè§ˆå™¨è®¿é—®: http://localhost:5173/business/channel-management

**æµ‹è¯•æ­¥éª¤**:
1. âœ… é¡µé¢æ­£å¸¸åŠ è½½ï¼Œæ²¡æœ‰consoleé”™è¯¯
2. âœ… ç‚¹å‡»"æ–°å»ºé€šé“"æŒ‰é’®
3. âœ… ç¡®è®¤è¡¨å•ä¸­**ä¸åŒ…å«**ä»¥ä¸‹å­—æ®µï¼š
   - ç½‘å…³ç­¾å
   - æ‹†é™¤ç­¾å
   - ä¸Šè¡ŒåŒ¹é…
4. âœ… å¡«å†™å…¶ä»–å¿…å¡«å­—æ®µï¼Œä¿å­˜æˆåŠŸ
5. âœ… é€‰æ‹©ä»»æ„é€šé“ï¼Œç‚¹å‡»"å‚æ•°é…ç½®"
6. âœ… ç¡®è®¤å¯¹è¯æ¡†ä¸­**ä¸åŒ…å«**ä»¥ä¸‹å­—æ®µï¼š
   - source_addr_ton
   - source_addr_npi
   - dest_addr_ton
   - dest_addr_npi
7. âœ… ä¿®æ”¹ä»»æ„å‚æ•°ï¼Œä¿å­˜æˆåŠŸ

##### 7.5 æ•°æ®åº“æ•°æ®éªŒè¯
```sql
-- éšæœºé€‰æ‹©ä¸€ä¸ªé€šé“ï¼ŒéªŒè¯æ•°æ®å®Œæ•´æ€§
SELECT
    channel_id,
    channel_name,
    status,
    payment_type,
    billing_method,
    sms_billing_count,
    long_sms_billing_count,
    is_enabled,
    channel_config
FROM mgmt.channels
WHERE channel_id = '25090501';

-- æœŸæœ›:
-- 1. æ‰€æœ‰ä¿ç•™å­—æ®µéƒ½æœ‰æ­£ç¡®çš„å€¼
-- 2. channel_config ä¸­ä¸åŒ…å« source_addr_ton ç­‰4ä¸ªSMPPå­—æ®µ
```

---

### 3.4 æäº¤ä»£ç é˜¶æ®µ

#### âœ… æ­¥éª¤8: æäº¤Git

```bash
cd /Users/yukun-admin/projects/pigeon/pigeon_web

# 1. æŸ¥çœ‹ä¿®æ”¹çš„æ–‡ä»¶
git status

# 2. æ·»åŠ æ‰€æœ‰ä¿®æ”¹
git add -A

# 3. æäº¤ä»£ç ï¼ˆéµå¾ªæäº¤è§„èŒƒï¼‰
git commit -m "refactor(channels): remove unused channel configuration fields

Remove 7 unused channel configuration fields:
- gateway_signature (database column)
- remove_signature (database column)
- uplink_config (database column + enum type)
- source_addr_ton (JSONB field)
- source_addr_npi (JSONB field)
- dest_addr_ton (JSONB field)
- dest_addr_npi (JSONB field)

Changes:
- Frontend: Remove fields from ChannelFormModal and ParamConfigModal
- Backend: Remove Model fields, Schema validations, and Service logic
- Database: Drop columns, enum type, and clean JSONB data

Breaking Change: This is a breaking change for frontend clients.
Migration script: sql/migrations/remove_unused_channel_fields.sql"

# 4. æ¨é€åˆ°è¿œç¨‹ä»“åº“
git push origin refactor/remove-unused-channel-fields
```

#### âœ… æ­¥éª¤9: ä»£ç å®¡æŸ¥

å¦‚æœéœ€è¦PRå®¡æŸ¥ï¼ˆæ ¹æ®CLAUDE.mdè§„åˆ™ï¼Œpigeon_webåœ¨mainåˆ†æ”¯ç›´æ¥ä¿®æ”¹ï¼Œè¿™é‡Œä»…ä¾›å‚è€ƒï¼‰ï¼š

**å®¡æŸ¥è¦ç‚¹**:
- [ ] æ‰€æœ‰7ä¸ªå­—æ®µéƒ½å·²åˆ é™¤
- [ ] æ²¡æœ‰é—æ¼çš„å¼•ç”¨
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬æ­£ç¡®
- [ ] æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] APIæ–‡æ¡£å·²æ›´æ–°ï¼ˆå¦‚æœæœ‰ï¼‰

---

## 4. å›æ»šæ–¹æ¡ˆ

### 4.1 ç´§æ€¥å›æ»šï¼ˆä»£ç å›æ»šï¼‰

å¦‚æœå‘ç°é—®é¢˜éœ€è¦ç´§æ€¥å›æ»šï¼š

```bash
cd /Users/yukun-admin/projects/pigeon/pigeon_web

# 1. å›æ»šGitæäº¤
git revert HEAD  # æˆ– git reset --hard HEAD~1

# 2. é‡æ–°éƒ¨ç½²å‰ç«¯
cd frontend
npm run build

# 3. é‡å¯åç«¯
# æ ¹æ®å®é™…æƒ…å†µé‡å¯æœåŠ¡
```

âš ï¸ **æ³¨æ„**: Gitå›æ»šåªèƒ½æ¢å¤ä»£ç ï¼Œ**æ— æ³•æ¢å¤å·²åˆ é™¤çš„æ•°æ®åº“æ•°æ®**ï¼

### 4.2 æ•°æ®åº“å›æ»šï¼ˆä½¿ç”¨å¤‡ä»½ï¼‰

å¦‚æœéœ€è¦æ¢å¤æ•°æ®åº“ç»“æ„å’Œæ•°æ®ï¼š

```bash
# 1. åœæ­¢åº”ç”¨æœåŠ¡

# 2. æ¢å¤æ•°æ®åº“å¤‡ä»½ï¼ˆä½¿ç”¨æ­¥éª¤1åˆ›å»ºçš„å¤‡ä»½ï¼‰
PGPASSWORD=integration_test_password psql -h localhost -p 5433 -U postgres -d pigeon_web \
  < backup/schema_backup_YYYYMMDD_HHMMSS.sql

# 3. æ¢å¤æ•°æ®
PGPASSWORD=integration_test_password psql -h localhost -p 5433 -U postgres -d pigeon_web \
  < backup/channels_backup_YYYYMMDD_HHMMSS.sql

# 4. éªŒè¯æ¢å¤
PGPASSWORD=integration_test_password psql -h localhost -p 5433 -U postgres -d pigeon_web \
  -c "\d mgmt.channels"

# 5. é‡å¯åº”ç”¨æœåŠ¡
```

### 4.3 æ‰‹åŠ¨æ¢å¤ï¼ˆå¦‚æœæ²¡æœ‰å®Œæ•´å¤‡ä»½ï¼‰

åˆ›å»ºæ–‡ä»¶: `pigeon_web/sql/migrations/restore_removed_fields.sql`

```sql
-- æ¢å¤åˆ é™¤çš„å­—æ®µ
BEGIN;

-- æ¢å¤æšä¸¾ç±»å‹
CREATE TYPE mgmt.uplink_config AS ENUM ('extend_match', 'deliver_match');

-- æ¢å¤åˆ—
ALTER TABLE mgmt.channels
  ADD COLUMN gateway_signature BOOLEAN DEFAULT FALSE,
  ADD COLUMN remove_signature BOOLEAN DEFAULT FALSE,
  ADD COLUMN uplink_config mgmt.uplink_config DEFAULT 'deliver_match';

-- ä¸ºç°æœ‰è®°å½•è®¾ç½®é»˜è®¤å€¼
UPDATE mgmt.channels
SET
  gateway_signature = FALSE,
  remove_signature = FALSE,
  uplink_config = 'deliver_match'
WHERE gateway_signature IS NULL
   OR remove_signature IS NULL
   OR uplink_config IS NULL;

COMMIT;
```

âš ï¸ **é‡è¦æç¤º**: è¿™åªèƒ½æ¢å¤å­—æ®µç»“æ„ï¼Œ**æ— æ³•æ¢å¤è¢«åˆ é™¤çš„æ•°æ®å€¼**ï¼

---

## 5. é£é™©è¯„ä¼°ä¸åº”å¯¹

### 5.1 é£é™©çŸ©é˜µ

| é£é™©é¡¹ | å¯èƒ½æ€§ | å½±å“ç¨‹åº¦ | é£é™©ç­‰çº§ | åº”å¯¹æªæ–½ |
|-------|--------|---------|---------|---------|
| æ•°æ®æ°¸ä¹…ä¸¢å¤± | ä½ | é«˜ | ğŸŸ¡ ä¸­ | æ‰§è¡Œå‰å®Œæ•´å¤‡ä»½ |
| APIä¸å…¼å®¹ | ä¸­ | ä¸­ | ğŸŸ¡ ä¸­ | ç‰ˆæœ¬å·å‡çº§ï¼Œæ–‡æ¡£æ›´æ–° |
| å‰ç«¯é¡µé¢æŠ¥é”™ | ä½ | ä½ | ğŸŸ¢ ä½ | TypeScriptç¼–è¯‘æ£€æŸ¥ |
| ç°æœ‰é€šé“æ— æ³•ä½¿ç”¨ | æä½ | é«˜ | ğŸŸ¢ ä½ | å……åˆ†æµ‹è¯•ï¼Œç°åº¦å‘å¸ƒ |
| æ•°æ®åº“è¿ç§»å¤±è´¥ | ä½ | é«˜ | ğŸŸ¡ ä¸­ | äº‹åŠ¡ä¿æŠ¤ï¼Œå‡†å¤‡å›æ»š |

### 5.2 åº”æ€¥é¢„æ¡ˆ

#### é¢„æ¡ˆ1: æ•°æ®åº“è¿ç§»å¤±è´¥
- **è§¦å‘æ¡ä»¶**: æ‰§è¡Œè¿ç§»è„šæœ¬æ—¶å‡ºé”™
- **å¤„ç†æ­¥éª¤**:
  1. ç«‹å³æ‰§è¡Œ ROLLBACKï¼ˆå¦‚æœè¿˜åœ¨äº‹åŠ¡ä¸­ï¼‰
  2. æ£€æŸ¥é”™è¯¯æ—¥å¿—
  3. ä½¿ç”¨å¤‡ä»½æ¢å¤æ•°æ®åº“
  4. é‡æ–°è¯„ä¼°è¿ç§»è„šæœ¬

#### é¢„æ¡ˆ2: å‰ç«¯é¡µé¢å¼‚å¸¸
- **è§¦å‘æ¡ä»¶**: é¡µé¢æ— æ³•åŠ è½½æˆ–åŠŸèƒ½å¼‚å¸¸
- **å¤„ç†æ­¥éª¤**:
  1. æ£€æŸ¥æµè§ˆå™¨Consoleé”™è¯¯
  2. æ£€æŸ¥APIè¿”å›çš„æ•°æ®ç»“æ„
  3. ä¸´æ—¶å›æ»šå‰ç«¯ä»£ç 
  4. ä¿®å¤é—®é¢˜åé‡æ–°éƒ¨ç½²

#### é¢„æ¡ˆ3: åç«¯APIå¼‚å¸¸
- **è§¦å‘æ¡ä»¶**: APIè¿”å›500é”™è¯¯
- **å¤„ç†æ­¥éª¤**:
  1. æ£€æŸ¥åç«¯æ—¥å¿—
  2. ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸
  3. æ£€æŸ¥Modelå’ŒSchemaå®šä¹‰
  4. ä¸´æ—¶å›æ»šåç«¯ä»£ç 

---

## 6. ä¸Šçº¿æ£€æŸ¥æ¸…å•

### 6.1 ä»£ç æ£€æŸ¥

- [ ] å‰ç«¯TypeScriptç¼–è¯‘é€šè¿‡
- [ ] å‰ç«¯ç±»å‹æ£€æŸ¥é€šè¿‡ (npm run type-check)
- [ ] åç«¯Pythonè¯­æ³•æ£€æŸ¥é€šè¿‡
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] ä»£ç å·²æäº¤åˆ°Git
- [ ] Gitæäº¤ä¿¡æ¯ç¬¦åˆè§„èŒƒ

### 6.2 æ•°æ®åº“æ£€æŸ¥

- [ ] æ•°æ®åº“å¤‡ä»½å·²åˆ›å»º
- [ ] è¿ç§»è„šæœ¬å·²æµ‹è¯•
- [ ] è¿ç§»è„šæœ¬ä½¿ç”¨äº‹åŠ¡ä¿æŠ¤
- [ ] å·²ç¡®è®¤æšä¸¾ç±»å‹æ²¡æœ‰å…¶ä»–ä¾èµ–
- [ ] éªŒè¯SQLå·²å‡†å¤‡

### 6.3 åŠŸèƒ½æ£€æŸ¥

- [ ] é€šé“åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
- [ ] é€šé“åˆ›å»ºåŠŸèƒ½æ­£å¸¸
- [ ] é€šé“ç¼–è¾‘åŠŸèƒ½æ­£å¸¸
- [ ] å‚æ•°é…ç½®åŠŸèƒ½æ­£å¸¸
- [ ] APIå“åº”æ•°æ®æ­£ç¡®
- [ ] æ²¡æœ‰consoleé”™è¯¯
- [ ] ç°æœ‰é€šé“æ•°æ®å®Œæ•´

### 6.4 æ–‡æ¡£æ£€æŸ¥

- [ ] æ›´æ–°APIæ–‡æ¡£ï¼ˆå¦‚æœæœ‰ï¼‰
- [ ] æ›´æ–°æ•°æ®åº“æ–‡æ¡£ï¼ˆå¦‚æœæœ‰ï¼‰
- [ ] è®°å½•å˜æ›´æ—¥å¿—
- [ ] æ›´æ–°ç›¸å…³çš„å¼€å‘è®¡åˆ’æ–‡æ¡£

---

## 7. æ‰§è¡Œæ—¶é—´è§„åˆ’

| é˜¶æ®µ | é¢„è®¡è€—æ—¶ | å»ºè®®æ‰§è¡Œæ—¶é—´ |
|-----|---------|-------------|
| å‡†å¤‡é˜¶æ®µ | 30åˆ†é’Ÿ | å·¥ä½œæ—¥ä¸Šåˆ |
| ä»£ç ä¿®æ”¹ | 2-3å°æ—¶ | å·¥ä½œæ—¥ä¸Šåˆ |
| æµ‹è¯•éªŒè¯ | 1-2å°æ—¶ | å·¥ä½œæ—¥ä¸‹åˆ |
| æäº¤ä»£ç  | 30åˆ†é’Ÿ | å·¥ä½œæ—¥ä¸‹åˆ |
| **æ€»è®¡** | **4-6å°æ—¶** | **ä¸€ä¸ªå·¥ä½œæ—¥å†…** |

**å»ºè®®æ‰§è¡Œæ—¶é—´**: å·¥ä½œæ—¥09:00-17:00ï¼Œé¿å…å‘¨äº”ä¸‹åˆå’ŒèŠ‚å‡æ—¥å‰ã€‚

---

## 8. å˜æ›´è®°å½•

| æ—¥æœŸ | é˜¶æ®µ | æ‰§è¡Œäºº | ç»“æœ | å¤‡æ³¨ |
|-----|------|-------|------|------|
| 2025-10-29 | æ–¹æ¡ˆåˆ¶å®š | yukun.xing | âœ… å®Œæˆ | åˆå§‹ç‰ˆæœ¬ |
| | å‡†å¤‡é˜¶æ®µ | | â¬œ å¾…æ‰§è¡Œ | |
| | ä»£ç ä¿®æ”¹ | | â¬œ å¾…æ‰§è¡Œ | |
| | æµ‹è¯•éªŒè¯ | | â¬œ å¾…æ‰§è¡Œ | |
| | æäº¤ä»£ç  | | â¬œ å¾…æ‰§è¡Œ | |

---

## 9. é™„å½•

### 9.1 ç›¸å…³æ–‡æ¡£
- CLAUDE.md: `/Users/yukun-admin/projects/pigeon/CLAUDE.md`
- ç¼–ç ä¹ æƒ¯: `/Users/yukun-admin/projects/pigeon/yuexin_personal_docs/ç¼–ç ä¹ æƒ¯.md`
- ä»£ç æäº¤è§„èŒƒ: `/Users/yukun-admin/projects/pigeon/yuexin_personal_docs/ä»£ç æäº¤è§„èŒƒ.md`

### 9.2 å¸¸ç”¨å‘½ä»¤

```bash
# æ•°æ®åº“è¿æ¥
PGPASSWORD=integration_test_password psql -h localhost -p 5433 -U postgres -d pigeon_web

# æŸ¥çœ‹è¡¨ç»“æ„
\d mgmt.channels

# å¯¼å‡ºæ•°æ®
pg_dump -h localhost -p 5433 -U postgres -d pigeon_web -t mgmt.channels > backup.sql

# æŸ¥çœ‹Gitå·®å¼‚
git diff HEAD

# å‰ç«¯æ„å»º
cd frontend && npm run build

# åç«¯æµ‹è¯•
cd pigeon_web && source ../venv/bin/activate && pytest tests/channels/
```

### 9.3 è”ç³»æ–¹å¼
- å¼€å‘è´Ÿè´£äºº: yukun.xing <xingyukun@gmail.com>
- ç´§æ€¥è”ç³»: [æ ¹æ®å®é™…å¡«å†™]

---

## æ–‡æ¡£ç»“æŸ

**æœ€åæé†’**:
1. âš ï¸ æ‰§è¡Œå‰åŠ¡å¿…å®Œæ•´å¤‡ä»½æ•°æ®åº“
2. âš ï¸ ä¸¥æ ¼æŒ‰ç…§æ­¥éª¤é¡ºåºæ‰§è¡Œ
3. âš ï¸ æ¯ä¸ªæ­¥éª¤å®Œæˆåéƒ½è¦éªŒè¯
4. âš ï¸ é‡åˆ°é—®é¢˜ç«‹å³åœæ­¢ï¼Œä¸è¦å¼ºè¡Œç»§ç»­
5. âš ï¸ ä¿ç•™æ‰€æœ‰å¤‡ä»½æ–‡ä»¶è‡³å°‘30å¤©

ç¥é¡ºåˆ©å®Œæˆï¼ğŸ‰
