# 通道字段删除方案

## 文档信息
- **创建日期**: 2025-10-29
- **维护人**: yukun.xing
- **状态**: 待执行

---

## 1. 删除概述

### 1.1 删除字段清单

本次需要删除以下7个通道配置字段：

| 字段名 | 存储位置 | 数据类型 | 说明 |
|-------|---------|---------|------|
| `source_addr_ton` | `channels.channel_config` (JSONB) | Integer | SMPP协议源地址类型编号 |
| `source_addr_npi` | `channels.channel_config` (JSONB) | Integer | SMPP协议源地址编号计划 |
| `dest_addr_ton` | `channels.channel_config` (JSONB) | Integer | SMPP协议目标地址类型编号 |
| `dest_addr_npi` | `channels.channel_config` (JSONB) | Integer | SMPP协议目标地址编号计划 |
| `gateway_signature` | `channels` 表独立列 | Boolean | 网关签名开关 |
| `remove_signature` | `channels` 表独立列 | Boolean | 拆除签名开关 |
| `uplink_config` | `channels` 表独立列 | Enum | 上行匹配配置 |

### 1.2 影响范围分析

#### 数据库层面
- **表结构变更**: 需要删除 `channels` 表的3个独立列
- **枚举类型**: 需要删除 `mgmt.uplink_config` 枚举类型
- **Mock数据**: 需要更新测试数据
- **风险等级**: 🔴 高 - 需要执行数据库迁移

#### 应用层面
- **前端文件**: 3个文件需要修改
- **后端文件**: 3个文件需要修改
- **API接口**: 2个接口受影响（获取/更新通道参数）
- **风险等级**: 🟡 中 - 可能影响现有API调用

#### 业务层面
- **功能影响**: 通道创建/编辑界面字段减少
- **数据迁移**: 现有通道的这7个字段值将被丢弃
- **向后兼容**: 不兼容 - 前端旧版本将无法正常工作
- **风险等级**: 🟢 低 - 仅影响管理界面，不影响短信发送

---

## 2. 涉及文件清单

### 2.1 数据库文件 (4个)

```
pigeon_web/sql/modules/base.sql                    # 删除 uplink_config 枚举定义
pigeon_web/sql/modules/channels.sql               # 删除3个列定义和注释
pigeon_web/sql/mock_data/channels.sql             # 无需修改（INSERT语句未包含这些字段）
pigeon_web/sql/pigeon_web.sql                     # 如果重新生成，会自动更新
```

### 2.2 后端文件 (3个)

```
app/models/customers/channel.py                    # 删除Model字段定义和UplinkConfig枚举
app/api/v1/channels/schema/channel.py             # 删除Schema字段验证
app/services/channels/channel_service.py          # 删除业务逻辑处理代码
```

### 2.3 前端文件 (3个)

```
frontend/src/api/channelApi.ts                    # 删除接口类型定义
frontend/src/pages/ChannelManagement/components/ChannelFormModal.tsx   # 删除表单字段
frontend/src/pages/ChannelManagement/components/ParamConfigModal.tsx   # 删除参数配置字段
```

---

## 3. 执行步骤

### 3.1 准备阶段

#### ✅ 步骤1: 数据备份
```bash
# 1.1 备份channels表
cd /Users/yukun-admin/projects/pigeon/pigeon_web
pg_dump -h localhost -p 5433 -U postgres -d pigeon_web \
  -t mgmt.channels --data-only \
  > backup/channels_backup_$(date +%Y%m%d_%H%M%S).sql

# 1.2 备份完整数据库schema
pg_dump -h localhost -p 5433 -U postgres -d pigeon_web \
  --schema-only \
  > backup/schema_backup_$(date +%Y%m%d_%H%M%S).sql
```

#### ✅ 步骤2: 检查现有数据
```sql
-- 2.1 检查有多少通道使用了这些字段
SELECT
    COUNT(*) as total_channels,
    COUNT(CASE WHEN gateway_signature = TRUE THEN 1 END) as using_gateway_signature,
    COUNT(CASE WHEN remove_signature = TRUE THEN 1 END) as using_remove_signature,
    COUNT(CASE WHEN uplink_config = 'extend_match' THEN 1 END) as using_extend_match,
    COUNT(CASE WHEN uplink_config = 'deliver_match' THEN 1 END) as using_deliver_match,
    COUNT(CASE WHEN channel_config ? 'source_addr_ton' THEN 1 END) as using_source_addr_ton,
    COUNT(CASE WHEN channel_config ? 'dest_addr_ton' THEN 1 END) as using_dest_addr_ton
FROM mgmt.channels;

-- 2.2 列出使用这些字段的通道详情
SELECT
    channel_id,
    channel_name,
    gateway_signature,
    remove_signature,
    uplink_config,
    channel_config->'source_addr_ton' as source_addr_ton,
    channel_config->'dest_addr_ton' as dest_addr_ton
FROM mgmt.channels
WHERE gateway_signature = TRUE
   OR remove_signature = TRUE
   OR uplink_config = 'extend_match'
   OR channel_config ? 'source_addr_ton';
```

#### ✅ 步骤3: 创建Git分支
```bash
cd /Users/yukun-admin/projects/pigeon/pigeon_web
git checkout main
git pull origin main
git checkout -b refactor/remove-unused-channel-fields
```

---

### 3.2 代码修改阶段

#### 修改顺序说明
按照以下顺序修改，确保每一步都可以编译和测试：

**顺序**: 前端 → 后端 → 数据库

原因：
1. 前端先移除字段，API仍然兼容（后端会忽略前端不发送的字段）
2. 后端移除字段处理，数据库列仍存在（读取时忽略这些列）
3. 最后删除数据库列（最危险的操作）

---

#### 📝 步骤4: 修改前端代码

##### 4.1 修改 `frontend/src/api/channelApi.ts`

**位置1**: 删除接口定义中的字段（约第100行附近）
```typescript
// 删除以下字段
export interface Channel {
  // ... 其他字段 ...
  // 删除这3行 ❌
  // gateway_signature?: boolean;
  // remove_signature?: boolean;
  // uplink_config?: 'extend_match' | 'deliver_match';
}
```

**位置2**: 删除 UpdateChannelParametersRequest 接口中的SMPP字段（约第438行）
```typescript
export interface UpdateChannelParametersRequest {
  gateway_address: string;
  gateway_port: number;
  account: string;
  password: string;
  connection_count: number;
  total_speed: number;
  default_encoding: number;
  // 删除以下4行 ❌
  // source_addr_ton: number;
  // source_addr_npi: number;
  // dest_addr_ton: number;
  // dest_addr_npi: number;
}
```

**位置3**: 删除 ChannelParameterDetail 接口中的SMPP字段（搜索该接口）
```typescript
export interface ChannelParameterDetail {
  // ... 其他字段 ...
  // 删除以下4行 ❌
  // source_addr_ton: number;
  // source_addr_npi: number;
  // dest_addr_ton: number;
  // dest_addr_npi: number;
}
```

##### 4.2 修改 `frontend/src/pages/ChannelManagement/components/ChannelFormModal.tsx`

**位置1**: 删除表单数据接口中的字段（约第34行）
```typescript
interface ChannelFormData {
  // ... 其他字段 ...
  // 删除以下3行 ❌
  // gateway_signature: boolean;
  // remove_signature: boolean;
  // uplink_config: 'extend_match' | 'deliver_match';
}
```

**位置2**: 删除默认值设置（约第139-156行）
```typescript
// 在 useEffect 中删除这些字段的设置
useEffect(() => {
  if (mode === 'edit' && channelData && open) {
    form.setFieldsValue({
      // ... 其他字段 ...
      // 删除这3行 ❌
      // gateway_signature: channelData.gateway_signature || false,
      // remove_signature: channelData.remove_signature || false,
      // uplink_config: channelData.uplink_config || 'deliver_match',
    });
  } else if (mode === 'create' && open) {
    form.setFieldsValue({
      // ... 其他字段 ...
      // 删除这3行 ❌
      // gateway_signature: false,
      // remove_signature: false,
      // uplink_config: 'deliver_match',
    });
  }
}, [mode, channelData, open, form]);
```

**位置3**: 删除表单UI组件（搜索 "网关签名"、"拆除签名"、"上行匹配"）
找到类似以下的 Form.Item 并删除：
```typescript
{/* 删除整个Card或相关的Form.Item */}
<Card title="通道配置" size="small" style={{ marginBottom: 16 }}>
  {/* 删除 gateway_signature 相关的 Form.Item */}
  {/* 删除 remove_signature 相关的 Form.Item */}
  {/* 删除 uplink_config 相关的 Form.Item */}
</Card>
```

##### 4.3 修改 `frontend/src/pages/ChannelManagement/components/ParamConfigModal.tsx`

**位置1**: 删除接口扩展中的字段（约第35行）
```typescript
interface ParameterFormValues extends UpdateChannelParametersRequest {
  protocol: string;
  // UpdateChannelParametersRequest已经不包含SMPP字段了
}
```

**位置2**: 删除默认值（约第41-54行）
```typescript
const DEFAULT_FORM_VALUES: ParameterFormValues = {
  protocol: '',
  gateway_address: '',
  gateway_port: 2775,
  account: '',
  password: '',
  connection_count: 1,
  total_speed: 1,
  default_encoding: 0,
  // 删除以下4行 ❌
  // source_addr_ton: 0,
  // source_addr_npi: 0,
  // dest_addr_ton: 0,
  // dest_addr_npi: 0,
};
```

**位置3**: 删除useEffect中的字段设置（约第78-92行）
```typescript
useEffect(() => {
  if (!open) {
    form.resetFields();
    return;
  }

  if (parameterDetail) {
    form.setFieldsValue({
      // ... 其他字段 ...
      // 删除以下4行 ❌
      // source_addr_ton: parameterDetail.source_addr_ton,
      // source_addr_npi: parameterDetail.source_addr_npi,
      // dest_addr_ton: parameterDetail.dest_addr_ton,
      // dest_addr_npi: parameterDetail.dest_addr_npi,
    });
  }
}, [open, parameterDetail, form]);
```

**位置4**: 删除提交时的字段（约第113-125行）
```typescript
const payload: UpdateChannelParametersRequest = {
  gateway_address: values.gateway_address,
  gateway_port: values.gateway_port,
  account: values.account.trim(),
  password: values.password,
  connection_count: values.connection_count,
  total_speed: values.total_speed,
  default_encoding: values.default_encoding,
  // 删除以下4行 ❌
  // source_addr_ton: values.source_addr_ton,
  // source_addr_npi: values.source_addr_npi,
  // dest_addr_ton: values.dest_addr_ton,
  // dest_addr_npi: values.dest_addr_npi,
};
```

**位置5**: 删除表单UI（约第269-327行，搜索 "协议参数"）
```typescript
{/* 删除整个 "协议参数" 部分的 Row 和 Col */}
<Divider />
<Title level={5}>协议参数</Title>
<Row gutter={16}>
  {/* 删除所有包含 source_addr_ton, source_addr_npi, dest_addr_ton, dest_addr_npi 的 Form.Item */}
</Row>
```

##### 4.4 前端测试验证
```bash
cd /Users/yukun-admin/projects/pigeon/pigeon_web/frontend
npm run build  # 确保没有TypeScript错误
npm run type-check  # 确保类型检查通过
```

---

#### 🔧 步骤5: 修改后端代码

##### 5.1 修改 `app/models/customers/channel.py`

**位置1**: 删除枚举类定义（约第52-56行）
```python
# 删除整个 UplinkConfig 枚举类 ❌
# class UplinkConfig(enum.Enum):
#     """Uplink configuration enumeration."""
#     EXTEND_MATCH = 'extend_match'
#     DELIVER_MATCH = 'deliver_match'
```

**位置2**: 删除Model字段定义（约第81-84行）
```python
class Channel(db.Model):
    # ... 其他字段 ...

    # 删除以下3个字段 ❌
    # gateway_signature = db.Column(db.Boolean, default=False, comment='Gateway signature enabled')
    # remove_signature = db.Column(db.Boolean, default=False, comment='Remove signature enabled')
    # uplink_config = db.Column(db.Enum(UplinkConfig, values_callable=lambda obj: [e.value for e in obj]),
    #                          default=UplinkConfig.DELIVER_MATCH, comment='Uplink configuration type')
```

**位置3**: 删除to_dict方法中的字段（约第314行）
```python
def to_dict(self, include_relationships=False):
    result = {
        # ... 其他字段 ...
        # 删除以下3行 ❌
        # 'gateway_signature': self.gateway_signature,
        # 'remove_signature': self.remove_signature,
        # 'uplink_config': self.uplink_config.value if self.uplink_config else None,
    }
```

**位置4**: 更新 `app/models/customers/__init__.py`（约第26和67行）
```python
# 删除导入和导出
from app.models.customers.channel import (
    Channel,
    ConnectionStatus,
    ChannelStatus,
    ChannelType,
    PaymentType,
    BillingMethod,
    # UplinkConfig  # ❌ 删除这一行
)

__all__ = [
    # ... 其他导出 ...
    'PaymentType',
    'BillingMethod',
    # 'UplinkConfig',  # ❌ 删除这一行
]
```

##### 5.2 修改 `app/api/v1/channels/schema/channel.py`

**位置1**: 删除ChannelSchema中的字段（约第32-38行）
```python
class ChannelSchema(Schema):
    # ... 其他字段 ...

    # 删除以下3个字段 ❌
    # gateway_signature = fields.Bool(load_default=False)
    # remove_signature = fields.Bool(load_default=False)
    # uplink_config = fields.Str(
    #     validate=validate.OneOf(['extend_match', 'deliver_match']),
    #     load_default='deliver_match'
    # )
```

**位置2**: 删除ChannelParameterDetailSchema中的SMPP字段（约第657-660行）
```python
class ChannelParameterDetailSchema(Schema):
    # ... 其他字段 ...
    # 删除以下4行 ❌
    # source_addr_ton = fields.Int(required=True)
    # source_addr_npi = fields.Int(required=True)
    # dest_addr_ton = fields.Int(required=True)
    # dest_addr_npi = fields.Int(required=True)
```

**位置3**: 删除ChannelParameterUpdateSchema中的SMPP字段（约第677-680行）
```python
class ChannelParameterUpdateSchema(Schema):
    # ... 其他字段 ...
    # 删除以下4行 ❌
    # source_addr_ton = fields.Int(required=True, validate=validate.OneOf([0, 1, 2, 3, 4, 5, 6]))
    # source_addr_npi = fields.Int(required=True, validate=validate.OneOf([0, 1, 3, 4, 6, 8, 9, 10, 14, 18]))
    # dest_addr_ton = fields.Int(required=True, validate=validate.OneOf([0, 1, 2, 3, 4, 5, 6]))
    # dest_addr_npi = fields.Int(required=True, validate=validate.OneOf([0, 1, 3, 4, 6, 8, 9, 10, 14, 18]))
```

##### 5.3 修改 `app/services/channels/channel_service.py`

**位置1**: 删除更新参数时的SMPP字段处理（约第706-709行）
```python
def update_channel_parameters(self, channel_id: str, data: dict, admin_id: int = None):
    # ... 其他代码 ...

    # 删除以下4行 ❌
    # config['source_addr_ton'] = params['source_addr_ton']
    # config['source_addr_npi'] = params['source_addr_npi']
    # config['dest_addr_ton'] = params['dest_addr_ton']
    # config['dest_addr_npi'] = params['dest_addr_npi']
```

**位置2**: 删除导出字段定义（约第1164-1165, 1178-1181行）
```python
# 删除导出字段列表中的SMPP字段
default_fields = [
    'protocol', 'path', 'port', 'upstream_account', 'password',
    'max_connection', 'rate_limit',  # 'gmp7_attribute'
    # 删除这4个字段 ❌
    # 'source_addr_ton', 'source_addr_npi',
    # 'dest_addr_ton', 'dest_addr_npi',
]

# 删除中文表头映射
chinese_headers = {
    # ... 其他字段 ...
    # 删除这4行 ❌
    # 'source_addr_ton': 'source_addr_ton',
    # 'source_addr_npi': 'source_addr_npi',
    # 'dest_addr_ton': 'dest_addr_ton',
    # 'dest_addr_npi': 'dest_addr_npi'
}
```

**位置3**: 删除获取参数详情时的字段（约第2486-2489行）
```python
def get_channel_parameters(self, channel_id: str):
    # ... 其他代码 ...
    parameters = {
        # ... 其他字段 ...
        # 删除以下4行 ❌
        # 'source_addr_ton': _to_int(config.get('source_addr_ton')),
        # 'source_addr_npi': _to_int(config.get('source_addr_npi')),
        # 'dest_addr_ton': _to_int(config.get('dest_addr_ton')),
        # 'dest_addr_npi': _to_int(config.get('dest_addr_npi')),
    }
```

**位置4**: 删除参数验证逻辑（约第2584-2589行）
```python
def _validate_parameters(self, data: dict) -> None:
    # ... 其他验证 ...

    # 删除TON字段验证 ❌
    # ton_fields = ['source_addr_ton', 'dest_addr_ton']
    # valid_ton_values = [0, 1, 2, 3, 4, 5, 6]
    # for field in ton_fields:
    #     value = int(data[field])
    #     if value not in valid_ton_values:
    #         raise ValueError(f'{field} 必须为以下值之一: {valid_ton_values}')

    # 类似地删除NPI字段验证
```

**位置5**: 删除导出字段格式化逻辑（约第2616-2618行）
```python
def _format_export_field_value(self, channel, field: str) -> str:
    # 删除SMPP字段的特殊处理 ❌
    # if field in ['source_addr_ton', 'source_addr_npi', 'dest_addr_ton', 'dest_addr_npi']:
    #     config = channel.channel_config or {}
    #     return str(config.get(field, ''))
```

##### 5.4 后端测试验证
```bash
cd /Users/yukun-admin/projects/pigeon/pigeon_web

# 激活虚拟环境
source /Users/yukun-admin/projects/pigeon/venv/bin/activate

# 运行语法检查
python -m py_compile app/models/customers/channel.py
python -m py_compile app/api/v1/channels/schema/channel.py
python -m py_compile app/services/channels/channel_service.py

# 运行相关测试
pytest tests/channels/ -v
```

---

#### 🗄️ 步骤6: 修改数据库结构

⚠️ **警告**: 这是最危险的步骤，一旦执行无法通过代码回滚，只能通过数据库备份恢复。

##### 6.1 创建数据库迁移脚本

创建文件: `pigeon_web/sql/migrations/remove_unused_channel_fields.sql`

```sql
-- Copyright(c) 2025
-- All rights reserved.
--
-- Author: yukun.xing <xingyukun@gmail.com>
-- Date:   2025/10/29
--
-- Migration: Remove unused channel configuration fields
-- 删除不再使用的通道配置字段

BEGIN;

-- Step 1: 删除channels表的3个列
-- 注意：这会永久删除这些列的所有数据
ALTER TABLE mgmt.channels DROP COLUMN IF EXISTS gateway_signature;
ALTER TABLE mgmt.channels DROP COLUMN IF EXISTS remove_signature;
ALTER TABLE mgmt.channels DROP COLUMN IF EXISTS uplink_config;

-- Step 2: 删除uplink_config枚举类型
-- 注意：只有在没有其他地方使用时才能删除
DROP TYPE IF EXISTS mgmt.uplink_config;

-- Step 3: 清理channel_config中的SMPP字段（如果有的话）
-- 这些字段存储在JSONB中，删除它们可以减少存储空间
UPDATE mgmt.channels
SET channel_config = channel_config - 'source_addr_ton' - 'source_addr_npi' - 'dest_addr_ton' - 'dest_addr_npi'
WHERE channel_config ?| ARRAY['source_addr_ton', 'source_addr_npi', 'dest_addr_ton', 'dest_addr_npi'];

COMMIT;

-- 验证：检查字段是否已删除
SELECT
    column_name,
    data_type
FROM information_schema.columns
WHERE table_schema = 'mgmt'
  AND table_name = 'channels'
  AND column_name IN ('gateway_signature', 'remove_signature', 'uplink_config');
-- 应该返回0行

-- 验证：检查枚举类型是否已删除
SELECT typname
FROM pg_type
WHERE typname = 'uplink_config'
  AND typnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'mgmt');
-- 应该返回0行
```

##### 6.2 修改数据库初始化脚本

**文件1**: `pigeon_web/sql/modules/base.sql`

找到 uplink_config 枚举定义（约第131-136行）并删除：
```sql
-- 删除以下部分 ❌
-- -- Uplink configuration enum - FEAT-6-2-1
-- DO $$ BEGIN
--     CREATE TYPE mgmt.uplink_config AS ENUM ('extend_match', 'deliver_match');
-- EXCEPTION
--     WHEN duplicate_object THEN null;
-- END$$;
```

**文件2**: `pigeon_web/sql/modules/channels.sql`

找到 channels 表定义（约第29-32行）并删除这3个字段：
```sql
CREATE TABLE IF NOT EXISTS mgmt.channels (
    -- ... 其他字段 ...

    -- 删除以下3行 ❌
    -- gateway_signature BOOLEAN DEFAULT FALSE,
    -- remove_signature BOOLEAN DEFAULT FALSE,
    -- uplink_config mgmt.uplink_config DEFAULT 'deliver_match',

    -- ... 其他字段 ...
);
```

同时删除相关的注释说明（搜索 "Status configuration - FEAT-6-2-1"）。

##### 6.3 执行数据库迁移

```bash
# 1. 确保数据库服务运行
cd /Users/yukun-admin/projects/pigeon/pigeon_web/tests/e2e/docker
docker-compose ps  # 检查数据库状态

# 2. 连接到数据库
PGPASSWORD=integration_test_password psql -h localhost -p 5433 -U postgres -d pigeon_web

# 3. 在psql中执行迁移
\i /Users/yukun-admin/projects/pigeon/pigeon_web/sql/migrations/remove_unused_channel_fields.sql

# 4. 验证表结构
\d mgmt.channels

# 5. 退出psql
\q
```

##### 6.4 验证数据库变更
```sql
-- 连接数据库后执行以下查询

-- 1. 确认列已删除
SELECT column_name
FROM information_schema.columns
WHERE table_schema = 'mgmt'
  AND table_name = 'channels'
  AND column_name IN ('gateway_signature', 'remove_signature', 'uplink_config');
-- 期望: 0行

-- 2. 确认枚举类型已删除
SELECT typname
FROM pg_type
WHERE typname = 'uplink_config'
  AND typnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'mgmt');
-- 期望: 0行

-- 3. 检查channel_config中的SMPP字段是否清理
SELECT
    channel_id,
    channel_name,
    channel_config ? 'source_addr_ton' as has_source_ton,
    channel_config ? 'dest_addr_ton' as has_dest_ton
FROM mgmt.channels
WHERE channel_config ?| ARRAY['source_addr_ton', 'source_addr_npi', 'dest_addr_ton', 'dest_addr_npi'];
-- 期望: 0行

-- 4. 随机抽查几条通道数据完整性
SELECT
    channel_id,
    channel_name,
    status,
    is_enabled,
    payment_type,
    billing_method
FROM mgmt.channels
LIMIT 5;
-- 期望: 数据正常，没有NULL值异常
```

---

### 3.3 测试验证阶段

#### ✅ 步骤7: 集成测试

##### 7.1 启动服务
```bash
# 1. 启动数据库和中间件
cd /Users/yukun-admin/projects/pigeon/pigeon_web/tests/e2e/docker
docker-compose up -d

# 2. 启动后端服务
cd /Users/yukun-admin/projects/pigeon/pigeon_web
source /Users/yukun-admin/projects/pigeon/venv/bin/activate
python run.py

# 3. 启动前端服务（新终端）
cd /Users/yukun-admin/projects/pigeon/pigeon_web/frontend
npm run dev
```

##### 7.2 功能测试清单

| 测试项 | 测试内容 | 预期结果 | 实际结果 | 状态 |
|-------|---------|---------|---------|------|
| 通道列表 | 访问通道管理页面 | 正常显示通道列表 | | ⬜ |
| 通道详情 | 查看任意通道详情 | 详情页面不显示已删除字段 | | ⬜ |
| 创建通道 | 创建新通道 | 表单不包含已删除字段，创建成功 | | ⬜ |
| 编辑通道 | 编辑现有通道 | 表单不包含已删除字段，保存成功 | | ⬜ |
| 参数配置 | 打开参数配置对话框 | 不显示SMPP 4个字段 | | ⬜ |
| 参数修改 | 修改通道参数 | 修改成功，不包含已删除字段 | | ⬜ |
| API兼容 | 调用旧API（如果有） | 返回数据不包含已删除字段 | | ⬜ |
| 数据完整性 | 检查现有通道数据 | 其他字段数据完整，无异常 | | ⬜ |

##### 7.3 API测试

使用 curl 或 Postman 测试以下API：

```bash
# 1. 获取通道列表
curl -X GET "http://localhost:5173/api/v1/channels?page=1&page_size=10" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. 获取单个通道详情
curl -X GET "http://localhost:5173/api/v1/channels/25090501" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. 获取通道参数
curl -X GET "http://localhost:5173/api/v1/channels/25090501/parameters" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 4. 更新通道参数（不包含已删除字段）
curl -X PUT "http://localhost:5173/api/v1/channels/25090501/parameters" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "gateway_address": "127.0.0.1",
    "gateway_port": 2775,
    "account": "test_account",
    "password": "test_pass",
    "connection_count": 5,
    "total_speed": 100,
    "default_encoding": 0
  }'

# 期望: 所有API正常返回，不包含已删除的7个字段
```

##### 7.4 前端界面测试

打开浏览器访问: http://localhost:5173/business/channel-management

**测试步骤**:
1. ✅ 页面正常加载，没有console错误
2. ✅ 点击"新建通道"按钮
3. ✅ 确认表单中**不包含**以下字段：
   - 网关签名
   - 拆除签名
   - 上行匹配
4. ✅ 填写其他必填字段，保存成功
5. ✅ 选择任意通道，点击"参数配置"
6. ✅ 确认对话框中**不包含**以下字段：
   - source_addr_ton
   - source_addr_npi
   - dest_addr_ton
   - dest_addr_npi
7. ✅ 修改任意参数，保存成功

##### 7.5 数据库数据验证
```sql
-- 随机选择一个通道，验证数据完整性
SELECT
    channel_id,
    channel_name,
    status,
    payment_type,
    billing_method,
    sms_billing_count,
    long_sms_billing_count,
    is_enabled,
    channel_config
FROM mgmt.channels
WHERE channel_id = '25090501';

-- 期望:
-- 1. 所有保留字段都有正确的值
-- 2. channel_config 中不包含 source_addr_ton 等4个SMPP字段
```

---

### 3.4 提交代码阶段

#### ✅ 步骤8: 提交Git

```bash
cd /Users/yukun-admin/projects/pigeon/pigeon_web

# 1. 查看修改的文件
git status

# 2. 添加所有修改
git add -A

# 3. 提交代码（遵循提交规范）
git commit -m "refactor(channels): remove unused channel configuration fields

Remove 7 unused channel configuration fields:
- gateway_signature (database column)
- remove_signature (database column)
- uplink_config (database column + enum type)
- source_addr_ton (JSONB field)
- source_addr_npi (JSONB field)
- dest_addr_ton (JSONB field)
- dest_addr_npi (JSONB field)

Changes:
- Frontend: Remove fields from ChannelFormModal and ParamConfigModal
- Backend: Remove Model fields, Schema validations, and Service logic
- Database: Drop columns, enum type, and clean JSONB data

Breaking Change: This is a breaking change for frontend clients.
Migration script: sql/migrations/remove_unused_channel_fields.sql"

# 4. 推送到远程仓库
git push origin refactor/remove-unused-channel-fields
```

#### ✅ 步骤9: 代码审查

如果需要PR审查（根据CLAUDE.md规则，pigeon_web在main分支直接修改，这里仅供参考）：

**审查要点**:
- [ ] 所有7个字段都已删除
- [ ] 没有遗漏的引用
- [ ] 数据库迁移脚本正确
- [ ] 测试全部通过
- [ ] API文档已更新（如果有）

---

## 4. 回滚方案

### 4.1 紧急回滚（代码回滚）

如果发现问题需要紧急回滚：

```bash
cd /Users/yukun-admin/projects/pigeon/pigeon_web

# 1. 回滚Git提交
git revert HEAD  # 或 git reset --hard HEAD~1

# 2. 重新部署前端
cd frontend
npm run build

# 3. 重启后端
# 根据实际情况重启服务
```

⚠️ **注意**: Git回滚只能恢复代码，**无法恢复已删除的数据库数据**！

### 4.2 数据库回滚（使用备份）

如果需要恢复数据库结构和数据：

```bash
# 1. 停止应用服务

# 2. 恢复数据库备份（使用步骤1创建的备份）
PGPASSWORD=integration_test_password psql -h localhost -p 5433 -U postgres -d pigeon_web \
  < backup/schema_backup_YYYYMMDD_HHMMSS.sql

# 3. 恢复数据
PGPASSWORD=integration_test_password psql -h localhost -p 5433 -U postgres -d pigeon_web \
  < backup/channels_backup_YYYYMMDD_HHMMSS.sql

# 4. 验证恢复
PGPASSWORD=integration_test_password psql -h localhost -p 5433 -U postgres -d pigeon_web \
  -c "\d mgmt.channels"

# 5. 重启应用服务
```

### 4.3 手动恢复（如果没有完整备份）

创建文件: `pigeon_web/sql/migrations/restore_removed_fields.sql`

```sql
-- 恢复删除的字段
BEGIN;

-- 恢复枚举类型
CREATE TYPE mgmt.uplink_config AS ENUM ('extend_match', 'deliver_match');

-- 恢复列
ALTER TABLE mgmt.channels
  ADD COLUMN gateway_signature BOOLEAN DEFAULT FALSE,
  ADD COLUMN remove_signature BOOLEAN DEFAULT FALSE,
  ADD COLUMN uplink_config mgmt.uplink_config DEFAULT 'deliver_match';

-- 为现有记录设置默认值
UPDATE mgmt.channels
SET
  gateway_signature = FALSE,
  remove_signature = FALSE,
  uplink_config = 'deliver_match'
WHERE gateway_signature IS NULL
   OR remove_signature IS NULL
   OR uplink_config IS NULL;

COMMIT;
```

⚠️ **重要提示**: 这只能恢复字段结构，**无法恢复被删除的数据值**！

---

## 5. 风险评估与应对

### 5.1 风险矩阵

| 风险项 | 可能性 | 影响程度 | 风险等级 | 应对措施 |
|-------|--------|---------|---------|---------|
| 数据永久丢失 | 低 | 高 | 🟡 中 | 执行前完整备份 |
| API不兼容 | 中 | 中 | 🟡 中 | 版本号升级，文档更新 |
| 前端页面报错 | 低 | 低 | 🟢 低 | TypeScript编译检查 |
| 现有通道无法使用 | 极低 | 高 | 🟢 低 | 充分测试，灰度发布 |
| 数据库迁移失败 | 低 | 高 | 🟡 中 | 事务保护，准备回滚 |

### 5.2 应急预案

#### 预案1: 数据库迁移失败
- **触发条件**: 执行迁移脚本时出错
- **处理步骤**:
  1. 立即执行 ROLLBACK（如果还在事务中）
  2. 检查错误日志
  3. 使用备份恢复数据库
  4. 重新评估迁移脚本

#### 预案2: 前端页面异常
- **触发条件**: 页面无法加载或功能异常
- **处理步骤**:
  1. 检查浏览器Console错误
  2. 检查API返回的数据结构
  3. 临时回滚前端代码
  4. 修复问题后重新部署

#### 预案3: 后端API异常
- **触发条件**: API返回500错误
- **处理步骤**:
  1. 检查后端日志
  2. 确认数据库连接正常
  3. 检查Model和Schema定义
  4. 临时回滚后端代码

---

## 6. 上线检查清单

### 6.1 代码检查

- [ ] 前端TypeScript编译通过
- [ ] 前端类型检查通过 (npm run type-check)
- [ ] 后端Python语法检查通过
- [ ] 所有单元测试通过
- [ ] 代码已提交到Git
- [ ] Git提交信息符合规范

### 6.2 数据库检查

- [ ] 数据库备份已创建
- [ ] 迁移脚本已测试
- [ ] 迁移脚本使用事务保护
- [ ] 已确认枚举类型没有其他依赖
- [ ] 验证SQL已准备

### 6.3 功能检查

- [ ] 通道列表正常显示
- [ ] 通道创建功能正常
- [ ] 通道编辑功能正常
- [ ] 参数配置功能正常
- [ ] API响应数据正确
- [ ] 没有console错误
- [ ] 现有通道数据完整

### 6.4 文档检查

- [ ] 更新API文档（如果有）
- [ ] 更新数据库文档（如果有）
- [ ] 记录变更日志
- [ ] 更新相关的开发计划文档

---

## 7. 执行时间规划

| 阶段 | 预计耗时 | 建议执行时间 |
|-----|---------|-------------|
| 准备阶段 | 30分钟 | 工作日上午 |
| 代码修改 | 2-3小时 | 工作日上午 |
| 测试验证 | 1-2小时 | 工作日下午 |
| 提交代码 | 30分钟 | 工作日下午 |
| **总计** | **4-6小时** | **一个工作日内** |

**建议执行时间**: 工作日09:00-17:00，避免周五下午和节假日前。

---

## 8. 变更记录

| 日期 | 阶段 | 执行人 | 结果 | 备注 |
|-----|------|-------|------|------|
| 2025-10-29 | 方案制定 | yukun.xing | ✅ 完成 | 初始版本 |
| | 准备阶段 | | ⬜ 待执行 | |
| | 代码修改 | | ⬜ 待执行 | |
| | 测试验证 | | ⬜ 待执行 | |
| | 提交代码 | | ⬜ 待执行 | |

---

## 9. 附录

### 9.1 相关文档
- CLAUDE.md: `/Users/yukun-admin/projects/pigeon/CLAUDE.md`
- 编码习惯: `/Users/yukun-admin/projects/pigeon/yuexin_personal_docs/编码习惯.md`
- 代码提交规范: `/Users/yukun-admin/projects/pigeon/yuexin_personal_docs/代码提交规范.md`

### 9.2 常用命令

```bash
# 数据库连接
PGPASSWORD=integration_test_password psql -h localhost -p 5433 -U postgres -d pigeon_web

# 查看表结构
\d mgmt.channels

# 导出数据
pg_dump -h localhost -p 5433 -U postgres -d pigeon_web -t mgmt.channels > backup.sql

# 查看Git差异
git diff HEAD

# 前端构建
cd frontend && npm run build

# 后端测试
cd pigeon_web && source ../venv/bin/activate && pytest tests/channels/
```

### 9.3 联系方式
- 开发负责人: yukun.xing <xingyukun@gmail.com>
- 紧急联系: [根据实际填写]

---

## 文档结束

**最后提醒**:
1. ⚠️ 执行前务必完整备份数据库
2. ⚠️ 严格按照步骤顺序执行
3. ⚠️ 每个步骤完成后都要验证
4. ⚠️ 遇到问题立即停止，不要强行继续
5. ⚠️ 保留所有备份文件至少30天

祝顺利完成！🎉
